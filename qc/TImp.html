<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<link href="common/css/sf.css" rel="stylesheet" type="text/css"/>
<title>TImp: Case Study: a Typed Imperative Language</title>
</head>
<link href="common/jquery-ui/jquery-ui.css" rel="stylesheet">
<script src="common/jquery-ui/external/jquery/jquery.js"></script>
<script src="common/jquery-ui/jquery-ui.js"></script>
<script src="common/toggleproofs.js"></script>
<link href="common/css/qc.css" rel="stylesheet" type="text/css"/>

<body>

<div id="page">

<div id="header">
<a href='https://www.cis.upenn.edu/~bcpierce/sf/current/index.html'>
<img src='common/media/image/sf_logo_sm.png'></a>
</br><a href='index.html'>  <span class='booktitleinheader'>Volume 4: QuickChick: Property-Based Testing in Coq</span><br></br>
<ul id='menu'>
   <a href='toc.html'><li class='section_name'>Table of Contents</li></a>
   <a href='coqindex.html'><li class='section_name'>Index</li></a>
   <a href='deps.html'><li class='section_name'>Roadmap</li></a>
</ul>
</a></div>

<div id="main">

<h1 class="libtitle">TImp<span class="subtitle">Case Study: a Typed Imperative Language</span></h1>



<div class="doc">
Having seen a basic overview of QuickChick in the previous
    chapter, we can now dive into a more realistic case study: a typed
    variant of Imp, the simple imperative language introduced in
    <i>Logical Foundations</i>.  The original Imp variant presented in the
    first volume of Software Foundations enforces a syntactic
    separation between boolean and arithmetic expressions: <span class="inlinecode"><span class="id" type="var">bexp</span></span> just
    ranges over boolean expressions, while <span class="inlinecode"><span class="id" type="var">aexp</span></span> ranges over
    arithmetic ones.  Moreover, variables are only allowed in <span class="inlinecode"><span class="id" type="var">aexp</span></span>
    and hence only take numeric values.

<div class="paragraph"> </div>

    In <i>Typed Imp</i> (TImp) we collapse the expression syntax and allow
    variables to range over both numbers and booleans. With the
    unified syntax, we introduce the notion of <i>well-typed</i> Imp
    expressions and programs (where every variable only ranges over
    values of a single type throughout the whole program).  We then
    give an operational semantics to TImp in the form of a (partial)
    evaluation function &mdash; partial since, in the unified syntax, we
    can write nonsensical expressions such as <span class="inlinecode">0</span> <span class="inlinecode">+</span> <span class="inlinecode"><span class="id" type="var">True</span></span>.

<div class="paragraph"> </div>

    A common mantra in functional programming is "well-typed programs
    cannot go wrong," and TImp is no exception. The <i>soundness</i>
    property for TImp will state that evaluating well-typed
    expressions and programs always succeeds.

<div class="paragraph"> </div>

    From the point of view of testing, soundness is interesting
    because it is a <i>conditional</i> property. As we saw in the previous
    chapter, testing such properties effectively requires custom
    generators.  In this chapter, we show how to scale the techniques
    for writing generators explained in <a href="QC.html"><span class="inlineref">QC</span></a> to more realistic
    generators for well-typed expressions and programs. In addition,
    we dicuss the need for custom shrinkers preserving invariants, a
    problem dual to that of custom generators. 
<div class="paragraph"> </div>

<a name="lab72"></a><h1 class="section">Atoms, Types and Contexts</h1>

<div class="paragraph"> </div>

<a name="lab73"></a><h2 class="section">Atoms</h2>

<div class="paragraph"> </div>

 For the type of identifiers of TImp we are going to borrow (a
    cut-down version of) the <span class="inlinecode"><span class="id" type="var">Atom</span></span> type from Penn's Metatheory
    library. <span class="inlinecode"><span class="id" type="var">Atom</span></span> is essentially a wrapper around <span class="inlinecode"><span class="id" type="var">nat</span></span> that
    supports decidable equality plus an operator <span class="inlinecode"><span class="id" type="tactic">fresh</span></span>: given any
    finite set of atoms, one can produce one that is distinct from all
    of the atoms in the set. 
<div class="paragraph"> </div>

 The signature (<span class="inlinecode"><span class="id" type="keyword">Module</span></span> <span class="inlinecode"><span class="id" type="keyword">Type</span></span>) of atoms extends the signature
    <span class="inlinecode"><span class="id" type="var">UsualDecidableType</span></span>.  The force of this is that the standard Coq
    equality <span class="inlinecode">(=)</span> is decidable for atoms. 
</div>
<div class="code code-tight">

<span class="id" type="keyword">Module</span> <span class="id" type="keyword">Type</span> <a name="ATOM"><span class="id" type="module">ATOM</span></a> &lt;: <a class="idref" href="http://coq.inria.fr/library/Coq.Structures.Equalities.html#UsualDecidableType"><span class="id" type="module">UsualDecidableType</span></a>.<br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;<span class="id" type="keyword">Parameter</span> <a name="ATOM.t"><span class="id" type="axiom">t</span></a> : <span class="id" type="keyword">Set</span>.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Parameter</span> <a name="ATOM.eq_dec"><span class="id" type="axiom">eq_dec</span></a> : <span style='font-size:120%;'>&forall;</span> (<span class="id" type="var">x</span> <span class="id" type="var">y</span>:<a class="idref" href="TImp.html#ATOM.t"><span class="id" type="axiom">t</span></a>), {<a class="idref" href="TImp.html#x"><span class="id" type="variable">x</span></a> = <a class="idref" href="TImp.html#y"><span class="id" type="variable">y</span></a>} + {<a class="idref" href="TImp.html#x"><span class="id" type="variable">x</span></a> ≠ <a class="idref" href="TImp.html#y"><span class="id" type="variable">y</span></a>}.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Parameter</span> <a name="ATOM.fresh"><span class="id" type="axiom">fresh</span></a> : <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#list"><span class="id" type="inductive">list</span></a> <a class="idref" href="TImp.html#ATOM.t"><span class="id" type="axiom">t</span></a> → <a class="idref" href="TImp.html#ATOM.t"><span class="id" type="axiom">t</span></a>.<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Parameter</span> <a name="ATOM.nat_of"><span class="id" type="axiom">nat_of</span></a>: <a class="idref" href="TImp.html#ATOM.t"><span class="id" type="axiom">t</span></a> → <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nat"><span class="id" type="inductive">nat</span></a>.<br/><hr class='doublespaceincode'/>
<span class="id" type="keyword">End</span> <a class="idref" href="TImp.html#ATOM"><span class="id" type="module">ATOM</span></a>.<br/><hr class='doublespaceincode'/>
<span class="id" type="keyword">Module</span> <a name="Atom"><span class="id" type="module">Atom</span></a> : <a class="idref" href="TImp.html#ATOM"><span class="id" type="module">ATOM</span></a>.<br/>
</div>

<div class="doc">
Internally, an <span class="inlinecode"><span class="id" type="var">Atom</span></span> is just a natural number... 
</div>
<div class="code code-tight">

&nbsp;&nbsp;<span class="id" type="keyword">Definition</span> <a name="Atom.t"><span class="id" type="definition">t</span></a> := <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nat"><span class="id" type="inductive">nat</span></a>.<br/>
</div>

<div class="doc">
...which means decidable equality comes for free from the standard
    library: 
</div>
<div class="code code-tight">

&nbsp;&nbsp;<span class="id" type="keyword">Definition</span> <a name="Atom.eq_dec"><span class="id" type="definition">eq_dec</span></a> := <a class="idref" href="http://coq.inria.fr/library/Coq.Arith.Peano_dec.html#eq_nat_dec"><span class="id" type="abbreviation">eq_nat_dec</span></a>.<br/>
</div>

<div class="doc">
To compute a fresh natural number given a list of natural numbers,
    we can just produce the number that is 1 larger than the maximum
    element: 
</div>
<div class="code code-tight">

&nbsp;&nbsp;<span class="id" type="keyword">Fixpoint</span> <a name="Atom.max_elt"><span class="id" type="definition">max_elt</span></a> (<span class="id" type="var">al</span>:<a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#list"><span class="id" type="inductive">list</span></a> <a class="idref" href="TImp.html#Atom.t"><span class="id" type="definition">t</span></a>) : <a class="idref" href="TImp.html#Atom.t"><span class="id" type="definition">t</span></a> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <a class="idref" href="TImp.html#al"><span class="id" type="variable">al</span></a> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nil"><span class="id" type="constructor">nil</span></a> ⇒ 0<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">n'</span>::<span class="id" type="var">al'</span> ⇒ <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Peano.html#max"><span class="id" type="abbreviation">max</span></a> <span class="id" type="var">n'</span> (<a class="idref" href="TImp.html#max_elt"><span class="id" type="definition">max_elt</span></a> <span class="id" type="var">al'</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;<span class="id" type="keyword">Definition</span> <a name="Atom.fresh"><span class="id" type="definition">fresh</span></a> (<span class="id" type="var">al</span>:<a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#list"><span class="id" type="inductive">list</span></a> <a class="idref" href="TImp.html#Atom.t"><span class="id" type="definition">t</span></a>) : <a class="idref" href="TImp.html#Atom.t"><span class="id" type="definition">t</span></a> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#S"><span class="id" type="constructor">S</span></a> (<a class="idref" href="TImp.html#Atom.max_elt"><span class="id" type="definition">max_elt</span></a> <a class="idref" href="TImp.html#al"><span class="id" type="variable">al</span></a>).<br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;<span class="id" type="keyword">Include</span> <a class="idref" href="http://coq.inria.fr/library/Coq.Structures.Equalities.html#HasUsualEq"><span class="id" type="module">HasUsualEq</span></a> &lt;+ <a class="idref" href="http://coq.inria.fr/library/Coq.Structures.Equalities.html#UsualIsEq"><span class="id" type="module">UsualIsEq</span></a>.<br/>
</div>

<div class="doc">
We also need a way of printing atoms. To support that, we include a 
    <span class="inlinecode"><span class="id" type="var">nat_of</span></span> function that exposes the internal natural number. 
</div>
<div class="code code-tight">

&nbsp;&nbsp;<span class="id" type="keyword">Definition</span> <a name="Atom.nat_of"><span class="id" type="definition">nat_of</span></a> (<span class="id" type="var">a</span> : <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nat"><span class="id" type="inductive">nat</span></a>) := <a class="idref" href="TImp.html#a"><span class="id" type="variable">a</span></a>.<br/><hr class='doublespaceincode'/>
<span class="id" type="keyword">End</span> <a class="idref" href="TImp.html#Atom"><span class="id" type="module">Atom</span></a>.<br/>
</div>

<div class="doc">
We can take advantage of the <span class="inlinecode"><span class="id" type="var">nat_of</span></span> function of <span class="inlinecode"><span class="id" type="var">Atom</span></span>s, as well
    as the <span class="inlinecode"><span class="id" type="keyword">Show</span></span> instance of <span class="inlinecode"><span class="id" type="var">nat</span></span> to print <span class="inlinecode"><span class="id" type="var">Atom</span></span>s. 
</div>
<div class="code code-tight">

<span class="id" type="keyword">Instance</span> <a name="show_atom"><span class="id" type="instance">show_atom</span></a> : <span class="id" type="keyword">Show</span> <a class="idref" href="TImp.html#t"><span class="id" type="axiom">Atom.t</span></a> :=<br/>
&nbsp;&nbsp;{| <span class="id" type="constructor">show</span> <span class="id" type="var">x</span> := <span class="id" type="method">show</span> (<a class="idref" href="TImp.html#nat_of"><span class="id" type="axiom">Atom.nat_of</span></a> <a class="idref" href="TImp.html#x"><span class="id" type="variable">x</span></a>) |}.<br/>
</div>

<div class="doc">
To generate identifiers for TImp, we will use a recursive function
    that generates <span class="inlinecode"><span class="id" type="var">n</span></span> fresh <span class="inlinecode"><span class="id" type="var">Atom</span></span>s starting from the empty list. 
</div>
<div class="code code-tight">

<span class="id" type="keyword">Fixpoint</span> <a name="get_fresh_atoms"><span class="id" type="definition">get_fresh_atoms</span></a> <span class="id" type="var">n</span> <span class="id" type="var">l</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <a class="idref" href="TImp.html#n"><span class="id" type="variable">n</span></a> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;| 0 ⇒ <a class="idref" href="TImp.html#l"><span class="id" type="variable">l</span></a><br/>
&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#S"><span class="id" type="constructor">S</span></a> <span class="id" type="var">n'</span> ⇒ <a class="idref" href="TImp.html#get_fresh_atoms"><span class="id" type="definition">get_fresh_atoms</span></a> <span class="id" type="var">n'</span> ((<a class="idref" href="TImp.html#fresh"><span class="id" type="axiom">Atom.fresh</span></a> <a class="idref" href="TImp.html#l"><span class="id" type="variable">l</span></a>) :: <a class="idref" href="TImp.html#l"><span class="id" type="variable">l</span></a>)<br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>
</div>

<div class="doc">
<a name="lab74"></a><h4 class="section">Exercise: 2 stars (genAtom)</h4>
 Write a <span class="inlinecode"><span class="id" type="var">Gen</span></span> instance for <span class="inlinecode"><span class="id" type="var">Atom.t</span></span>, using the <span class="inlinecode"><span class="id" type="var">elements</span></span>
    combinator and <span class="inlinecode"><span class="id" type="var">get_fresh_atoms</span></span>.  
</div>
<div class="code code-tight">

<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span><br/>
</div>

<span class="proofbox">&#9744;</span> 
<div class="doc less-space">
<div class="paragraph"> </div>

<a name="lab75"></a><h2 class="section">Types</h2>

<div class="paragraph"> </div>

 Here is the type of TImp types: 
</div>
<div class="code code-tight">

<span class="id" type="keyword">Inductive</span> <a name="ty"><span class="id" type="inductive">ty</span></a> := <a name="TBool"><span class="id" type="constructor">TBool</span></a> | <a name="TNat"><span class="id" type="constructor">TNat</span></a>.<br/>
</div>

<div class="doc">
That is, TImp has two kinds of values: booleans and natural
    numbers. 
<div class="paragraph"> </div>

 To use <span class="inlinecode"><span class="id" type="var">ty</span></span> in testing, we will need <span class="inlinecode"><span class="id" type="var">Arbitrary</span></span>, <span class="inlinecode"><span class="id" type="keyword">Show</span></span> and an
    equality <span class="inlinecode"><span class="id" type="var">Dec</span></span> instance. 
<div class="paragraph"> </div>

 In QC.v, we saw how one can go about writing such generators
    by hand.  However, that process can largely be automated,
    especially for simple inductive types (like <span class="inlinecode"><span class="id" type="var">ty</span></span>, <span class="inlinecode"><span class="id" type="var">nat</span></span>, <span class="inlinecode"><span class="id" type="var">list</span></span>,
    <span class="inlinecode"><span class="id" type="var">tree</span></span>, etc.).  QuickChick provides a top-level vernacular command
    to derive such instances. 
</div>
<div class="code code-tight">

<span class="id" type="var">Derive</span> (<span class="id" type="var">Arbitrary</span>, <span class="id" type="keyword">Show</span>) <span class="id" type="keyword">for</span> <span class="id" type="var">ty</span>.<br/>
<span class="comment">(*&nbsp;==&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;GenSizedty&nbsp;is&nbsp;defined<br/>
&nbsp;&nbsp;&nbsp;&nbsp;Shrinkty&nbsp;is&nbsp;defined<br/>
&nbsp;&nbsp;&nbsp;&nbsp;Showty&nbsp;is&nbsp;defined<br/>
*)</span><br/><hr class='doublespaceincode'/>
<span class="id" type="keyword">Check</span> <a class="idref" href="TImp.html#GenSizedty"><span class="id" type="instance">GenSizedty</span></a>.<br/>
<span class="comment">(*&nbsp;==&gt;&nbsp;GenSizedty&nbsp;:&nbsp;GenSized&nbsp;ty&nbsp;*)</span><br/>
<span class="id" type="keyword">Check</span> <a class="idref" href="TImp.html#Shrinkty"><span class="id" type="instance">Shrinkty</span></a>.<br/>
<span class="comment">(*&nbsp;==&gt;&nbsp;Shrinkty&nbsp;&nbsp;:&nbsp;Shrink&nbsp;ty&nbsp;&nbsp;&nbsp;*)</span><br/>
<span class="id" type="keyword">Check</span> <a class="idref" href="TImp.html#Showty"><span class="id" type="instance">Showty</span></a>.<br/>
<span class="comment">(*&nbsp;==&gt;&nbsp;Showty&nbsp;:&nbsp;Show&nbsp;ty&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br/>
</div>

<div class="doc">
Decidable equality instances are not yet derived fully
    automatically by QuickChick.  However, the boilerplate we have to
    write is largely straightforward. As we saw in the previous
    chapters, <span class="inlinecode"><span class="id" type="var">Dec</span></span> is a typeclass wrapper around ssreflect's
    <span class="inlinecode"><span class="id" type="var">decidable</span></span> and we can use the <span class="inlinecode"><span class="id" type="var">dec_eq</span></span> tactic to automate 
    the process. 
</div>
<div class="code code-tight">

<span class="id" type="keyword">Instance</span> <a name="eq_dec_ty"><span class="id" type="instance">eq_dec_ty</span></a> (<span class="id" type="var">x</span> <span class="id" type="var">y</span> : <a class="idref" href="TImp.html#ty"><span class="id" type="inductive">ty</span></a>) : <span class="id" type="class">Dec</span> (<a class="idref" href="TImp.html#x"><span class="id" type="variable">x</span></a> = <a class="idref" href="TImp.html#y"><span class="id" type="variable">y</span></a>).<br/>
<span class="id" type="keyword">Proof</span>. <span class="id" type="var">dec_eq</span>. <span class="id" type="keyword">Defined</span>.<br/>
</div>

<div class="doc">
<a name="lab76"></a><h2 class="section">List Map with Decidable Equality</h2>

<div class="paragraph"> </div>

 To encode typing environments (and, later on, states), we will
    need maps from atoms to values. However, the function-based
    representation in the <i>Software Foundations</i> version of Imp is not
    well suited for testing: we will need to be able to access the
    domain of the map, fold over it and test for equality; these are
    all awkward to define for (Coq) functions. Therefore, we introduce
    a simple list-based map representation that takes usual decidable
    types (like <span class="inlinecode"><span class="id" type="var">Atom</span></span>) as input.

<div class="paragraph"> </div>

    The operations we need are:

<div class="paragraph"> </div>

<ul class="doclist">
<li> <span class="inlinecode"><span class="id" type="var">empty</span></span> : To create the empty map.

</li>
<li> <span class="inlinecode"><span class="id" type="var">get</span></span> : To look up the binding of an element, if any.

</li>
<li> <span class="inlinecode"><span class="id" type="tactic">set</span></span> : To update the binding of an element.

</li>
<li> <span class="inlinecode"><span class="id" type="var">dom</span></span> : To get the list of keys in the map. 
</li>
</ul>

</div>
<div class="code code-tight">

<span class="id" type="keyword">Module</span> <span class="id" type="keyword">Type</span> <a name="Map"><span class="id" type="module">Map</span></a> (<span class="id" type="var">K</span>:<a class="idref" href="http://coq.inria.fr/library/Coq.Structures.Equalities.html#UsualDecidableType"><span class="id" type="module">UsualDecidableType</span></a>).<br/><hr class='doublespaceincode'/>
&nbsp;<span class="id" type="keyword">Section</span> <a name="Map.withv"><span class="id" type="section">withv</span></a>.<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">Variable</span> <a name="Map.withv.V"><span class="id" type="variable">V</span></a> : <span class="id" type="keyword">Type</span>.<br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">Parameter</span> <a name="Map.t"><span class="id" type="axiom">t</span></a> : <span class="id" type="keyword">Type</span> → <span class="id" type="keyword">Type</span>.<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">Parameter</span> <a name="Map.empty"><span class="id" type="axiom">empty</span></a> : <a class="idref" href="TImp.html#Map.t"><span class="id" type="axiom">t</span></a> <a class="idref" href="TImp.html#Map.withv.V"><span class="id" type="variable">V</span></a>.<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">Parameter</span> <a name="Map.get"><span class="id" type="axiom">get</span></a> : <a class="idref" href="TImp.html#Map.t"><span class="id" type="axiom">t</span></a> <a class="idref" href="TImp.html#Map.withv.V"><span class="id" type="variable">V</span></a> → <a class="idref" href="TImp.html#K.t"><span class="id" type="axiom">K.t</span></a> → <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#option"><span class="id" type="inductive">option</span></a> <a class="idref" href="TImp.html#Map.withv.V"><span class="id" type="variable">V</span></a>.<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">Parameter</span> <a name="Map.set"><span class="id" type="axiom">set</span></a> : <a class="idref" href="TImp.html#Map.t"><span class="id" type="axiom">t</span></a> <a class="idref" href="TImp.html#Map.withv.V"><span class="id" type="variable">V</span></a> → <a class="idref" href="TImp.html#K.t"><span class="id" type="axiom">K.t</span></a> → <a class="idref" href="TImp.html#Map.withv.V"><span class="id" type="variable">V</span></a> → <a class="idref" href="TImp.html#Map.t"><span class="id" type="axiom">t</span></a> <a class="idref" href="TImp.html#Map.withv.V"><span class="id" type="variable">V</span></a>.<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">Parameter</span> <a name="Map.dom"><span class="id" type="axiom">dom</span></a> : <a class="idref" href="TImp.html#Map.t"><span class="id" type="axiom">t</span></a> <a class="idref" href="TImp.html#Map.withv.V"><span class="id" type="variable">V</span></a> → <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#list"><span class="id" type="inductive">list</span></a> <a class="idref" href="TImp.html#K.t"><span class="id" type="axiom">K.t</span></a>.<br/>
&nbsp;<span class="id" type="keyword">End</span> <a class="idref" href="TImp.html#Map.withv"><span class="id" type="section">withv</span></a>.<br/><hr class='doublespaceincode'/>
<span class="id" type="keyword">End</span> <a class="idref" href="TImp.html#Map"><span class="id" type="module">Map</span></a>.<br/>
</div>

<div class="doc">
The implementation of the map is a simple association list.  If a
    list contains multiple tuples with the same key, then the binding
    of the key in the map is the one that appears first in the list;
    that is, later bindings can be shadowed. 
</div>
<div class="code code-tight">

<span class="id" type="keyword">Module</span> <a name="ListMap"><span class="id" type="module">ListMap</span></a> (<span class="id" type="var">K</span>:<a class="idref" href="http://coq.inria.fr/library/Coq.Structures.Equalities.html#UsualDecidableType"><span class="id" type="module">UsualDecidableType</span></a>) &lt;: <a class="idref" href="TImp.html#Map"><span class="id" type="module">Map</span></a> <a class="idref" href="TImp.html#K"><span class="id" type="module">K</span></a>.<br/><hr class='doublespaceincode'/>
&nbsp;<span class="id" type="keyword">Section</span> <a name="ListMap.withv"><span class="id" type="section">withv</span></a>.<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">Context</span> {<span class="id" type="var">V</span> : <span class="id" type="keyword">Type</span>}.<br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">Definition</span> <a name="ListMap.t"><span class="id" type="definition">t</span></a> := <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#list"><span class="id" type="inductive">list</span></a> (<a class="idref" href="TImp.html#K.t"><span class="id" type="axiom">K.t</span></a> * <a class="idref" href="TImp.html#ListMap.withv.V"><span class="id" type="variable">V</span></a>).<br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">Definition</span> <a name="ListMap.empty"><span class="id" type="definition">empty</span></a> : <a class="idref" href="TImp.html#ListMap.t"><span class="id" type="definition">t</span></a> := [].<br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">Fixpoint</span> <a name="ListMap.get"><span class="id" type="definition">get</span></a> <span class="id" type="var">m</span> <span class="id" type="var">k</span> : <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#option"><span class="id" type="inductive">option</span></a> <a class="idref" href="TImp.html#ListMap.withv.V"><span class="id" type="variable">V</span></a> := <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <a class="idref" href="TImp.html#m"><span class="id" type="variable">m</span></a> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| [] ⇒ <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#None"><span class="id" type="constructor">None</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| (<span class="id" type="var">k'</span>, <span class="id" type="var">v</span>) :: <span class="id" type="var">m'</span> ⇒ <span class="id" type="keyword">if</span> <a class="idref" href="TImp.html#K.eq_dec"><span class="id" type="axiom">K.eq_dec</span></a> <a class="idref" href="TImp.html#k"><span class="id" type="variable">k</span></a> <span class="id" type="var">k'</span> <span class="id" type="keyword">then</span> <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#Some"><span class="id" type="constructor">Some</span></a> <span class="id" type="var">v</span> <span class="id" type="keyword">else</span> <a class="idref" href="TImp.html#get"><span class="id" type="definition">get</span></a> <span class="id" type="var">m'</span> <a class="idref" href="TImp.html#k"><span class="id" type="variable">k</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">Definition</span> <a name="ListMap.set"><span class="id" type="definition">set</span></a> (<span class="id" type="var">m</span>:<a class="idref" href="TImp.html#ListMap.t"><span class="id" type="definition">t</span></a>) (<span class="id" type="var">k</span>:<a class="idref" href="TImp.html#K.t"><span class="id" type="axiom">K.t</span></a>) (<span class="id" type="var">v</span>:<a class="idref" href="TImp.html#ListMap.withv.V"><span class="id" type="variable">V</span></a>) : <a class="idref" href="TImp.html#ListMap.t"><span class="id" type="definition">t</span></a> := (<a class="idref" href="TImp.html#k"><span class="id" type="variable">k</span></a>, <a class="idref" href="TImp.html#v"><span class="id" type="variable">v</span></a>) :: <a class="idref" href="TImp.html#m"><span class="id" type="variable">m</span></a>.<br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">Fixpoint</span> <a name="ListMap.dom"><span class="id" type="definition">dom</span></a> (<span class="id" type="var">m</span>:<a class="idref" href="TImp.html#ListMap.t"><span class="id" type="definition">t</span></a>) : <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#list"><span class="id" type="inductive">list</span></a> <a class="idref" href="TImp.html#K.t"><span class="id" type="axiom">K.t</span></a> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <a class="idref" href="TImp.html#m"><span class="id" type="variable">m</span></a> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| [] ⇒ []<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| (<span class="id" type="var">k'</span>, <span class="id" type="var">v</span>) :: <span class="id" type="var">m'</span> ⇒ <span class="id" type="var">k'</span> :: <a class="idref" href="TImp.html#dom"><span class="id" type="definition">dom</span></a> <span class="id" type="var">m'</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/><hr class='doublespaceincode'/>
&nbsp;<span class="id" type="keyword">End</span> <a class="idref" href="TImp.html#ListMap.withv"><span class="id" type="section">withv</span></a>.<br/><hr class='doublespaceincode'/>
<span class="id" type="keyword">End</span> <a class="idref" href="TImp.html#ListMap"><span class="id" type="module">ListMap</span></a>.<br/>
</div>

<div class="doc">
We then instantiate the <span class="inlinecode"><span class="id" type="var">ListMap</span></span> functor with <span class="inlinecode"><span class="id" type="var">Atom</span></span>, yielding
    <span class="inlinecode"><span class="id" type="var">AtomMap</span></span>, our desired map with <span class="inlinecode"><span class="id" type="var">Atom</span></span> as the key type. 
</div>
<div class="code code-tight">

<span class="id" type="keyword">Module</span> <a name="AtomMap"><span class="id" type="module">AtomMap</span></a> := <a class="idref" href="TImp.html#ListMap"><span class="id" type="module">ListMap</span></a> (<a class="idref" href="TImp.html#Atom"><span class="id" type="module">Atom</span></a>).<br/>
</div>

<div class="doc">
We next introduce a simple inductive relation, <span class="inlinecode"><span class="id" type="var">bound_to</span></span> <span class="inlinecode"><span class="id" type="var">m</span></span> <span class="inlinecode"><span class="id" type="var">x</span></span> <span class="inlinecode"><span class="id" type="var">a</span></span>, that 
    holds precisely when the binding of some <span class="inlinecode"><span class="id" type="var">Atom</span></span> <span class="inlinecode"><span class="id" type="var">x</span></span> is equal to <span class="inlinecode"><span class="id" type="var">a</span></span> in 
    <span class="inlinecode"><span class="id" type="var">m</span></span> 
</div>
<div class="code code-tight">

<span class="id" type="keyword">Inductive</span> <a name="bound_to"><span class="id" type="inductive">bound_to</span></a> {<span class="id" type="var">A</span>} : @<a class="idref" href="TImp.html#t"><span class="id" type="definition">AtomMap.t</span></a> <span class="id" type="var">A</span> → <a class="idref" href="TImp.html#t"><span class="id" type="axiom">Atom.t</span></a> → <span class="id" type="var">A</span> → <span class="id" type="keyword">Prop</span> :=<br/>
&nbsp;&nbsp;| <span class="id" type="keyword">Bind</span> : <span style='font-size:120%;'>&forall;</span> <span class="id" type="var">x</span> <span class="id" type="var">m</span> <span class="id" type="var">a</span>, <a class="idref" href="TImp.html#get"><span class="id" type="definition">AtomMap.get</span></a> <a class="idref" href="TImp.html#m"><span class="id" type="variable">m</span></a> <a class="idref" href="TImp.html#x"><span class="id" type="variable">x</span></a> = <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#Some"><span class="id" type="constructor">Some</span></a> <a class="idref" href="TImp.html#a"><span class="id" type="variable">a</span></a> → <a class="idref" href="TImp.html#bound_to"><span class="id" type="inductive">bound_to</span></a> <a class="idref" href="TImp.html#m"><span class="id" type="variable">m</span></a> <a class="idref" href="TImp.html#x"><span class="id" type="variable">x</span></a> <a class="idref" href="TImp.html#a"><span class="id" type="variable">a</span></a>.<br/>
</div>

<div class="doc">
We can now decide whether <span class="inlinecode"><span class="id" type="var">bound_to</span></span> <span class="inlinecode"><span class="id" type="var">m</span></span> <span class="inlinecode"><span class="id" type="var">x</span></span> <span class="inlinecode"><span class="id" type="var">a</span></span> holds for a given
    arrangement of <span class="inlinecode"><span class="id" type="var">m</span></span>, <span class="inlinecode"><span class="id" type="var">x</span></span> and <span class="inlinecode"><span class="id" type="var">a</span></span>.  On a first reading, you may
    prefer to skip the next few paragraphs (until the start of the
    <span class="inlinecode"><span class="id" type="keyword">Context</span></span> subsection), which deal with partially automating the
    proofs for such instances. 
</div>
<div class="code code-tight">

<span class="id" type="keyword">Instance</span> <a name="dec_bound_to"><span class="id" type="instance">dec_bound_to</span></a> {<span class="id" type="var">A</span> : <span class="id" type="keyword">Type</span>} <span class="id" type="var">Gamma</span> <span class="id" type="var">x</span> (<span class="id" type="var">T</span> : <a class="idref" href="TImp.html#A"><span class="id" type="variable">A</span></a>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`{<span class="id" type="var">D</span> : <span style='font-size:120%;'>&forall;</span> (<span class="id" type="var">x</span> <span class="id" type="var">y</span> : <a class="idref" href="TImp.html#A"><span class="id" type="variable">A</span></a>), <span class="id" type="class">Dec</span> (<a class="idref" href="TImp.html#x"><span class="id" type="variable">x</span></a> = <a class="idref" href="TImp.html#y"><span class="id" type="variable">y</span></a>)} <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id" type="class">Dec</span> (<a class="idref" href="TImp.html#bound_to"><span class="id" type="inductive">bound_to</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a> <a class="idref" href="TImp.html#x"><span class="id" type="variable">x</span></a> <a class="idref" href="TImp.html#T"><span class="id" type="variable">T</span></a>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">constructor</span>. <span class="id" type="tactic">unfold</span> <a class="idref" href="http://coq.inria.fr/library/Coq.ssr.ssrbool.html#decidable"><span class="id" type="definition">ssrbool.decidable</span></a>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<a class="idref" href="TImp.html#get"><span class="id" type="definition">AtomMap.get</span></a> <span class="id" type="var">Gamma</span> <span class="id" type="var">x</span>) <span class="id" type="var">eqn</span>:<span class="id" type="var">Get</span>.<br/>
</div>

<div class="doc">
After unfolding <span class="inlinecode"><span class="id" type="var">decidable</span></span> and destructing <span class="inlinecode"><span class="id" type="var">AtomMap.get</span></span> <span class="inlinecode"><span class="id" type="var">Gamma</span></span> <span class="inlinecode"><span class="id" type="var">x</span></span>, we are
    left with two subgoals. In the first, we know that <span class="inlinecode"><span class="id" type="var">AtomMap.get</span></span> <span class="inlinecode"><span class="id" type="var">Gamma</span></span> <span class="inlinecode"><span class="id" type="var">x</span></span> <span class="inlinecode">=</span>
    <span class="inlinecode"><span class="id" type="var">Some</span></span> <span class="inlinecode"><span class="id" type="var">a</span></span> and effectively want to decide whether <span class="inlinecode"><span class="id" type="var">AtomMap.get</span></span> <span class="inlinecode"><span class="id" type="var">Gamma</span></span> <span class="inlinecode"><span class="id" type="var">x</span></span> <span class="inlinecode">=</span> <span class="inlinecode"><span class="id" type="var">Some</span></span>
    <span class="inlinecode"><span class="id" type="var">T</span></span> or not. Which means we need to decide whether <span class="inlinecode"><span class="id" type="var">a</span></span> <span class="inlinecode">=</span> <span class="inlinecode"><span class="id" type="var">T</span></span>. Thankfully,
    we can decide that using our hypothesis <span class="inlinecode"><span class="id" type="var">D</span></span>. 
</div>
<div class="code code-tight">

&nbsp;&nbsp;- <span class="id" type="tactic">destruct</span> (<span class="id" type="var">D</span> <span class="id" type="var">a</span> <span class="id" type="var">T</span>) <span class="id" type="keyword">as</span> [[<span class="id" type="var">Eq</span> | <span class="id" type="var">NEq</span>]]; <span class="id" type="tactic">subst</span>.<br/>
</div>

<div class="doc">
At this point, the first goal can be immediately decided positevely
    using constructor. 
</div>
<div class="code code-tight">

&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="id" type="var">left</span>. <span class="id" type="var">constructor</span>. <span class="id" type="tactic">auto</span>.<br/>
</div>

<div class="doc">
In the second subgoal, we can show that <span class="inlinecode"><span class="id" type="var">bound_to</span></span> doesn't hold. 
</div>
<div class="code code-tight">

&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="id" type="var">right</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">Contra</span>; <span class="id" type="tactic">inversion</span> <span class="id" type="var">Contra</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">Contra</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">congruence</span>.<br/>
</div>

<div class="doc">
Both of these tactic patterns are very common in non-trival <span class="inlinecode"><span class="id" type="var">Dec</span></span> 
    instances. It is worth we automating them a bit using LTac. 
</div>
<div class="code code-tight">

<span class="id" type="keyword">Abort</span>.<br/>
</div>

<div class="doc">
A lot of the time, we can immediately decide a property positivly 
    using constructor applications. That is captured in <span class="inlinecode"><span class="id" type="var">solve_left</span></span>. 
</div>
<div class="code code-tight">

<span class="id" type="keyword">Ltac</span> <span class="id" type="var">solve_left</span>  := <span class="id" type="tactic">try</span> <span class="id" type="var">solve</span> [<span class="id" type="var">left</span>; <span class="id" type="var">econstructor</span>; <span class="id" type="tactic">eauto</span>].<br/>
</div>

<div class="doc">
Much of the time, we can also immediately decide that a property
    <i>doesn't</i> hold by assuming it, doing inversion, and using
    <span class="inlinecode"><span class="id" type="tactic">congruence</span></span>. 
</div>
<div class="code code-tight">

<span class="id" type="keyword">Ltac</span> <span class="id" type="var">solve_right</span> := <br/>
&nbsp;&nbsp;<span class="id" type="keyword">let</span> <span class="id" type="var">Contra</span> := <span class="id" type="tactic">fresh</span> "Contra" <span class="id" type="keyword">in</span><br/>
&nbsp;&nbsp;<span class="id" type="tactic">try</span> <span class="id" type="var">solve</span> [<span class="id" type="var">right</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">Contra</span>; <span class="id" type="tactic">inversion</span> <span class="id" type="var">Contra</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">Contra</span>; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eauto</span>; <span class="id" type="tactic">congruence</span>].<br/>
</div>

<div class="doc">
We group both in a single tactic, which does nothing at all if 
    it fails to solve a goal, thanks to <span class="inlinecode"><span class="id" type="tactic">try</span></span> <span class="inlinecode"><span class="id" type="var">solve</span></span>. 
</div>
<div class="code code-tight">

<span class="id" type="keyword">Ltac</span> <span class="id" type="var">solve_sum</span> := <span class="id" type="var">solve_left</span>; <span class="id" type="var">solve_right</span>.<br/>
</div>

<div class="doc">
We can now prove the <span class="inlinecode"><span class="id" type="var">Dec</span></span> instance quite concisely. 
</div>
<div class="code code-tight">

<span class="id" type="keyword">Instance</span> <a name="dec_bound_to"><span class="id" type="instance">dec_bound_to</span></a> {<span class="id" type="var">A</span> : <span class="id" type="keyword">Type</span>} <span class="id" type="var">Gamma</span> <span class="id" type="var">x</span> (<span class="id" type="var">T</span> : <a class="idref" href="TImp.html#A"><span class="id" type="variable">A</span></a>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`{<span class="id" type="var">D</span> : <span style='font-size:120%;'>&forall;</span> (<span class="id" type="var">x</span> <span class="id" type="var">y</span> : <a class="idref" href="TImp.html#A"><span class="id" type="variable">A</span></a>), <span class="id" type="class">Dec</span> (<a class="idref" href="TImp.html#x"><span class="id" type="variable">x</span></a> = <a class="idref" href="TImp.html#y"><span class="id" type="variable">y</span></a>)}<br/>
&nbsp;&nbsp;: <span class="id" type="class">Dec</span> (<a class="idref" href="TImp.html#bound_to"><span class="id" type="inductive">bound_to</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a> <a class="idref" href="TImp.html#x"><span class="id" type="variable">x</span></a> <a class="idref" href="TImp.html#T"><span class="id" type="variable">T</span></a>).<br/>
<div class="togglescript" id="proofcontrol1" onclick="toggleDisplay('proof1');toggleDisplay('proofcontrol1')"><span class="show"></span></div>
<div class="proofscript" id="proof1" onclick="toggleDisplay('proof1');toggleDisplay('proofcontrol1')">
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">constructor</span>. <span class="id" type="tactic">unfold</span> <a class="idref" href="http://coq.inria.fr/library/Coq.ssr.ssrbool.html#decidable"><span class="id" type="definition">ssrbool.decidable</span></a>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<a class="idref" href="TImp.html#get"><span class="id" type="definition">AtomMap.get</span></a> <span class="id" type="var">Gamma</span> <span class="id" type="var">x</span>) <span class="id" type="var">eqn</span>:<span class="id" type="var">Get</span>; <span class="id" type="var">solve_sum</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<span class="id" type="var">D</span> <span class="id" type="var">a</span> <span class="id" type="var">T</span>) <span class="id" type="keyword">as</span> [[<span class="id" type="var">Eq</span> | <span class="id" type="var">NEq</span>]]; <span class="id" type="tactic">subst</span>; <span class="id" type="var">solve_sum</span>.<br/>
<span class="id" type="keyword">Defined</span>.<br/>
</div>
</div>

<div class="doc">
<a name="lab77"></a><h2 class="section">Contexts</h2>

<div class="paragraph"> </div>

 Typing contexts in TImp are just maps from atoms to types. 
</div>
<div class="code code-tight">

<span class="id" type="keyword">Definition</span> <a name="context"><span class="id" type="definition">context</span></a> := @<a class="idref" href="TImp.html#t"><span class="id" type="definition">AtomMap.t</span></a> <a class="idref" href="TImp.html#ty"><span class="id" type="inductive">ty</span></a>.<br/>
</div>

<div class="doc">
Given a context <span class="inlinecode"><span class="id" type="var">Gamma</span></span> and a type <span class="inlinecode"><span class="id" type="var">T</span></span>, we can try to generate a
    random <span class="inlinecode"><span class="id" type="var">Atom</span></span> whose binding in <span class="inlinecode"><span class="id" type="var">Gamma</span></span> is <span class="inlinecode"><span class="id" type="var">T</span></span>.

<div class="paragraph"> </div>

    We use <span class="inlinecode"><span class="id" type="var">List.filter</span></span> to extract all of the elements in <span class="inlinecode"><span class="id" type="var">Gamma</span></span>
    whose type is equal to <span class="inlinecode"><span class="id" type="var">T</span></span> and then, for each <span class="inlinecode">(<span class="id" type="var">a</span>,<span class="id" type="var">T'</span>)</span> that
    remains, return the name <span class="inlinecode"><span class="id" type="var">a</span></span>. We use the <span class="inlinecode"><span class="id" type="var">oneof</span></span> combinator to
    pick an generator from this list at random.

<div class="paragraph"> </div>

    Since the filtered list might be empty we return an <span class="inlinecode"><span class="id" type="var">option</span></span>,
    using <span class="inlinecode"><span class="id" type="var">ret</span></span> <span class="inlinecode"><span class="id" type="var">None</span></span> as the default element for <span class="inlinecode"><span class="id" type="var">oneof</span></span>.
 
</div>
<div class="code code-tight">

<span class="id" type="keyword">Definition</span> <a name="gen_typed_atom_from_context"><span class="id" type="definition">gen_typed_atom_from_context</span></a> (<span class="id" type="var">Gamma</span> : <a class="idref" href="TImp.html#context"><span class="id" type="definition">context</span></a>) (<span class="id" type="var">T</span> : <a class="idref" href="TImp.html#ty"><span class="id" type="inductive">ty</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id" type="axiom">G</span> (<a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#option"><span class="id" type="inductive">option</span></a> <a class="idref" href="TImp.html#t"><span class="id" type="axiom">Atom.t</span></a>) :=<br/>
&nbsp;&nbsp;<span class="id" type="axiom">oneof</span> (<span class="id" type="method">ret</span> <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#None"><span class="id" type="constructor">None</span></a>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a class="idref" href="http://coq.inria.fr/library/Coq.Lists.List.html#map"><span class="id" type="definition">List.map</span></a> (<span class="id" type="keyword">fun</span> '(<span class="id" type="var">a</span>,<span class="id" type="var">T'</span>) ⇒ <span class="id" type="method">ret</span> (<a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#Some"><span class="id" type="constructor">Some</span></a> <a class="idref" href="TImp.html#a"><span class="id" type="variable">a</span></a>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a class="idref" href="http://coq.inria.fr/library/Coq.Lists.List.html#filter"><span class="id" type="definition">List.filter</span></a> (<span class="id" type="keyword">fun</span> '(<span class="id" type="var">a</span>,<span class="id" type="var">T'</span>) ⇒ <a class="idref" href="TImp.html#T"><span class="id" type="variable">T</span></a> = <a class="idref" href="TImp.html#T'"><span class="id" type="variable">T'</span></a>?) <a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a>)).<br/>
</div>

<div class="doc">
We also need to generate typing contexts.

<div class="paragraph"> </div>

    Given some natural number <span class="inlinecode"><span class="id" type="var">n</span></span> to serve as the size of the context,
    we first create its domain, <span class="inlinecode"><span class="id" type="var">n</span></span> fresh atoms. 
</div>
<div class="code code-tight">

<span class="id" type="keyword">Definition</span> <a name="gen_context"><span class="id" type="definition">gen_context</span></a> (<span class="id" type="var">n</span> : <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nat"><span class="id" type="inductive">nat</span></a>) : <span class="id" type="axiom">G</span> <a class="idref" href="TImp.html#context"><span class="id" type="definition">context</span></a> := <br/>
&nbsp;&nbsp;<span class="id" type="keyword">let</span> <span class="id" type="var">domain</span> := <a class="idref" href="TImp.html#get_fresh_atoms"><span class="id" type="definition">get_fresh_atoms</span></a> <a class="idref" href="TImp.html#n"><span class="id" type="variable">n</span></a> [] <span class="id" type="keyword">in</span><br/>
&nbsp;&nbsp;<span class="id" type="var">range</span> &lt;- <span class="id" type="axiom">vectorOf</span> <a class="idref" href="TImp.html#n"><span class="id" type="variable">n</span></a> <span class="id" type="method">arbitrary</span> ;;<br/>
&nbsp;&nbsp;<span class="id" type="method">ret</span> (<a class="idref" href="http://coq.inria.fr/library/Coq.Lists.List.html#fold_left"><span class="id" type="definition">List.fold_left</span></a> (<span class="id" type="keyword">fun</span> <span class="id" type="var">m</span> '(<span class="id" type="var">k</span>, <span class="id" type="var">v</span>) ⇒ <a class="idref" href="TImp.html#set"><span class="id" type="definition">AtomMap.set</span></a> <a class="idref" href="TImp.html#m"><span class="id" type="variable">m</span></a> <a class="idref" href="TImp.html#k"><span class="id" type="variable">k</span></a> <a class="idref" href="TImp.html#v"><span class="id" type="variable">v</span></a>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a class="idref" href="http://coq.inria.fr/library/Coq.Lists.List.html#combine"><span class="id" type="definition">List.combine</span></a> <a class="idref" href="TImp.html#domain"><span class="id" type="variable">domain</span></a> <a class="idref" href="TImp.html#range"><span class="id" type="variable">range</span></a>) <a class="idref" href="TImp.html#empty"><span class="id" type="definition">AtomMap.empty</span></a>).<br/>
</div>

<div class="doc">
We then create <span class="inlinecode"><span class="id" type="var">n</span></span> arbitrary types with <span class="inlinecode"><span class="id" type="var">vectorOf</span></span>, using the
    <span class="inlinecode"><span class="id" type="var">Gen</span></span> instance for <span class="inlinecode"><span class="id" type="var">ty</span></span> we derived earlier.

<div class="paragraph"> </div>

    Finally, we zip (<span class="inlinecode"><span class="id" type="var">List.combine</span></span>) the domain with the ranges and
    fold over the result to insert each binding into a map. 
<div class="paragraph"> </div>

<a name="lab78"></a><h1 class="section">Expressions</h1>

<div class="paragraph"> </div>

 We are now ready to introduce the syntax of expressions in TImp.
    The original Imp had two distinct types of expressions,
    arithmetic and boolean expressions; variables were only
    allowed to range over natural numbers. In TImp, we extend
    variables to range over boolean values as well, and we collapse
    expressions into a single type <span class="inlinecode"><span class="id" type="var">exp</span></span>. 
</div>
<div class="code code-tight">

<span class="id" type="keyword">Inductive</span> <a name="exp"><span class="id" type="inductive">exp</span></a> : <span class="id" type="keyword">Type</span> :=<br/>
&nbsp;&nbsp;| <a name="EVar"><span class="id" type="constructor">EVar</span></a> : <a class="idref" href="TImp.html#t"><span class="id" type="axiom">Atom.t</span></a> → <a class="idref" href="TImp.html#exp"><span class="id" type="inductive">exp</span></a><br/>
&nbsp;&nbsp;| <a name="ENum"><span class="id" type="constructor">ENum</span></a> : <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nat"><span class="id" type="inductive">nat</span></a> → <a class="idref" href="TImp.html#exp"><span class="id" type="inductive">exp</span></a><br/>
&nbsp;&nbsp;| <a name="EPlus"><span class="id" type="constructor">EPlus</span></a> : <a class="idref" href="TImp.html#exp"><span class="id" type="inductive">exp</span></a> → <a class="idref" href="TImp.html#exp"><span class="id" type="inductive">exp</span></a> → <a class="idref" href="TImp.html#exp"><span class="id" type="inductive">exp</span></a><br/>
&nbsp;&nbsp;| <a name="EMinus"><span class="id" type="constructor">EMinus</span></a> : <a class="idref" href="TImp.html#exp"><span class="id" type="inductive">exp</span></a> → <a class="idref" href="TImp.html#exp"><span class="id" type="inductive">exp</span></a> → <a class="idref" href="TImp.html#exp"><span class="id" type="inductive">exp</span></a><br/>
&nbsp;&nbsp;| <a name="EMult"><span class="id" type="constructor">EMult</span></a> : <a class="idref" href="TImp.html#exp"><span class="id" type="inductive">exp</span></a> → <a class="idref" href="TImp.html#exp"><span class="id" type="inductive">exp</span></a> → <a class="idref" href="TImp.html#exp"><span class="id" type="inductive">exp</span></a><br/>
&nbsp;&nbsp;| <a name="ETrue"><span class="id" type="constructor">ETrue</span></a> : <a class="idref" href="TImp.html#exp"><span class="id" type="inductive">exp</span></a><br/>
&nbsp;&nbsp;| <a name="EFalse"><span class="id" type="constructor">EFalse</span></a> : <a class="idref" href="TImp.html#exp"><span class="id" type="inductive">exp</span></a><br/>
&nbsp;&nbsp;| <a name="EEq"><span class="id" type="constructor">EEq</span></a> : <a class="idref" href="TImp.html#exp"><span class="id" type="inductive">exp</span></a> → <a class="idref" href="TImp.html#exp"><span class="id" type="inductive">exp</span></a> → <a class="idref" href="TImp.html#exp"><span class="id" type="inductive">exp</span></a><br/>
&nbsp;&nbsp;| <a name="ELe"><span class="id" type="constructor">ELe</span></a> : <a class="idref" href="TImp.html#exp"><span class="id" type="inductive">exp</span></a> → <a class="idref" href="TImp.html#exp"><span class="id" type="inductive">exp</span></a> → <a class="idref" href="TImp.html#exp"><span class="id" type="inductive">exp</span></a><br/>
&nbsp;&nbsp;| <a name="ENot"><span class="id" type="constructor">ENot</span></a> : <a class="idref" href="TImp.html#exp"><span class="id" type="inductive">exp</span></a> → <a class="idref" href="TImp.html#exp"><span class="id" type="inductive">exp</span></a><br/>
&nbsp;&nbsp;| <a name="EAnd"><span class="id" type="constructor">EAnd</span></a> : <a class="idref" href="TImp.html#exp"><span class="id" type="inductive">exp</span></a> → <a class="idref" href="TImp.html#exp"><span class="id" type="inductive">exp</span></a> → <a class="idref" href="TImp.html#exp"><span class="id" type="inductive">exp</span></a>.<br/>
</div>

<div class="doc">
To print expressions we derive a <span class="inlinecode"><span class="id" type="keyword">Show</span></span> Instance. 
</div>
<div class="code code-tight">

<span class="id" type="var">Derive</span> <span class="id" type="keyword">Show</span> <span class="id" type="keyword">for</span> <span class="id" type="var">exp</span>.<br/>
</div>

<div class="doc">
<a name="lab79"></a><h2 class="section">Typed Expressions</h2>

<div class="paragraph"> </div>

 The following inductive relation characterizes well-typed
    expressions of a particular type. It is straightforward, using
    <span class="inlinecode"><span class="id" type="var">bound_to</span></span> to access the typing context in the variable case 
</div>
<div class="code code-tight">

<span class="id" type="keyword">Reserved Notation</span> "Gamma '||-' e '\IN' T" (<span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 40).<br/><hr class='doublespaceincode'/>
<span class="id" type="keyword">Inductive</span> <a name="has_type"><span class="id" type="inductive">has_type</span></a> : <a class="idref" href="TImp.html#context"><span class="id" type="definition">context</span></a> → <a class="idref" href="TImp.html#exp"><span class="id" type="inductive">exp</span></a> → <a class="idref" href="TImp.html#ty"><span class="id" type="inductive">ty</span></a> → <span class="id" type="keyword">Prop</span> := <br/>
| <a name="Ty_Var"><span class="id" type="constructor">Ty_Var</span></a> : <span style='font-size:120%;'>&forall;</span> <span class="id" type="var">x</span> <span class="id" type="var">T</span> <span class="id" type="var">Gamma</span>, <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="TImp.html#bound_to"><span class="id" type="inductive">bound_to</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a> <a class="idref" href="TImp.html#x"><span class="id" type="variable">x</span></a> <a class="idref" href="TImp.html#T"><span class="id" type="variable">T</span></a> → <a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a> ||- <a class="idref" href="TImp.html#EVar"><span class="id" type="constructor">EVar</span></a> <a class="idref" href="TImp.html#x"><span class="id" type="variable">x</span></a> \<span class="id" type="var">IN</span> <a class="idref" href="TImp.html#T"><span class="id" type="variable">T</span></a><br/>
| <a name="Ty_Num"><span class="id" type="constructor">Ty_Num</span></a> : <span style='font-size:120%;'>&forall;</span> <span class="id" type="var">Gamma</span> <span class="id" type="var">n</span>, <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a> ||- <a class="idref" href="TImp.html#ENum"><span class="id" type="constructor">ENum</span></a> <a class="idref" href="TImp.html#n"><span class="id" type="variable">n</span></a> \<span class="id" type="var">IN</span> <a class="idref" href="TImp.html#TNat"><span class="id" type="constructor">TNat</span></a><br/>
| <a name="Ty_Plus"><span class="id" type="constructor">Ty_Plus</span></a> : <span style='font-size:120%;'>&forall;</span> <span class="id" type="var">Gamma</span> <span class="id" type="var">e<sub>1</sub></span> <span class="id" type="var">e<sub>2</sub></span>, <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a> ||- <a class="idref" href="TImp.html#e<sub>1</sub>"><span class="id" type="variable">e<sub>1</sub></span></a> \<span class="id" type="var">IN</span> <a class="idref" href="TImp.html#TNat"><span class="id" type="constructor">TNat</span></a> → <a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a> ||- <a class="idref" href="TImp.html#e<sub>2</sub>"><span class="id" type="variable">e<sub>2</sub></span></a> \<span class="id" type="var">IN</span> <a class="idref" href="TImp.html#TNat"><span class="id" type="constructor">TNat</span></a> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a> ||- <a class="idref" href="TImp.html#EPlus"><span class="id" type="constructor">EPlus</span></a> <a class="idref" href="TImp.html#e<sub>1</sub>"><span class="id" type="variable">e<sub>1</sub></span></a> <a class="idref" href="TImp.html#e<sub>2</sub>"><span class="id" type="variable">e<sub>2</sub></span></a> \<span class="id" type="var">IN</span> <a class="idref" href="TImp.html#TNat"><span class="id" type="constructor">TNat</span></a>                                    <br/>
| <a name="Ty_Minus"><span class="id" type="constructor">Ty_Minus</span></a> : <span style='font-size:120%;'>&forall;</span> <span class="id" type="var">Gamma</span> <span class="id" type="var">e<sub>1</sub></span> <span class="id" type="var">e<sub>2</sub></span>, <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a> ||- <a class="idref" href="TImp.html#e<sub>1</sub>"><span class="id" type="variable">e<sub>1</sub></span></a> \<span class="id" type="var">IN</span> <a class="idref" href="TImp.html#TNat"><span class="id" type="constructor">TNat</span></a> → <a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a> ||- <a class="idref" href="TImp.html#e<sub>2</sub>"><span class="id" type="variable">e<sub>2</sub></span></a> \<span class="id" type="var">IN</span> <a class="idref" href="TImp.html#TNat"><span class="id" type="constructor">TNat</span></a> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a> ||- <a class="idref" href="TImp.html#EMinus"><span class="id" type="constructor">EMinus</span></a> <a class="idref" href="TImp.html#e<sub>1</sub>"><span class="id" type="variable">e<sub>1</sub></span></a> <a class="idref" href="TImp.html#e<sub>2</sub>"><span class="id" type="variable">e<sub>2</sub></span></a> \<span class="id" type="var">IN</span> <a class="idref" href="TImp.html#TNat"><span class="id" type="constructor">TNat</span></a>                                    <br/>
| <a name="Ty_Mult"><span class="id" type="constructor">Ty_Mult</span></a> : <span style='font-size:120%;'>&forall;</span> <span class="id" type="var">Gamma</span> <span class="id" type="var">e<sub>1</sub></span> <span class="id" type="var">e<sub>2</sub></span>, <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a> ||- <a class="idref" href="TImp.html#e<sub>1</sub>"><span class="id" type="variable">e<sub>1</sub></span></a> \<span class="id" type="var">IN</span> <a class="idref" href="TImp.html#TNat"><span class="id" type="constructor">TNat</span></a> → <a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a> ||- <a class="idref" href="TImp.html#e<sub>2</sub>"><span class="id" type="variable">e<sub>2</sub></span></a> \<span class="id" type="var">IN</span> <a class="idref" href="TImp.html#TNat"><span class="id" type="constructor">TNat</span></a> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a> ||- <a class="idref" href="TImp.html#EMult"><span class="id" type="constructor">EMult</span></a> <a class="idref" href="TImp.html#e<sub>1</sub>"><span class="id" type="variable">e<sub>1</sub></span></a> <a class="idref" href="TImp.html#e<sub>2</sub>"><span class="id" type="variable">e<sub>2</sub></span></a> \<span class="id" type="var">IN</span> <a class="idref" href="TImp.html#TNat"><span class="id" type="constructor">TNat</span></a>                                    <br/>
| <a name="Ty_True"><span class="id" type="constructor">Ty_True</span></a> : <span style='font-size:120%;'>&forall;</span> <span class="id" type="var">Gamma</span>, <a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a> ||- <a class="idref" href="TImp.html#ETrue"><span class="id" type="constructor">ETrue</span></a> \<span class="id" type="var">IN</span> <a class="idref" href="TImp.html#TBool"><span class="id" type="constructor">TBool</span></a><br/>
| <a name="Ty_False"><span class="id" type="constructor">Ty_False</span></a> : <span style='font-size:120%;'>&forall;</span> <span class="id" type="var">Gamma</span>, <a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a> ||- <a class="idref" href="TImp.html#EFalse"><span class="id" type="constructor">EFalse</span></a> \<span class="id" type="var">IN</span> <a class="idref" href="TImp.html#TBool"><span class="id" type="constructor">TBool</span></a><br/>
| <a name="Ty_Eq"><span class="id" type="constructor">Ty_Eq</span></a> : <span style='font-size:120%;'>&forall;</span> <span class="id" type="var">Gamma</span> <span class="id" type="var">e<sub>1</sub></span> <span class="id" type="var">e<sub>2</sub></span>, <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a> ||- <a class="idref" href="TImp.html#e<sub>1</sub>"><span class="id" type="variable">e<sub>1</sub></span></a> \<span class="id" type="var">IN</span> <a class="idref" href="TImp.html#TNat"><span class="id" type="constructor">TNat</span></a> → <a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a> ||- <a class="idref" href="TImp.html#e<sub>2</sub>"><span class="id" type="variable">e<sub>2</sub></span></a> \<span class="id" type="var">IN</span> <a class="idref" href="TImp.html#TNat"><span class="id" type="constructor">TNat</span></a> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a> ||- <a class="idref" href="TImp.html#EEq"><span class="id" type="constructor">EEq</span></a> <a class="idref" href="TImp.html#e<sub>1</sub>"><span class="id" type="variable">e<sub>1</sub></span></a> <a class="idref" href="TImp.html#e<sub>2</sub>"><span class="id" type="variable">e<sub>2</sub></span></a> \<span class="id" type="var">IN</span> <a class="idref" href="TImp.html#TBool"><span class="id" type="constructor">TBool</span></a><br/>
| <a name="Ty_Le"><span class="id" type="constructor">Ty_Le</span></a> : <span style='font-size:120%;'>&forall;</span> <span class="id" type="var">Gamma</span> <span class="id" type="var">e<sub>1</sub></span> <span class="id" type="var">e<sub>2</sub></span>, <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a> ||- <a class="idref" href="TImp.html#e<sub>1</sub>"><span class="id" type="variable">e<sub>1</sub></span></a> \<span class="id" type="var">IN</span> <a class="idref" href="TImp.html#TNat"><span class="id" type="constructor">TNat</span></a> → <a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a> ||- <a class="idref" href="TImp.html#e<sub>2</sub>"><span class="id" type="variable">e<sub>2</sub></span></a> \<span class="id" type="var">IN</span> <a class="idref" href="TImp.html#TNat"><span class="id" type="constructor">TNat</span></a> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a> ||- <a class="idref" href="TImp.html#ELe"><span class="id" type="constructor">ELe</span></a> <a class="idref" href="TImp.html#e<sub>1</sub>"><span class="id" type="variable">e<sub>1</sub></span></a> <a class="idref" href="TImp.html#e<sub>2</sub>"><span class="id" type="variable">e<sub>2</sub></span></a> \<span class="id" type="var">IN</span> <a class="idref" href="TImp.html#TBool"><span class="id" type="constructor">TBool</span></a><br/>
| <a name="Ty_Not"><span class="id" type="constructor">Ty_Not</span></a> : <span style='font-size:120%;'>&forall;</span> <span class="id" type="var">Gamma</span> <span class="id" type="var">e</span>, <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a> ||- <a class="idref" href="TImp.html#e"><span class="id" type="variable">e</span></a> \<span class="id" type="var">IN</span> <a class="idref" href="TImp.html#TBool"><span class="id" type="constructor">TBool</span></a> →  <a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a> ||- <a class="idref" href="TImp.html#ENot"><span class="id" type="constructor">ENot</span></a> <a class="idref" href="TImp.html#e"><span class="id" type="variable">e</span></a> \<span class="id" type="var">IN</span> <a class="idref" href="TImp.html#TBool"><span class="id" type="constructor">TBool</span></a><br/>
| <a name="Ty_And"><span class="id" type="constructor">Ty_And</span></a> : <span style='font-size:120%;'>&forall;</span> <span class="id" type="var">Gamma</span> <span class="id" type="var">e<sub>1</sub></span> <span class="id" type="var">e<sub>2</sub></span>, <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a> ||- <a class="idref" href="TImp.html#e<sub>1</sub>"><span class="id" type="variable">e<sub>1</sub></span></a> \<span class="id" type="var">IN</span> <a class="idref" href="TImp.html#TBool"><span class="id" type="constructor">TBool</span></a> → <a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a> ||- <a class="idref" href="TImp.html#e<sub>2</sub>"><span class="id" type="variable">e<sub>2</sub></span></a> \<span class="id" type="var">IN</span> <a class="idref" href="TImp.html#TBool"><span class="id" type="constructor">TBool</span></a> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a> ||- <a class="idref" href="TImp.html#EAnd"><span class="id" type="constructor">EAnd</span></a> <a class="idref" href="TImp.html#e<sub>1</sub>"><span class="id" type="variable">e<sub>1</sub></span></a> <a class="idref" href="TImp.html#e<sub>2</sub>"><span class="id" type="variable">e<sub>2</sub></span></a> \<span class="id" type="var">IN</span> <a class="idref" href="TImp.html#TBool"><span class="id" type="constructor">TBool</span></a><br/>
<br/>
<span class="id" type="keyword">where</span> "Gamma '||-' e '\IN' T" := (<a class="idref" href="TImp.html#has_type"><span class="id" type="inductive">has_type</span></a> <span class="id" type="var">Gamma</span> <span class="id" type="var">e</span> <span class="id" type="var">T</span>).<br/>
</div>

<div class="doc">
Once again, we need a decidable instance for the typing relation of
    TImp. You can skip to the next exercise if you are not interested in
    specific proof details. 
<div class="paragraph"> </div>

 We will need a bit more automation for this proof. We will
    have a lot of hypotheses of the form: 

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;<span class="id" type="var">IH</span>&nbsp;:&nbsp;<span style='font-size:120%;'>&forall;</span>&nbsp;(<span class="id" type="var">T</span>&nbsp;:&nbsp;<span class="id" type="var">ty</span>)&nbsp;(<span class="id" type="var">Gamma</span>&nbsp;:&nbsp;<span class="id" type="var">context</span>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">ssrbool.decidable</span>&nbsp;(<span class="id" type="var">Gamma</span>&nbsp;||-&nbsp;<span class="id" type="var">e<sub>1</sub></span>&nbsp;\<span class="id" type="var">IN</span>&nbsp;<span class="id" type="var">T</span>)
<div class="paragraph"> </div>

</div>

<div class="paragraph"> </div>

    Using a brute-force approach, we instantiate such <span class="inlinecode"><span class="id" type="var">IH</span></span>
    with both <span class="inlinecode"><span class="id" type="var">TNat</span></span> and <span class="inlinecode"><span class="id" type="var">TBool</span></span>, destruct them and then 
    call <span class="inlinecode"><span class="id" type="var">solve_sum</span></span>. 

<div class="paragraph"> </div>

    The <span class="inlinecode"><span class="id" type="var">pose</span></span> <span class="inlinecode"><span class="id" type="var">proof</span></span> tactic introduces a new hypothesis 
    in our context, while <span class="inlinecode"><span class="id" type="tactic">clear</span></span> <span class="inlinecode"><span class="id" type="var">IH</span></span> removes it so that 
    we don't try the same instantiations again and 
    again.

</div>
<div class="code code-tight">

<span class="id" type="keyword">Ltac</span> <span class="id" type="var">solve_inductives</span> <span class="id" type="var">Gamma</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="tactic">repeat</span> (<span class="id" type="keyword">match</span> <span class="id" type="var">goal</span> <span class="id" type="keyword">with</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[ <span class="id" type="var">IH</span> : <span style='font-size:120%;'>&forall;</span> <span class="id" type="var">_</span> <span class="id" type="var">_</span>, <span class="id" type="var">_</span> |- <span class="id" type="var">_</span> ] ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">let</span> <span class="id" type="var">H<sub>1</sub></span> := <span class="id" type="tactic">fresh</span> "H<sub>1</sub>" <span class="id" type="keyword">in</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">pose</span> <span class="id" type="var">proof</span> (<span class="id" type="var">IH</span> <a class="idref" href="TImp.html#TNat"><span class="id" type="constructor">TNat</span></a> <span class="id" type="var">Gamma</span>) <span class="id" type="keyword">as</span> <span class="id" type="var">H<sub>1</sub></span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">let</span> <span class="id" type="var">H<sub>2</sub></span> := <span class="id" type="tactic">fresh</span> "H<sub>2</sub>" <span class="id" type="keyword">in</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">pose</span> <span class="id" type="var">proof</span> (<span class="id" type="var">IH</span> <a class="idref" href="TImp.html#TBool"><span class="id" type="constructor">TBool</span></a> <span class="id" type="var">Gamma</span>) <span class="id" type="keyword">as</span> <span class="id" type="var">H<sub>2</sub></span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">clear</span> <span class="id" type="var">IH</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">H<sub>1</sub></span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">H<sub>2</sub></span>; <span class="id" type="var">solve_sum</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>).<br/>
</div>

<div class="doc">
Typing in TImp is decidable: given an expression <span class="inlinecode"><span class="id" type="var">e</span></span>, a context <span class="inlinecode"><span class="id" type="var">Gamma</span></span> 
    and a type <span class="inlinecode"><span class="id" type="var">T</span></span>, we can decide whether <span class="inlinecode"><span class="id" type="var">has_type</span></span> <span class="inlinecode"><span class="id" type="var">Gamma</span></span> <span class="inlinecode"><span class="id" type="var">e</span></span> <span class="inlinecode"><span class="id" type="var">T</span></span> holds. 
</div>
<div class="code code-tight">

<span class="id" type="keyword">Instance</span> <a name="dec_has_type"><span class="id" type="instance">dec_has_type</span></a> (<span class="id" type="var">e</span> : <a class="idref" href="TImp.html#exp"><span class="id" type="inductive">exp</span></a>) (<span class="id" type="var">Gamma</span> : <a class="idref" href="TImp.html#context"><span class="id" type="definition">context</span></a>) (<span class="id" type="var">T</span> : <a class="idref" href="TImp.html#ty"><span class="id" type="inductive">ty</span></a>) <br/>
&nbsp;&nbsp;: <span class="id" type="class">Dec</span> (<a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a> ||- <a class="idref" href="TImp.html#e"><span class="id" type="variable">e</span></a> \<span class="id" type="var">IN</span> <a class="idref" href="TImp.html#T"><span class="id" type="variable">T</span></a>).<br/>
<div class="togglescript" id="proofcontrol2" onclick="toggleDisplay('proof2');toggleDisplay('proofcontrol2')"><span class="show"></span></div>
<div class="proofscript" id="proof2" onclick="toggleDisplay('proof2');toggleDisplay('proofcontrol2')">
<span class="id" type="keyword">Proof</span> <span class="id" type="keyword">with</span> <span class="id" type="var">solve_sum</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">constructor</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">generalize</span> <span class="id" type="tactic">dependent</span> <span class="id" type="var">Gamma</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">generalize</span> <span class="id" type="tactic">dependent</span> <span class="id" type="var">T</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">induction</span> <span class="id" type="var">e</span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">T</span> <span class="id" type="var">Gamma</span>; <span class="id" type="tactic">unfold</span> <a class="idref" href="http://coq.inria.fr/library/Coq.ssr.ssrbool.html#decidable"><span class="id" type="definition">ssrbool.decidable</span></a>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">try</span> <span class="id" type="var">solve</span> [<span class="id" type="tactic">destruct</span> <span class="id" type="var">T</span>; <span class="id" type="var">solve_sum</span>];<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">try</span> <span class="id" type="var">solve</span> [<span class="id" type="tactic">destruct</span> <span class="id" type="var">T</span>; <span class="id" type="var">solve_inductives</span> <span class="id" type="var">Gamma</span>].<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;bound_to&nbsp;case:&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<a class="idref" href="TImp.html#dec_bound_to"><span class="id" type="instance">dec_bound_to</span></a> <span class="id" type="var">Gamma</span> <span class="id" type="var">t</span> <span class="id" type="var">T</span>); <span class="id" type="tactic">destruct</span> <span class="id" type="var">dec</span>; <span class="id" type="var">solve_sum</span>.<br/>
<span class="id" type="keyword">Defined</span>.<br/>
</div>
</div>

<div class="doc">
<a name="lab80"></a><h4 class="section">Exercise: 3 stars (arbitraryExp)</h4>
 Derive <span class="inlinecode"><span class="id" type="var">Arbitrary</span></span> for expressions.  To see how good it is at
    generating <i>well-typed</i> expressions, write a conditional property <span class="inlinecode"><span class="id" type="var">cond_prop</span></span> that is (trivially) always true, with the precondition that some
    expression is well-typed. Try to check that property like this:

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">QuickChickWith</span>&nbsp;(<span class="id" type="var">updMaxSize</span>&nbsp;<span class="id" type="var">stdArgs</span>&nbsp;3)&nbsp;<span class="id" type="var">cond_prop</span>.
<div class="paragraph"> </div>

</div>
    This idiom sets the maximum-size parameter for all generators to
    <span class="inlinecode">3</span>, rather the default, which is something larger like 10.  When
    generating examples, QuickChick will start with size 0, gradually
    increase the size until the maximum size is reached, and then
    start over.)  What happens when you vary the size bound? 
</div>
<div class="code code-tight">

<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span><br/>
</div>

<span class="proofbox">&#9744;</span> 
<div class="doc less-space">
<div class="paragraph"> </div>

<a name="lab81"></a><h2 class="section">Generating Typed Expressions</h2>

<div class="paragraph"> </div>

 Instead of generating expressions and filtering them using
    <span class="inlinecode"><span class="id" type="var">has_type</span></span>, we can be smarter and generate <i>well-typed</i>
    expressions for a given context directly.

<div class="paragraph"> </div>

    It is common for conditional generators to return <span class="inlinecode"><span class="id" type="var">option</span></span>s of the
    underlying type, allowing the possibility of failure if a wrong
    choice is made internally. For example, if we wanted to generate
    an expression of type <span class="inlinecode"><span class="id" type="var">TNat</span></span> and chose to try to do so by
    generating a variable, then we might not be able to finish (if the
    context is empty or only binds booleans). 
<div class="paragraph"> </div>

 To chain together two generators with types of the form 
    <span class="inlinecode"><span class="id" type="var">G</span></span> <span class="inlinecode">(<span class="id" type="var">option</span></span> <span class="inlinecode">...)</span>, we need to execute the first generator, match 
    on its result, and, when it is a <span class="inlinecode"><span class="id" type="var">Some</span></span>, apply the second generator. 
</div>
<div class="code code-tight">

<span class="id" type="keyword">Definition</span> <a name="bindGenOpt"><span class="id" type="definition">bindGenOpt</span></a> {<span class="id" type="var">A</span> <span class="id" type="var">B</span> : <span class="id" type="keyword">Type</span>} <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">gma</span> : <span class="id" type="axiom">G</span> (<a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#option"><span class="id" type="inductive">option</span></a> <a class="idref" href="TImp.html#A"><span class="id" type="variable">A</span></a>)) (<span class="id" type="var">k</span> : <a class="idref" href="TImp.html#A"><span class="id" type="variable">A</span></a> → <span class="id" type="axiom">G</span> (<a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#option"><span class="id" type="inductive">option</span></a> <a class="idref" href="TImp.html#B"><span class="id" type="variable">B</span></a>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id" type="axiom">G</span> (<a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#option"><span class="id" type="inductive">option</span></a> <a class="idref" href="TImp.html#B"><span class="id" type="variable">B</span></a>) :=<br/>
&nbsp;&nbsp;<span class="id" type="var">ma</span> &lt;- <a class="idref" href="TImp.html#gma"><span class="id" type="variable">gma</span></a> ;;<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <a class="idref" href="TImp.html#ma"><span class="id" type="variable">ma</span></a> <span class="id" type="keyword">with</span> <br/>
&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#Some"><span class="id" type="constructor">Some</span></a> <span class="id" type="var">a</span> ⇒ <a class="idref" href="TImp.html#k"><span class="id" type="variable">k</span></a> <span class="id" type="var">a</span> <br/>
&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#None"><span class="id" type="constructor">None</span></a> ⇒ <span class="id" type="method">ret</span> <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#None"><span class="id" type="constructor">None</span></a><br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>
</div>

<div class="doc">
This pattern is common enough that it's worth using explicit monadic 
    notations. 
</div>
<div class="code code-tight">

<span class="id" type="keyword">Definition</span> <a name="GOpt"><span class="id" type="definition">GOpt</span></a> <span class="id" type="var">A</span> := <span class="id" type="axiom">G</span> (<a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#option"><span class="id" type="inductive">option</span></a> <a class="idref" href="TImp.html#A"><span class="id" type="variable">A</span></a>).<br/><hr class='doublespaceincode'/>
<span class="id" type="keyword">Instance</span> <a name="gOptMonad"><span class="id" type="instance">gOptMonad</span></a> : `{<span class="id" type="class">Monad</span> <a class="idref" href="TImp.html#GOpt"><span class="id" type="definition">GOpt</span></a>} :=<br/>
&nbsp;&nbsp;{<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="method">ret</span> <span class="id" type="var">A</span> <span class="id" type="var">x</span> := <span class="id" type="axiom">returnGen</span> (<a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#Some"><span class="id" type="constructor">Some</span></a> <a class="idref" href="TImp.html#x"><span class="id" type="variable">x</span></a>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="method">bind</span> <span class="id" type="var">A</span> <span class="id" type="var">B</span> <span class="id" type="var">m</span> <span class="id" type="var">k</span> := <a class="idref" href="TImp.html#bindGenOpt"><span class="id" type="definition">bindGenOpt</span></a> <a class="idref" href="TImp.html#m"><span class="id" type="variable">m</span></a> <a class="idref" href="TImp.html#k"><span class="id" type="variable">k</span></a><br/>
&nbsp;&nbsp;}.<br/>
</div>

<div class="doc">
This brings us to our first interesting generator &mdash; one for typed
    expressions.  We asumme that <span class="inlinecode"><span class="id" type="var">Gamma</span></span> and <span class="inlinecode"><span class="id" type="var">T</span></span> are inputs to the
    generation process.  We also use a <span class="inlinecode"><span class="id" type="var">size</span></span> parameter to control the
    depth of generated expressions (i.e., we'll define a sized
    generator). 
<div class="paragraph"> </div>

 Let's start with a much smaller relation: <span class="inlinecode"><span class="id" type="var">has_type_1</span></span> (which
    consists of just the first constructor of <span class="inlinecode"><span class="id" type="var">has_type</span></span>), to
    demonstrate how to build up complex generators for typed
    expressions from smaller parts. 
</div>
<div class="code code-tight">

<span class="id" type="keyword">Inductive</span> <a name="has_type_1"><span class="id" type="inductive">has_type_1</span></a> : <a class="idref" href="TImp.html#context"><span class="id" type="definition">context</span></a> → <a class="idref" href="TImp.html#exp"><span class="id" type="inductive">exp</span></a> → <a class="idref" href="TImp.html#ty"><span class="id" type="inductive">ty</span></a> → <span class="id" type="keyword">Prop</span> := <br/>
&nbsp;&nbsp;| <a name="Ty_Var1"><span class="id" type="constructor">Ty_Var1</span></a> : <span style='font-size:120%;'>&forall;</span> <span class="id" type="var">x</span> <span class="id" type="var">T</span> <span class="id" type="var">Gamma</span>, <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="TImp.html#bound_to"><span class="id" type="inductive">bound_to</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a> <a class="idref" href="TImp.html#x"><span class="id" type="variable">x</span></a> <a class="idref" href="TImp.html#T"><span class="id" type="variable">T</span></a> → <a class="idref" href="TImp.html#has_type_1"><span class="id" type="inductive">has_type_1</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a> (<a class="idref" href="TImp.html#EVar"><span class="id" type="constructor">EVar</span></a> <a class="idref" href="TImp.html#x"><span class="id" type="variable">x</span></a>) <a class="idref" href="TImp.html#T"><span class="id" type="variable">T</span></a>.<br/>
</div>

<div class="doc">
To generate <span class="inlinecode"><span class="id" type="var">e</span></span> such that for <span class="inlinecode"><span class="id" type="var">has_type_1</span></span> <span class="inlinecode"><span class="id" type="var">Gamma</span></span> <span class="inlinecode"><span class="id" type="var">e</span></span> <span class="inlinecode"><span class="id" type="var">T</span></span> holds, we
    need to pick one of its constructors (there is only one choice,
    here) and then try to satisfy its preconditions by generating more
    things.  To satisfy <span class="inlinecode"><span class="id" type="var">Ty_Var1</span></span> (given <span class="inlinecode"><span class="id" type="var">Gamma</span></span> and <span class="inlinecode"><span class="id" type="var">T</span></span>), we need to
    generate <span class="inlinecode"><span class="id" type="var">x</span></span> such that <span class="inlinecode"><span class="id" type="var">bound_to</span></span> <span class="inlinecode"><span class="id" type="var">Gamma</span></span> <span class="inlinecode"><span class="id" type="var">x</span></span> <span class="inlinecode"><span class="id" type="var">T</span></span>. But we already have
    such a generator!  We just need to wrap it in an <span class="inlinecode"><span class="id" type="var">EVar</span></span>.  
</div>
<div class="code code-tight">

<span class="id" type="keyword">Definition</span> <a name="gen_typed_evar"><span class="id" type="definition">gen_typed_evar</span></a> (<span class="id" type="var">Gamma</span> : <a class="idref" href="TImp.html#context"><span class="id" type="definition">context</span></a>) (<span class="id" type="var">T</span> : <a class="idref" href="TImp.html#ty"><span class="id" type="inductive">ty</span></a>) : <a class="idref" href="TImp.html#GOpt"><span class="id" type="definition">GOpt</span></a> <a class="idref" href="TImp.html#exp"><span class="id" type="inductive">exp</span></a> :=<br/>
&nbsp;&nbsp;<span class="id" type="var">x</span> &lt;- <a class="idref" href="TImp.html#gen_typed_atom_from_context"><span class="id" type="definition">gen_typed_atom_from_context</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a> <a class="idref" href="TImp.html#T"><span class="id" type="variable">T</span></a>;;<br/>
&nbsp;&nbsp;<span class="id" type="method">ret</span> (<a class="idref" href="TImp.html#EVar"><span class="id" type="constructor">EVar</span></a> <a class="idref" href="TImp.html#x"><span class="id" type="variable">x</span></a>).<br/>
</div>

<div class="doc">
(Note that this is the <span class="inlinecode"><span class="id" type="var">ret</span></span> of the <span class="inlinecode"><span class="id" type="var">GOpt</span></span> monad.) 
<div class="paragraph"> </div>

 Now let's consider a typing relation <span class="inlinecode"><span class="id" type="var">has_type_2</span></span>, extending
    <span class="inlinecode"><span class="id" type="var">has_type_1</span></span> with all of the constructors of <span class="inlinecode"><span class="id" type="var">has_type</span></span> that do
    not recursively require <span class="inlinecode"><span class="id" type="var">has_type</span></span> as a side-condition. These will
    be the <i>base cases</i> for our final generator. 
</div>
<div class="code code-tight">

<span class="id" type="keyword">Inductive</span> <a name="has_type_2"><span class="id" type="inductive">has_type_2</span></a> : <a class="idref" href="TImp.html#context"><span class="id" type="definition">context</span></a> → <a class="idref" href="TImp.html#exp"><span class="id" type="inductive">exp</span></a> → <a class="idref" href="TImp.html#ty"><span class="id" type="inductive">ty</span></a> → <span class="id" type="keyword">Prop</span> :=<br/>
| <a name="Ty_Var2"><span class="id" type="constructor">Ty_Var2</span></a> : <span style='font-size:120%;'>&forall;</span> <span class="id" type="var">x</span> <span class="id" type="var">T</span> <span class="id" type="var">Gamma</span>, <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="TImp.html#bound_to"><span class="id" type="inductive">bound_to</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a> <a class="idref" href="TImp.html#x"><span class="id" type="variable">x</span></a> <a class="idref" href="TImp.html#T"><span class="id" type="variable">T</span></a> → <a class="idref" href="TImp.html#has_type_2"><span class="id" type="inductive">has_type_2</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a> (<a class="idref" href="TImp.html#EVar"><span class="id" type="constructor">EVar</span></a> <a class="idref" href="TImp.html#x"><span class="id" type="variable">x</span></a>) <a class="idref" href="TImp.html#T"><span class="id" type="variable">T</span></a><br/>
| <a name="Ty_Num2"><span class="id" type="constructor">Ty_Num2</span></a> : <span style='font-size:120%;'>&forall;</span> <span class="id" type="var">Gamma</span> <span class="id" type="var">n</span>, <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="TImp.html#has_type_2"><span class="id" type="inductive">has_type_2</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a>  (<a class="idref" href="TImp.html#ENum"><span class="id" type="constructor">ENum</span></a> <a class="idref" href="TImp.html#n"><span class="id" type="variable">n</span></a>) <a class="idref" href="TImp.html#TNat"><span class="id" type="constructor">TNat</span></a><br/>
| <a name="Ty_True2"><span class="id" type="constructor">Ty_True2</span></a> : <span style='font-size:120%;'>&forall;</span> <span class="id" type="var">Gamma</span>, <a class="idref" href="TImp.html#has_type_2"><span class="id" type="inductive">has_type_2</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a> <a class="idref" href="TImp.html#ETrue"><span class="id" type="constructor">ETrue</span></a> <a class="idref" href="TImp.html#TBool"><span class="id" type="constructor">TBool</span></a><br/>
| <a name="Ty_False2"><span class="id" type="constructor">Ty_False2</span></a> : <span style='font-size:120%;'>&forall;</span> <span class="id" type="var">Gamma</span>, <a class="idref" href="TImp.html#has_type_2"><span class="id" type="inductive">has_type_2</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a> <a class="idref" href="TImp.html#EFalse"><span class="id" type="constructor">EFalse</span></a> <a class="idref" href="TImp.html#TBool"><span class="id" type="constructor">TBool</span></a>.<br/>
</div>

<div class="doc">
We can already generate values satisfying <span class="inlinecode"><span class="id" type="var">Ty_Var2</span></span> using
    <span class="inlinecode"><span class="id" type="var">gen_typed_evar</span></span>.  For the rest of the rules, we will need to
    pattern match on the input <span class="inlinecode"><span class="id" type="var">T</span></span>, since <span class="inlinecode"><span class="id" type="var">Ty_Num</span></span> can only be used if
    <span class="inlinecode"><span class="id" type="var">T</span></span> <span class="inlinecode">=</span> <span class="inlinecode"><span class="id" type="var">TNat</span></span>, while <span class="inlinecode"><span class="id" type="var">Ty_True</span></span> and <span class="inlinecode"><span class="id" type="var">Ty_False</span></span> can only be used if <span class="inlinecode"><span class="id" type="var">T</span></span>
    <span class="inlinecode">=</span> <span class="inlinecode"><span class="id" type="var">TBool</span></span>.  
</div>
<div class="code code-tight">

<span class="id" type="keyword">Definition</span> <a name="base'"><span class="id" type="definition">base'</span></a> <span class="id" type="var">Gamma</span> <span class="id" type="var">T</span> : <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#list"><span class="id" type="inductive">list</span></a> (<a class="idref" href="TImp.html#GOpt"><span class="id" type="definition">GOpt</span></a> <a class="idref" href="TImp.html#exp"><span class="id" type="inductive">exp</span></a>) := <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="TImp.html#gen_typed_evar"><span class="id" type="definition">gen_typed_evar</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a> <a class="idref" href="TImp.html#T"><span class="id" type="variable">T</span></a> ::<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <a class="idref" href="TImp.html#T"><span class="id" type="variable">T</span></a> <span class="id" type="keyword">with</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="TImp.html#TNat"><span class="id" type="constructor">TNat</span></a>  ⇒ [ <span class="id" type="var">n</span> &lt;- <span class="id" type="method">arbitrary</span>;; <span class="id" type="method">ret</span> (<a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#Some"><span class="id" type="constructor">Some</span></a> (<a class="idref" href="TImp.html#ENum"><span class="id" type="constructor">ENum</span></a> <a class="idref" href="TImp.html#n"><span class="id" type="variable">n</span></a>))]<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="TImp.html#TBool"><span class="id" type="constructor">TBool</span></a> ⇒ [ <span class="id" type="method">ret</span> <a class="idref" href="TImp.html#ETrue"><span class="id" type="constructor">ETrue</span></a> ; <span class="id" type="method">ret</span> <a class="idref" href="TImp.html#EFalse"><span class="id" type="constructor">EFalse</span></a> ]<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>
</div>

<div class="doc">
We now need to go from a list of (optional) generators to a 
    single generator. We could do that using the <span class="inlinecode"><span class="id" type="var">oneOf</span></span> combinator (which
    chooses uniformly), or the <span class="inlinecode"><span class="id" type="var">frequency</span></span> combinator (by adding weights).

<div class="paragraph"> </div>

    Instead, we will introduce a new one, called <span class="inlinecode"><span class="id" type="var">backtrack</span></span>:

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">backtrack</span>&nbsp;:&nbsp;<span class="id" type="var">list</span>&nbsp;(<span class="id" type="var">nat</span>&nbsp;*&nbsp;<span class="id" type="var">GOpt</span>&nbsp;?<span class="id" type="var">A</span>)&nbsp;→&nbsp;<span class="id" type="var">GOpt</span>&nbsp;?<span class="id" type="var">A</span>
<div class="paragraph"> </div>

</div>

<div class="paragraph"> </div>

 Just like <span class="inlinecode"><span class="id" type="var">frequency</span></span>, <span class="inlinecode"><span class="id" type="var">backtrack</span></span> selects one of the generators
    according to the input weights. Unlike frequency, if the chosen
    generator fails (i.e. produces <span class="inlinecode"><span class="id" type="var">None</span></span>), <span class="inlinecode"><span class="id" type="var">backtrack</span></span> will discard
    it, choose another and keep going until one succeeds or all
    options are exhausted. Our base case generator could then be like
    this: 
</div>
<div class="code code-tight">

<span class="id" type="keyword">Definition</span> <a name="base"><span class="id" type="definition">base</span></a> <span class="id" type="var">Gamma</span> <span class="id" type="var">T</span> := <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(2, <a class="idref" href="TImp.html#gen_typed_evar"><span class="id" type="definition">gen_typed_evar</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a> <a class="idref" href="TImp.html#T"><span class="id" type="variable">T</span></a>) ::<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <a class="idref" href="TImp.html#T"><span class="id" type="variable">T</span></a> <span class="id" type="keyword">with</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="TImp.html#TNat"><span class="id" type="constructor">TNat</span></a>  ⇒ [ (2, <span class="id" type="var">n</span> &lt;- <span class="id" type="method">arbitrary</span>;; <span class="id" type="method">ret</span> (<a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#Some"><span class="id" type="constructor">Some</span></a> (<a class="idref" href="TImp.html#ENum"><span class="id" type="constructor">ENum</span></a> <a class="idref" href="TImp.html#n"><span class="id" type="variable">n</span></a>)))]<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="TImp.html#TBool"><span class="id" type="constructor">TBool</span></a> ⇒ [ (1, <span class="id" type="method">ret</span> <a class="idref" href="TImp.html#ETrue"><span class="id" type="constructor">ETrue</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; (1, <span class="id" type="method">ret</span> <a class="idref" href="TImp.html#EFalse"><span class="id" type="constructor">EFalse</span></a>) ]<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/><hr class='doublespaceincode'/>
<span class="id" type="keyword">Definition</span> <a name="gen_has_type_2"><span class="id" type="definition">gen_has_type_2</span></a> <span class="id" type="var">Gamma</span> <span class="id" type="var">T</span> := <span class="id" type="axiom">backtrack</span> (<a class="idref" href="TImp.html#base"><span class="id" type="definition">base</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a> <a class="idref" href="TImp.html#T"><span class="id" type="variable">T</span></a>).<br/>
</div>

<div class="doc">
To see how we handle recursive rules, let's consider a third
    sub-relation <span class="inlinecode"><span class="id" type="var">has_type_3</span></span>: 
</div>
<div class="code code-tight">

<span class="id" type="keyword">Inductive</span> <a name="has_type_3"><span class="id" type="inductive">has_type_3</span></a> : <a class="idref" href="TImp.html#context"><span class="id" type="definition">context</span></a> → <a class="idref" href="TImp.html#exp"><span class="id" type="inductive">exp</span></a> → <a class="idref" href="TImp.html#ty"><span class="id" type="inductive">ty</span></a> → <span class="id" type="keyword">Prop</span> :=<br/>
&nbsp;| <a name="Ty_Var3"><span class="id" type="constructor">Ty_Var3</span></a> : <span style='font-size:120%;'>&forall;</span> <span class="id" type="var">x</span> <span class="id" type="var">T</span> <span class="id" type="var">Gamma</span>, <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="TImp.html#bound_to"><span class="id" type="inductive">bound_to</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a> <a class="idref" href="TImp.html#x"><span class="id" type="variable">x</span></a> <a class="idref" href="TImp.html#T"><span class="id" type="variable">T</span></a> → <a class="idref" href="TImp.html#has_type_3"><span class="id" type="inductive">has_type_3</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a> (<a class="idref" href="TImp.html#EVar"><span class="id" type="constructor">EVar</span></a> <a class="idref" href="TImp.html#x"><span class="id" type="variable">x</span></a>) <a class="idref" href="TImp.html#T"><span class="id" type="variable">T</span></a><br/>
&nbsp;| <a name="Ty_Plus3"><span class="id" type="constructor">Ty_Plus3</span></a> : <span style='font-size:120%;'>&forall;</span> <span class="id" type="var">Gamma</span> <span class="id" type="var">e<sub>1</sub></span> <span class="id" type="var">e<sub>2</sub></span>, <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="TImp.html#has_type_3"><span class="id" type="inductive">has_type_3</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a> <a class="idref" href="TImp.html#e<sub>1</sub>"><span class="id" type="variable">e<sub>1</sub></span></a> <a class="idref" href="TImp.html#TNat"><span class="id" type="constructor">TNat</span></a> → <a class="idref" href="TImp.html#has_type_3"><span class="id" type="inductive">has_type_3</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a> <a class="idref" href="TImp.html#e<sub>2</sub>"><span class="id" type="variable">e<sub>2</sub></span></a> <a class="idref" href="TImp.html#TNat"><span class="id" type="constructor">TNat</span></a> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="TImp.html#has_type_3"><span class="id" type="inductive">has_type_3</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a> (<a class="idref" href="TImp.html#EPlus"><span class="id" type="constructor">EPlus</span></a> <a class="idref" href="TImp.html#e<sub>1</sub>"><span class="id" type="variable">e<sub>1</sub></span></a> <a class="idref" href="TImp.html#e<sub>2</sub>"><span class="id" type="variable">e<sub>2</sub></span></a>) <a class="idref" href="TImp.html#TNat"><span class="id" type="constructor">TNat</span></a>.<br/>
</div>

<div class="doc">
Typing derivations involving <span class="inlinecode"><span class="id" type="var">EPlus</span></span> nodes are binary trees, so we
    need to add a <span class="inlinecode"><span class="id" type="var">size</span></span> parameter to enforce termination. The base
    case (<span class="inlinecode"><span class="id" type="var">Ty_Var3</span></span>) is handled using <span class="inlinecode"><span class="id" type="var">gen_typed_evar</span></span> just like
    before.  The non-base case can choose between trying to generate
    <span class="inlinecode"><span class="id" type="var">Ty_Var3</span></span> and trying to generate <span class="inlinecode"><span class="id" type="var">Ty_Plus3</span></span>. For the latter, the
    input type <span class="inlinecode"><span class="id" type="var">T</span></span> must be <span class="inlinecode"><span class="id" type="var">TNat</span></span>, otherwise it is not
    applicable. Once again, this leads to a match on <span class="inlinecode"><span class="id" type="var">T</span></span>: 
</div>
<div class="code code-tight">

<span class="id" type="keyword">Fixpoint</span> <a name="gen_has_type_3"><span class="id" type="definition">gen_has_type_3</span></a> <span class="id" type="var">size</span> <span class="id" type="var">Gamma</span> <span class="id" type="var">T</span> : <a class="idref" href="TImp.html#GOpt"><span class="id" type="definition">GOpt</span></a> <a class="idref" href="TImp.html#exp"><span class="id" type="inductive">exp</span></a> := <br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <a class="idref" href="TImp.html#size"><span class="id" type="variable">size</span></a> <span class="id" type="keyword">with</span> <br/>
&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#O"><span class="id" type="constructor">O</span></a> ⇒ <a class="idref" href="TImp.html#gen_typed_evar"><span class="id" type="definition">gen_typed_evar</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a> <a class="idref" href="TImp.html#T"><span class="id" type="variable">T</span></a><br/>
&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#S"><span class="id" type="constructor">S</span></a> <span class="id" type="var">size'</span> ⇒ <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="axiom">backtrack</span> ([ (1, <a class="idref" href="TImp.html#gen_typed_evar"><span class="id" type="definition">gen_typed_evar</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a> <a class="idref" href="TImp.html#T"><span class="id" type="variable">T</span></a>) ] <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++ <span class="id" type="keyword">match</span> <a class="idref" href="TImp.html#T"><span class="id" type="variable">T</span></a> <span class="id" type="keyword">with</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="TImp.html#TNat"><span class="id" type="constructor">TNat</span></a> ⇒ <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[ (<a class="idref" href="TImp.html#size"><span class="id" type="variable">size</span></a>, <span class="id" type="var">e<sub>1</sub></span> &lt;- <a class="idref" href="TImp.html#gen_has_type_3"><span class="id" type="definition">gen_has_type_3</span></a> <span class="id" type="var">size'</span> <a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a> <a class="idref" href="TImp.html#TNat"><span class="id" type="constructor">TNat</span></a>;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">e<sub>2</sub></span> &lt;- <a class="idref" href="TImp.html#gen_has_type_3"><span class="id" type="definition">gen_has_type_3</span></a> <span class="id" type="var">size'</span> <a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a> <a class="idref" href="TImp.html#TNat"><span class="id" type="constructor">TNat</span></a>;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="method">ret</span> (<a class="idref" href="TImp.html#EPlus"><span class="id" type="constructor">EPlus</span></a> <a class="idref" href="TImp.html#e<sub>1</sub>"><span class="id" type="variable">e<sub>1</sub></span></a> <a class="idref" href="TImp.html#e<sub>2</sub>"><span class="id" type="variable">e<sub>2</sub></span></a>)) ]<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">_</span> ⇒ []<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>)<br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>
</div>

<div class="doc">
Putting all this together, we get the full generator for
    well-typed expressions. 
</div>
<div class="code code-tight">

<span class="id" type="keyword">Fixpoint</span> <a name="gen_exp_typed_sized"><span class="id" type="definition">gen_exp_typed_sized</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">size</span> : <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nat"><span class="id" type="inductive">nat</span></a>) (<span class="id" type="var">Gamma</span> : <a class="idref" href="TImp.html#context"><span class="id" type="definition">context</span></a>) (<span class="id" type="var">T</span> : <a class="idref" href="TImp.html#ty"><span class="id" type="inductive">ty</span></a>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;: <a class="idref" href="TImp.html#GOpt"><span class="id" type="definition">GOpt</span></a> <a class="idref" href="TImp.html#exp"><span class="id" type="inductive">exp</span></a> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">let</span> <span class="id" type="var">base</span> := <a class="idref" href="TImp.html#base"><span class="id" type="definition">base</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a> <a class="idref" href="TImp.html#T"><span class="id" type="variable">T</span></a> <span class="id" type="keyword">in</span><br/>
&nbsp;&nbsp;<span class="id" type="keyword">let</span> <span class="id" type="var">recs</span> <span class="id" type="var">size'</span> := <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <a class="idref" href="TImp.html#T"><span class="id" type="variable">T</span></a> <span class="id" type="keyword">with</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="TImp.html#TNat"><span class="id" type="constructor">TNat</span></a> ⇒ [ (<a class="idref" href="TImp.html#size"><span class="id" type="variable">size</span></a>, <span class="id" type="var">e<sub>1</sub></span> &lt;- <a class="idref" href="TImp.html#gen_exp_typed_sized"><span class="id" type="definition">gen_exp_typed_sized</span></a> <a class="idref" href="TImp.html#size'"><span class="id" type="variable">size'</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a> <a class="idref" href="TImp.html#TNat"><span class="id" type="constructor">TNat</span></a> ;; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">e<sub>2</sub></span> &lt;- <a class="idref" href="TImp.html#gen_exp_typed_sized"><span class="id" type="definition">gen_exp_typed_sized</span></a> <a class="idref" href="TImp.html#size'"><span class="id" type="variable">size'</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a> <a class="idref" href="TImp.html#TNat"><span class="id" type="constructor">TNat</span></a> ;; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="method">ret</span> (<a class="idref" href="TImp.html#EPlus"><span class="id" type="constructor">EPlus</span></a> <a class="idref" href="TImp.html#e<sub>1</sub>"><span class="id" type="variable">e<sub>1</sub></span></a> <a class="idref" href="TImp.html#e<sub>2</sub>"><span class="id" type="variable">e<sub>2</sub></span></a>)) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; (<a class="idref" href="TImp.html#size"><span class="id" type="variable">size</span></a>, <span class="id" type="var">e<sub>1</sub></span> &lt;- <a class="idref" href="TImp.html#gen_exp_typed_sized"><span class="id" type="definition">gen_exp_typed_sized</span></a> <a class="idref" href="TImp.html#size'"><span class="id" type="variable">size'</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a> <a class="idref" href="TImp.html#TNat"><span class="id" type="constructor">TNat</span></a> ;; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">e<sub>2</sub></span> &lt;- <a class="idref" href="TImp.html#gen_exp_typed_sized"><span class="id" type="definition">gen_exp_typed_sized</span></a> <a class="idref" href="TImp.html#size'"><span class="id" type="variable">size'</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a> <a class="idref" href="TImp.html#TNat"><span class="id" type="constructor">TNat</span></a> ;; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="method">ret</span> (<a class="idref" href="TImp.html#EMinus"><span class="id" type="constructor">EMinus</span></a> <a class="idref" href="TImp.html#e<sub>1</sub>"><span class="id" type="variable">e<sub>1</sub></span></a> <a class="idref" href="TImp.html#e<sub>2</sub>"><span class="id" type="variable">e<sub>2</sub></span></a>)) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; (<a class="idref" href="TImp.html#size"><span class="id" type="variable">size</span></a>, <span class="id" type="var">e<sub>1</sub></span> &lt;- <a class="idref" href="TImp.html#gen_exp_typed_sized"><span class="id" type="definition">gen_exp_typed_sized</span></a> <a class="idref" href="TImp.html#size'"><span class="id" type="variable">size'</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a> <a class="idref" href="TImp.html#TNat"><span class="id" type="constructor">TNat</span></a> ;; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">e<sub>2</sub></span> &lt;- <a class="idref" href="TImp.html#gen_exp_typed_sized"><span class="id" type="definition">gen_exp_typed_sized</span></a> <a class="idref" href="TImp.html#size'"><span class="id" type="variable">size'</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a> <a class="idref" href="TImp.html#TNat"><span class="id" type="constructor">TNat</span></a> ;; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="method">ret</span> (<a class="idref" href="TImp.html#EMult"><span class="id" type="constructor">EMult</span></a> <a class="idref" href="TImp.html#e<sub>1</sub>"><span class="id" type="variable">e<sub>1</sub></span></a> <a class="idref" href="TImp.html#e<sub>2</sub>"><span class="id" type="variable">e<sub>2</sub></span></a>)) ]<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="TImp.html#TBool"><span class="id" type="constructor">TBool</span></a> ⇒ [ (<a class="idref" href="TImp.html#size"><span class="id" type="variable">size</span></a>, <span class="id" type="var">e<sub>1</sub></span> &lt;- <a class="idref" href="TImp.html#gen_exp_typed_sized"><span class="id" type="definition">gen_exp_typed_sized</span></a> <a class="idref" href="TImp.html#size'"><span class="id" type="variable">size'</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a> <a class="idref" href="TImp.html#TNat"><span class="id" type="constructor">TNat</span></a> ;; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">e<sub>2</sub></span> &lt;- <a class="idref" href="TImp.html#gen_exp_typed_sized"><span class="id" type="definition">gen_exp_typed_sized</span></a> <a class="idref" href="TImp.html#size'"><span class="id" type="variable">size'</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a> <a class="idref" href="TImp.html#TNat"><span class="id" type="constructor">TNat</span></a> ;; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="method">ret</span> (<a class="idref" href="TImp.html#EEq"><span class="id" type="constructor">EEq</span></a> <a class="idref" href="TImp.html#e<sub>1</sub>"><span class="id" type="variable">e<sub>1</sub></span></a> <a class="idref" href="TImp.html#e<sub>2</sub>"><span class="id" type="variable">e<sub>2</sub></span></a>)) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; (<a class="idref" href="TImp.html#size"><span class="id" type="variable">size</span></a>, <span class="id" type="var">e<sub>1</sub></span> &lt;- <a class="idref" href="TImp.html#gen_exp_typed_sized"><span class="id" type="definition">gen_exp_typed_sized</span></a> <a class="idref" href="TImp.html#size'"><span class="id" type="variable">size'</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a> <a class="idref" href="TImp.html#TNat"><span class="id" type="constructor">TNat</span></a> ;; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">e<sub>2</sub></span> &lt;- <a class="idref" href="TImp.html#gen_exp_typed_sized"><span class="id" type="definition">gen_exp_typed_sized</span></a> <a class="idref" href="TImp.html#size'"><span class="id" type="variable">size'</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a> <a class="idref" href="TImp.html#TNat"><span class="id" type="constructor">TNat</span></a> ;; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="method">ret</span> (<a class="idref" href="TImp.html#ELe"><span class="id" type="constructor">ELe</span></a> <a class="idref" href="TImp.html#e<sub>1</sub>"><span class="id" type="variable">e<sub>1</sub></span></a> <a class="idref" href="TImp.html#e<sub>2</sub>"><span class="id" type="variable">e<sub>2</sub></span></a>)) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; (<a class="idref" href="TImp.html#size"><span class="id" type="variable">size</span></a>, <span class="id" type="var">e<sub>1</sub></span> &lt;- <a class="idref" href="TImp.html#gen_exp_typed_sized"><span class="id" type="definition">gen_exp_typed_sized</span></a> <a class="idref" href="TImp.html#size'"><span class="id" type="variable">size'</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a> <a class="idref" href="TImp.html#TBool"><span class="id" type="constructor">TBool</span></a> ;; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="method">ret</span> (<a class="idref" href="TImp.html#ENot"><span class="id" type="constructor">ENot</span></a> <a class="idref" href="TImp.html#e<sub>1</sub>"><span class="id" type="variable">e<sub>1</sub></span></a>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;; (<a class="idref" href="TImp.html#size"><span class="id" type="variable">size</span></a>, <span class="id" type="var">e<sub>1</sub></span> &lt;- <a class="idref" href="TImp.html#gen_exp_typed_sized"><span class="id" type="definition">gen_exp_typed_sized</span></a> <a class="idref" href="TImp.html#size'"><span class="id" type="variable">size'</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a> <a class="idref" href="TImp.html#TBool"><span class="id" type="constructor">TBool</span></a> ;; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">e<sub>2</sub></span> &lt;- <a class="idref" href="TImp.html#gen_exp_typed_sized"><span class="id" type="definition">gen_exp_typed_sized</span></a> <a class="idref" href="TImp.html#size'"><span class="id" type="variable">size'</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a> <a class="idref" href="TImp.html#TBool"><span class="id" type="constructor">TBool</span></a> ;; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="method">ret</span> (<a class="idref" href="TImp.html#EAnd"><span class="id" type="constructor">EAnd</span></a> <a class="idref" href="TImp.html#e<sub>1</sub>"><span class="id" type="variable">e<sub>1</sub></span></a> <a class="idref" href="TImp.html#e<sub>2</sub>"><span class="id" type="variable">e<sub>2</sub></span></a>)) ]<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span> <span class="id" type="keyword">in</span><br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <a class="idref" href="TImp.html#size"><span class="id" type="variable">size</span></a> <span class="id" type="keyword">with</span> <br/>
&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#O"><span class="id" type="constructor">O</span></a> ⇒ <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="axiom">backtrack</span> <a class="idref" href="TImp.html#base"><span class="id" type="variable">base</span></a> <br/>
&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#S"><span class="id" type="constructor">S</span></a> <span class="id" type="var">size'</span> ⇒ <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="axiom">backtrack</span> (<a class="idref" href="TImp.html#base"><span class="id" type="variable">base</span></a> ++ <a class="idref" href="TImp.html#recs"><span class="id" type="variable">recs</span></a> <span class="id" type="var">size'</span>)<br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>
</div>

<div class="doc">
When writing such complex generators, it's good to have some tests
    to verify that we are generating what we expect. For example, here
    we would expect <span class="inlinecode"><span class="id" type="var">gen_exp_typed_sized</span></span> to always return expressions
    that are well typed.

<div class="paragraph"> </div>

    We can use <span class="inlinecode"><span class="id" type="var">forAll</span></span> to encode such a property. 
</div>
<div class="code code-tight">

<span class="id" type="keyword">Definition</span> <a name="gen_typed_has_type"><span class="id" type="definition">gen_typed_has_type</span></a> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">let</span> <span class="id" type="var">num_vars</span> := 4 <span class="id" type="keyword">in</span><br/>
&nbsp;&nbsp;<span class="id" type="keyword">let</span> <span class="id" type="var">top_level_size</span> := 3 <span class="id" type="keyword">in</span> <br/>
&nbsp;&nbsp;<span class="id" type="definition">forAll</span> (<a class="idref" href="TImp.html#gen_context"><span class="id" type="definition">gen_context</span></a> <a class="idref" href="TImp.html#num_vars"><span class="id" type="variable">num_vars</span></a>) (<span class="id" type="keyword">fun</span> <span class="id" type="var">Gamma</span> ⇒<br/>
&nbsp;&nbsp;<span class="id" type="definition">forAll</span> <span class="id" type="method">arbitrary</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">T</span> ⇒                                   <br/>
&nbsp;&nbsp;<span class="id" type="definition">forAll</span> (<a class="idref" href="TImp.html#gen_exp_typed_sized"><span class="id" type="definition">gen_exp_typed_sized</span></a> <a class="idref" href="TImp.html#top_level_size"><span class="id" type="variable">top_level_size</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a> <a class="idref" href="TImp.html#T"><span class="id" type="variable">T</span></a>) (<span class="id" type="keyword">fun</span> <span class="id" type="var">me</span> ⇒<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <a class="idref" href="TImp.html#me"><span class="id" type="variable">me</span></a> <span class="id" type="keyword">with</span> <br/>
&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#Some"><span class="id" type="constructor">Some</span></a> <span class="id" type="var">e</span> ⇒ (<a class="idref" href="TImp.html#has_type"><span class="id" type="inductive">has_type</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a> <span class="id" type="var">e</span> <a class="idref" href="TImp.html#T"><span class="id" type="variable">T</span></a>)?<br/>
&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#None"><span class="id" type="constructor">None</span></a> ⇒ <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#false"><span class="id" type="constructor">false</span></a> <br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>))).<br/><hr class='doublespaceincode'/>
<span class="comment">(*&nbsp;QuickChick&nbsp;gen_typed_has_type.&nbsp;*)</span><br/>
</div>

<div class="doc">
<a name="lab82"></a><h1 class="section">Values and States</h1>

<div class="paragraph"> </div>

<a name="lab83"></a><h2 class="section">Values</h2>

<div class="paragraph"> </div>

 In original Imp, variables range over natural numbers, so states were just
    maps from identifiers to <span class="inlinecode"><span class="id" type="var">nat</span></span>. Since we wanted to extend this to also 
    include booleans, we need a type of <span class="inlinecode"><span class="id" type="var">value</span></span>s that includes both. 
</div>
<div class="code code-tight">

<span class="id" type="keyword">Inductive</span> <a name="value"><span class="id" type="inductive">value</span></a> := <a name="VNat"><span class="id" type="constructor">VNat</span></a> : <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nat"><span class="id" type="inductive">nat</span></a> → <a class="idref" href="TImp.html#value"><span class="id" type="inductive">value</span></a> | <a name="VBool"><span class="id" type="constructor">VBool</span></a> : <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#bool"><span class="id" type="inductive">bool</span></a> → <a class="idref" href="TImp.html#value"><span class="id" type="inductive">value</span></a>.<br/><hr class='doublespaceincode'/>
<span class="id" type="var">Derive</span> <span class="id" type="keyword">Show</span> <span class="id" type="keyword">for</span> <span class="id" type="var">value</span>.<br/>
</div>

<div class="doc">
We can also quickly define a typing relation for values, a Dec instance
    for it and a generator for values of a given type. 
</div>
<div class="code code-tight">

<span class="id" type="keyword">Inductive</span> <a name="has_type_value"><span class="id" type="inductive">has_type_value</span></a> : <a class="idref" href="TImp.html#value"><span class="id" type="inductive">value</span></a> → <a class="idref" href="TImp.html#ty"><span class="id" type="inductive">ty</span></a> → <span class="id" type="keyword">Prop</span> :=<br/>
&nbsp;&nbsp;| <a name="TyVNat"><span class="id" type="constructor">TyVNat</span></a>  : <span style='font-size:120%;'>&forall;</span> <span class="id" type="var">n</span>, <a class="idref" href="TImp.html#has_type_value"><span class="id" type="inductive">has_type_value</span></a> (<a class="idref" href="TImp.html#VNat"><span class="id" type="constructor">VNat</span></a>  <a class="idref" href="TImp.html#n"><span class="id" type="variable">n</span></a>) <a class="idref" href="TImp.html#TNat"><span class="id" type="constructor">TNat</span></a><br/>
&nbsp;&nbsp;| <a name="TyVBool"><span class="id" type="constructor">TyVBool</span></a> : <span style='font-size:120%;'>&forall;</span> <span class="id" type="var">b</span>, <a class="idref" href="TImp.html#has_type_value"><span class="id" type="inductive">has_type_value</span></a> (<a class="idref" href="TImp.html#VBool"><span class="id" type="constructor">VBool</span></a> <a class="idref" href="TImp.html#b"><span class="id" type="variable">b</span></a>) <a class="idref" href="TImp.html#TBool"><span class="id" type="constructor">TBool</span></a>.<br/><hr class='doublespaceincode'/>
<span class="id" type="keyword">Instance</span> <a name="dec_has_type_value"><span class="id" type="instance">dec_has_type_value</span></a> <span class="id" type="var">v</span> <span class="id" type="var">T</span> : <span class="id" type="class">Dec</span> (<a class="idref" href="TImp.html#has_type_value"><span class="id" type="inductive">has_type_value</span></a> <a class="idref" href="TImp.html#v"><span class="id" type="variable">v</span></a> <a class="idref" href="TImp.html#T"><span class="id" type="variable">T</span></a>).<br/>
<div class="togglescript" id="proofcontrol3" onclick="toggleDisplay('proof3');toggleDisplay('proofcontrol3')"><span class="show"></span></div>
<div class="proofscript" id="proof3" onclick="toggleDisplay('proof3');toggleDisplay('proofcontrol3')">
<span class="id" type="keyword">Proof</span>. <span class="id" type="var">constructor</span>; <span class="id" type="tactic">unfold</span> <a class="idref" href="http://coq.inria.fr/library/Coq.ssr.ssrbool.html#decidable"><span class="id" type="definition">ssrbool.decidable</span></a>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">v</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">T</span>; <span class="id" type="var">solve_sum</span>.<br/>
<span class="id" type="keyword">Defined</span>.<br/>
</div>

<br/>
<span class="id" type="keyword">Definition</span> <a name="gen_typed_value"><span class="id" type="definition">gen_typed_value</span></a> (<span class="id" type="var">T</span> : <a class="idref" href="TImp.html#ty"><span class="id" type="inductive">ty</span></a>) : <span class="id" type="axiom">G</span> <a class="idref" href="TImp.html#value"><span class="id" type="inductive">value</span></a> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <a class="idref" href="TImp.html#T"><span class="id" type="variable">T</span></a> <span class="id" type="keyword">with</span> <br/>
&nbsp;&nbsp;| <a class="idref" href="TImp.html#TNat"><span class="id" type="constructor">TNat</span></a>  ⇒ <span class="id" type="var">n</span> &lt;- <span class="id" type="method">arbitrary</span>;; <span class="id" type="method">ret</span> (<a class="idref" href="TImp.html#VNat"><span class="id" type="constructor">VNat</span></a> <a class="idref" href="TImp.html#n"><span class="id" type="variable">n</span></a>)<br/>
&nbsp;&nbsp;| <a class="idref" href="TImp.html#TBool"><span class="id" type="constructor">TBool</span></a> ⇒ <span class="id" type="var">b</span> &lt;- <span class="id" type="method">arbitrary</span>;; <span class="id" type="method">ret</span> (<a class="idref" href="TImp.html#VBool"><span class="id" type="constructor">VBool</span></a> <a class="idref" href="TImp.html#b"><span class="id" type="variable">b</span></a>)<br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>
</div>

<div class="doc">
<a name="lab84"></a><h2 class="section">States</h2>

<div class="paragraph"> </div>

 <i>States</i> in TImp are just maps from atoms to values 
</div>
<div class="code code-tight">

<span class="id" type="keyword">Definition</span> <a name="state"><span class="id" type="definition">state</span></a> := @<a class="idref" href="TImp.html#t"><span class="id" type="definition">AtomMap.t</span></a> <a class="idref" href="TImp.html#value"><span class="id" type="inductive">value</span></a>.<br/>
</div>

<div class="doc">
We introduce an inductive relation that specifies when a state is
    welltyped in a context (that is, when all of its variables are
    mapped to values of appropriate types).

<div class="paragraph"> </div>

    We encode this in an element-by-element style inductive relation:
    empty states are only well typed in respect to an empty context,
    while non-empty states need to map their head atom to a value of
    the appropriate type and their tails must also be well typed. 
</div>
<div class="code code-tight">

<span class="id" type="keyword">Inductive</span> <a name="well_typed_state"><span class="id" type="inductive">well_typed_state</span></a> : <a class="idref" href="TImp.html#context"><span class="id" type="definition">context</span></a> → <a class="idref" href="TImp.html#state"><span class="id" type="definition">state</span></a> → <span class="id" type="keyword">Prop</span> :=<br/>
| <a name="TS_Empty"><span class="id" type="constructor">TS_Empty</span></a> : <a class="idref" href="TImp.html#well_typed_state"><span class="id" type="inductive">well_typed_state</span></a> <a class="idref" href="TImp.html#empty"><span class="id" type="definition">AtomMap.empty</span></a> <a class="idref" href="TImp.html#empty"><span class="id" type="definition">AtomMap.empty</span></a><br/>
| <a name="TS_Elem"><span class="id" type="constructor">TS_Elem</span></a>  : <span style='font-size:120%;'>&forall;</span> <span class="id" type="var">x</span> <span class="id" type="var">v</span> <span class="id" type="var">T</span> <span class="id" type="var">st</span> <span class="id" type="var">Gamma</span>, <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="TImp.html#has_type_value"><span class="id" type="inductive">has_type_value</span></a> <a class="idref" href="TImp.html#v"><span class="id" type="variable">v</span></a> <a class="idref" href="TImp.html#T"><span class="id" type="variable">T</span></a> → <a class="idref" href="TImp.html#well_typed_state"><span class="id" type="inductive">well_typed_state</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a> <a class="idref" href="TImp.html#st"><span class="id" type="variable">st</span></a> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="TImp.html#well_typed_state"><span class="id" type="inductive">well_typed_state</span></a> ((<a class="idref" href="TImp.html#x"><span class="id" type="variable">x</span></a>,<a class="idref" href="TImp.html#T"><span class="id" type="variable">T</span></a>)::<a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a>) ((<a class="idref" href="TImp.html#x"><span class="id" type="variable">x</span></a>,<a class="idref" href="TImp.html#v"><span class="id" type="variable">v</span></a>)::<a class="idref" href="TImp.html#st"><span class="id" type="variable">st</span></a>).<br/><hr class='doublespaceincode'/>
<span class="id" type="keyword">Instance</span> <a name="dec_well_typed_state"><span class="id" type="instance">dec_well_typed_state</span></a> <span class="id" type="var">Gamma</span> <span class="id" type="var">st</span> : <span class="id" type="class">Dec</span> (<a class="idref" href="TImp.html#well_typed_state"><span class="id" type="inductive">well_typed_state</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a> <a class="idref" href="TImp.html#st"><span class="id" type="variable">st</span></a>).<br/>
<div class="togglescript" id="proofcontrol4" onclick="toggleDisplay('proof4');toggleDisplay('proofcontrol4')"><span class="show"></span></div>
<div class="proofscript" id="proof4" onclick="toggleDisplay('proof4');toggleDisplay('proofcontrol4')">
<span class="id" type="keyword">Proof</span>.<br/>
<span class="id" type="var">constructor</span>; <span class="id" type="tactic">unfold</span> <a class="idref" href="http://coq.inria.fr/library/Coq.ssr.ssrbool.html#decidable"><span class="id" type="definition">ssrbool.decidable</span></a>.<br/>
<span class="id" type="tactic">generalize</span> <span class="id" type="tactic">dependent</span> <span class="id" type="var">Gamma</span>.<br/>
<span class="id" type="tactic">induction</span> <span class="id" type="var">st</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">Gamma</span>; <span class="id" type="var">solve_sum</span>.<br/>
<span class="id" type="tactic">destruct</span> <span class="id" type="var">a</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">a</span> <span class="id" type="var">v</span>]; <span class="id" type="tactic">destruct</span> <span class="id" type="var">p</span> <span class="id" type="keyword">as</span> [<span class="id" type="var">a'</span> <span class="id" type="var">T</span>].<br/>
<span class="id" type="tactic">destruct</span> (<a class="idref" href="TImp.html#eq_dec"><span class="id" type="axiom">Atom.eq_dec</span></a> <span class="id" type="var">a</span> <span class="id" type="var">a'</span>); <span class="id" type="var">solve_sum</span>.<br/>
<span class="id" type="tactic">subst</span>; <span class="id" type="var">specialize</span> (<span class="id" type="var">IHst</span> <span class="id" type="var">Gamma</span>); <span class="id" type="tactic">destruct</span> <span class="id" type="var">IHst</span>; <span class="id" type="var">solve_sum</span>.<br/>
<span class="id" type="tactic">destruct</span> (<a class="idref" href="TImp.html#dec_has_type_value"><span class="id" type="instance">dec_has_type_value</span></a> <span class="id" type="var">v</span> <span class="id" type="var">T</span>); <span class="id" type="tactic">destruct</span> <span class="id" type="var">dec</span>; <span class="id" type="var">solve_sum</span>.<br/>
<span class="id" type="keyword">Defined</span>.<br/>
</div>
</div>

<div class="doc">
To write a generator for well-typed states given a context <span class="inlinecode"><span class="id" type="var">Gamma</span></span>, 
    we use the combinator <span class="inlinecode"><span class="id" type="var">sequenceGen</span></span> <span class="inlinecode">:</span> <span class="inlinecode"><span class="id" type="var">list</span></span> <span class="inlinecode">(<span class="id" type="var">G</span></span> <span class="inlinecode"><span class="id" type="var">A</span>)</span> <span class="inlinecode">→</span> <span class="inlinecode"><span class="id" type="var">G</span></span> <span class="inlinecode">(<span class="id" type="var">list</span></span> <span class="inlinecode"><span class="id" type="var">A</span>)</span>, which
    receives a list of generators and produces a generator of lists. 

<div class="paragraph"> </div>

    We just need to iterate (<span class="inlinecode"><span class="id" type="var">map</span></span>) through the context, producing
    an arbitrary value of the appropriate type for each pair <span class="inlinecode">(<span class="id" type="var">x</span>,<span class="id" type="var">T</span>)</span>. The 
    <span class="inlinecode"><span class="id" type="var">sequenceGen</span></span> combinator will then chain all those generators in 
    sequence, producing a generator for well-typed states 
</div>
<div class="code code-tight">

<span class="id" type="keyword">Definition</span> <a name="gen_well_typed_state"><span class="id" type="definition">gen_well_typed_state</span></a> (<span class="id" type="var">Gamma</span> : <a class="idref" href="TImp.html#context"><span class="id" type="definition">context</span></a>) : <span class="id" type="axiom">G</span> <a class="idref" href="TImp.html#state"><span class="id" type="definition">state</span></a> := <br/>
&nbsp;&nbsp;<span class="id" type="axiom">sequenceGen</span> (<a class="idref" href="http://coq.inria.fr/library/Coq.Lists.List.html#map"><span class="id" type="definition">List.map</span></a> (<span class="id" type="keyword">fun</span> '(<span class="id" type="var">x</span>, <span class="id" type="var">T</span>) ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">v</span> &lt;- <a class="idref" href="TImp.html#gen_typed_value"><span class="id" type="definition">gen_typed_value</span></a> <a class="idref" href="TImp.html#T"><span class="id" type="variable">T</span></a>;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="method">ret</span> (<a class="idref" href="TImp.html#x"><span class="id" type="variable">x</span></a>, <a class="idref" href="TImp.html#v"><span class="id" type="variable">v</span></a>)) <a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a>).<br/>
</div>

<div class="doc">
<a name="lab85"></a><h1 class="section">Evaluation</h1>

<div class="paragraph"> </div>

 The evaluation function takes a state and an expression and
    returns an optional value, which can be <span class="inlinecode"><span class="id" type="var">None</span></span> if the expression
    encounters a dynamic type error. 
</div>
<div class="code code-tight">

<span class="id" type="keyword">Fixpoint</span> <a name="eval"><span class="id" type="definition">eval</span></a> (<span class="id" type="var">st</span> : <a class="idref" href="TImp.html#state"><span class="id" type="definition">state</span></a>) (<span class="id" type="var">e</span> : <a class="idref" href="TImp.html#exp"><span class="id" type="inductive">exp</span></a>) : <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#option"><span class="id" type="inductive">option</span></a> <a class="idref" href="TImp.html#value"><span class="id" type="inductive">value</span></a> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <a class="idref" href="TImp.html#e"><span class="id" type="variable">e</span></a> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;| <a class="idref" href="TImp.html#EVar"><span class="id" type="constructor">EVar</span></a> <span class="id" type="var">x</span> ⇒ <a class="idref" href="TImp.html#get"><span class="id" type="definition">AtomMap.get</span></a> <a class="idref" href="TImp.html#st"><span class="id" type="variable">st</span></a> <span class="id" type="var">x</span><br/>
&nbsp;&nbsp;| <a class="idref" href="TImp.html#ENum"><span class="id" type="constructor">ENum</span></a> <span class="id" type="var">n</span> ⇒ <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#Some"><span class="id" type="constructor">Some</span></a> (<a class="idref" href="TImp.html#VNat"><span class="id" type="constructor">VNat</span></a> <span class="id" type="var">n</span>)<br/>
&nbsp;&nbsp;| <a class="idref" href="TImp.html#EPlus"><span class="id" type="constructor">EPlus</span></a> <span class="id" type="var">e<sub>1</sub></span> <span class="id" type="var">e<sub>2</sub></span> ⇒ <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <a class="idref" href="TImp.html#eval"><span class="id" type="definition">eval</span></a> <a class="idref" href="TImp.html#st"><span class="id" type="variable">st</span></a> <span class="id" type="var">e<sub>1</sub></span>, <a class="idref" href="TImp.html#eval"><span class="id" type="definition">eval</span></a> <a class="idref" href="TImp.html#st"><span class="id" type="variable">st</span></a> <span class="id" type="var">e<sub>2</sub></span> <span class="id" type="keyword">with</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#Some"><span class="id" type="constructor">Some</span></a> (<a class="idref" href="TImp.html#VNat"><span class="id" type="constructor">VNat</span></a> <span class="id" type="var">n<sub>1</sub></span>), <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#Some"><span class="id" type="constructor">Some</span></a> (<a class="idref" href="TImp.html#VNat"><span class="id" type="constructor">VNat</span></a> <span class="id" type="var">n<sub>2</sub></span>) ⇒ <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#Some"><span class="id" type="constructor">Some</span></a> (<a class="idref" href="TImp.html#VNat"><span class="id" type="constructor">VNat</span></a> (<span class="id" type="var">n<sub>1</sub></span> + <span class="id" type="var">n<sub>2</sub></span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">_</span>, <span class="id" type="var">_</span> ⇒ <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#None"><span class="id" type="constructor">None</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span> <br/>
&nbsp;&nbsp;| <a class="idref" href="TImp.html#EMinus"><span class="id" type="constructor">EMinus</span></a> <span class="id" type="var">e<sub>1</sub></span> <span class="id" type="var">e<sub>2</sub></span> ⇒ <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <a class="idref" href="TImp.html#eval"><span class="id" type="definition">eval</span></a> <a class="idref" href="TImp.html#st"><span class="id" type="variable">st</span></a> <span class="id" type="var">e<sub>1</sub></span>, <a class="idref" href="TImp.html#eval"><span class="id" type="definition">eval</span></a> <a class="idref" href="TImp.html#st"><span class="id" type="variable">st</span></a> <span class="id" type="var">e<sub>2</sub></span> <span class="id" type="keyword">with</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#Some"><span class="id" type="constructor">Some</span></a> (<a class="idref" href="TImp.html#VNat"><span class="id" type="constructor">VNat</span></a> <span class="id" type="var">n<sub>1</sub></span>), <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#Some"><span class="id" type="constructor">Some</span></a> (<a class="idref" href="TImp.html#VNat"><span class="id" type="constructor">VNat</span></a> <span class="id" type="var">n<sub>2</sub></span>) ⇒ <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#Some"><span class="id" type="constructor">Some</span></a> (<a class="idref" href="TImp.html#VNat"><span class="id" type="constructor">VNat</span></a> (<span class="id" type="var">n<sub>1</sub></span> - <span class="id" type="var">n<sub>2</sub></span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">_</span>, <span class="id" type="var">_</span> ⇒ <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#None"><span class="id" type="constructor">None</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span><br/>
&nbsp;&nbsp;| <a class="idref" href="TImp.html#EMult"><span class="id" type="constructor">EMult</span></a> <span class="id" type="var">e<sub>1</sub></span> <span class="id" type="var">e<sub>2</sub></span> ⇒ <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <a class="idref" href="TImp.html#eval"><span class="id" type="definition">eval</span></a> <a class="idref" href="TImp.html#st"><span class="id" type="variable">st</span></a> <span class="id" type="var">e<sub>1</sub></span>, <a class="idref" href="TImp.html#eval"><span class="id" type="definition">eval</span></a> <a class="idref" href="TImp.html#st"><span class="id" type="variable">st</span></a> <span class="id" type="var">e<sub>2</sub></span> <span class="id" type="keyword">with</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#Some"><span class="id" type="constructor">Some</span></a> (<a class="idref" href="TImp.html#VNat"><span class="id" type="constructor">VNat</span></a> <span class="id" type="var">n<sub>1</sub></span>), <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#Some"><span class="id" type="constructor">Some</span></a> (<a class="idref" href="TImp.html#VNat"><span class="id" type="constructor">VNat</span></a> <span class="id" type="var">n<sub>2</sub></span>) ⇒ <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#Some"><span class="id" type="constructor">Some</span></a> (<a class="idref" href="TImp.html#VNat"><span class="id" type="constructor">VNat</span></a> (<span class="id" type="var">n<sub>1</sub></span> * <span class="id" type="var">n<sub>2</sub></span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">_</span>, <span class="id" type="var">_</span> ⇒ <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#None"><span class="id" type="constructor">None</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span><br/>
&nbsp;&nbsp;| <a class="idref" href="TImp.html#ETrue"><span class="id" type="constructor">ETrue</span></a>       ⇒ <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#Some"><span class="id" type="constructor">Some</span></a> (<a class="idref" href="TImp.html#VBool"><span class="id" type="constructor">VBool</span></a> <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#true"><span class="id" type="constructor">true</span></a>  )<br/>
&nbsp;&nbsp;| <a class="idref" href="TImp.html#EFalse"><span class="id" type="constructor">EFalse</span></a>      ⇒ <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#Some"><span class="id" type="constructor">Some</span></a> (<a class="idref" href="TImp.html#VBool"><span class="id" type="constructor">VBool</span></a> <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#false"><span class="id" type="constructor">false</span></a> )<br/>
&nbsp;&nbsp;| <a class="idref" href="TImp.html#EEq"><span class="id" type="constructor">EEq</span></a> <span class="id" type="var">e<sub>1</sub></span> <span class="id" type="var">e<sub>2</sub></span> ⇒ <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <a class="idref" href="TImp.html#eval"><span class="id" type="definition">eval</span></a> <a class="idref" href="TImp.html#st"><span class="id" type="variable">st</span></a> <span class="id" type="var">e<sub>1</sub></span>, <a class="idref" href="TImp.html#eval"><span class="id" type="definition">eval</span></a> <a class="idref" href="TImp.html#st"><span class="id" type="variable">st</span></a> <span class="id" type="var">e<sub>2</sub></span> <span class="id" type="keyword">with</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#Some"><span class="id" type="constructor">Some</span></a> (<a class="idref" href="TImp.html#VNat"><span class="id" type="constructor">VNat</span></a> <span class="id" type="var">n<sub>1</sub></span>), <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#Some"><span class="id" type="constructor">Some</span></a> (<a class="idref" href="TImp.html#VNat"><span class="id" type="constructor">VNat</span></a> <span class="id" type="var">n<sub>2</sub></span>) ⇒ <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#Some"><span class="id" type="constructor">Some</span></a> (<a class="idref" href="TImp.html#VBool"><span class="id" type="constructor">VBool</span></a> (<span class="id" type="var">n<sub>1</sub></span> =? <span class="id" type="var">n<sub>2</sub></span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">_</span>, <span class="id" type="var">_</span> ⇒ <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#None"><span class="id" type="constructor">None</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span><br/>
&nbsp;&nbsp;| <a class="idref" href="TImp.html#ELe"><span class="id" type="constructor">ELe</span></a> <span class="id" type="var">e<sub>1</sub></span> <span class="id" type="var">e<sub>2</sub></span> ⇒ <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <a class="idref" href="TImp.html#eval"><span class="id" type="definition">eval</span></a> <a class="idref" href="TImp.html#st"><span class="id" type="variable">st</span></a> <span class="id" type="var">e<sub>1</sub></span>, <a class="idref" href="TImp.html#eval"><span class="id" type="definition">eval</span></a> <a class="idref" href="TImp.html#st"><span class="id" type="variable">st</span></a> <span class="id" type="var">e<sub>2</sub></span> <span class="id" type="keyword">with</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#Some"><span class="id" type="constructor">Some</span></a> (<a class="idref" href="TImp.html#VNat"><span class="id" type="constructor">VNat</span></a> <span class="id" type="var">n<sub>1</sub></span>), <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#Some"><span class="id" type="constructor">Some</span></a> (<a class="idref" href="TImp.html#VNat"><span class="id" type="constructor">VNat</span></a> <span class="id" type="var">n<sub>2</sub></span>) ⇒ <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#Some"><span class="id" type="constructor">Some</span></a> (<a class="idref" href="TImp.html#VBool"><span class="id" type="constructor">VBool</span></a> (<span class="id" type="var">n<sub>1</sub></span> &lt;? <span class="id" type="var">n<sub>2</sub></span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">_</span>, <span class="id" type="var">_</span> ⇒ <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#None"><span class="id" type="constructor">None</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span><br/>
&nbsp;&nbsp;| <a class="idref" href="TImp.html#ENot"><span class="id" type="constructor">ENot</span></a> <span class="id" type="var">e</span> ⇒ <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <a class="idref" href="TImp.html#eval"><span class="id" type="definition">eval</span></a> <a class="idref" href="TImp.html#st"><span class="id" type="variable">st</span></a> <a class="idref" href="TImp.html#e"><span class="id" type="variable">e</span></a> <span class="id" type="keyword">with</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#Some"><span class="id" type="constructor">Some</span></a> (<a class="idref" href="TImp.html#VBool"><span class="id" type="constructor">VBool</span></a> <span class="id" type="var">b</span>) ⇒ <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#Some"><span class="id" type="constructor">Some</span></a> (<a class="idref" href="TImp.html#VBool"><span class="id" type="constructor">VBool</span></a> (<a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#negb"><span class="id" type="definition">negb</span></a> <span class="id" type="var">b</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">_</span> ⇒ <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#None"><span class="id" type="constructor">None</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span><br/>
&nbsp;&nbsp;| <a class="idref" href="TImp.html#EAnd"><span class="id" type="constructor">EAnd</span></a> <span class="id" type="var">e<sub>1</sub></span> <span class="id" type="var">e<sub>2</sub></span>  ⇒ <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <a class="idref" href="TImp.html#eval"><span class="id" type="definition">eval</span></a> <a class="idref" href="TImp.html#st"><span class="id" type="variable">st</span></a> <span class="id" type="var">e<sub>1</sub></span>, <a class="idref" href="TImp.html#eval"><span class="id" type="definition">eval</span></a> <a class="idref" href="TImp.html#st"><span class="id" type="variable">st</span></a> <span class="id" type="var">e<sub>2</sub></span> <span class="id" type="keyword">with</span> <br/>
<span class="comment">(*&nbsp;Let's&nbsp;include&nbsp;a&nbsp;silly&nbsp;bug&nbsp;here!&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#Some"><span class="id" type="constructor">Some</span></a> (<a class="idref" href="TImp.html#VBool"><span class="id" type="constructor">VBool</span></a> <span class="id" type="var">b</span>), <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#Some"><span class="id" type="constructor">Some</span></a> (<a class="idref" href="TImp.html#VNat"><span class="id" type="constructor">VNat</span></a> <span class="id" type="var">n<sub>2</sub></span>) ⇒ <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#Some"><span class="id" type="constructor">Some</span></a> (<a class="idref" href="TImp.html#VBool"><span class="id" type="constructor">VBool</span></a> (<a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#negb"><span class="id" type="definition">negb</span></a> <span class="id" type="var">b</span>))<br/>
<span class="comment">(*&nbsp;&nbsp;|&nbsp;Some&nbsp;(VBool&nbsp;b<sub>1</sub>),&nbsp;Some&nbsp;(VBool&nbsp;b<sub>2</sub>)&nbsp;=&gt;&nbsp;Some&nbsp;(VBool&nbsp;(andb&nbsp;b<sub>1</sub>&nbsp;b<sub>2</sub>))&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">_</span>, <span class="id" type="var">_</span> ⇒ <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#None"><span class="id" type="constructor">None</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span><br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>
</div>

<div class="doc">
<i>Type soundness</i> states that, if we have an expression <span class="inlinecode"><span class="id" type="var">e</span></span> of a
    given type <span class="inlinecode"><span class="id" type="var">T</span></span> as well as a well-typed state <span class="inlinecode"><span class="id" type="var">st</span></span>, then evaluating
    <span class="inlinecode"><span class="id" type="var">e</span></span> in <span class="inlinecode"><span class="id" type="var">st</span></span> will never fail.
</div>
<div class="code code-tight">

<span class="id" type="keyword">Definition</span> <a name="isNone"><span class="id" type="definition">isNone</span></a> {<span class="id" type="var">A</span> : <span class="id" type="keyword">Type</span>} (<span class="id" type="var">m</span> : <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#option"><span class="id" type="inductive">option</span></a> <a class="idref" href="TImp.html#A"><span class="id" type="variable">A</span></a>) :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <a class="idref" href="TImp.html#m"><span class="id" type="variable">m</span></a> <span class="id" type="keyword">with</span> <br/>
&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#None"><span class="id" type="constructor">None</span></a> ⇒ <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#true"><span class="id" type="constructor">true</span></a><br/>
&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#Some"><span class="id" type="constructor">Some</span></a> <span class="id" type="var">_</span> ⇒ <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#false"><span class="id" type="constructor">false</span></a><br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/><hr class='doublespaceincode'/>
<span class="id" type="var">Conjecture</span> <a name="expression_soundness"><span class="id" type="axiom">expression_soundness</span></a> : <span style='font-size:120%;'>&forall;</span> <span class="id" type="var">Gamma</span> <span class="id" type="var">st</span> <span class="id" type="var">e</span> <span class="id" type="var">T</span>,  <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="TImp.html#well_typed_state"><span class="id" type="inductive">well_typed_state</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a> <a class="idref" href="TImp.html#st"><span class="id" type="variable">st</span></a> →  <a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a> ||- <a class="idref" href="TImp.html#e"><span class="id" type="variable">e</span></a> \<span class="id" type="var">IN</span> <a class="idref" href="TImp.html#T"><span class="id" type="variable">T</span></a> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="TImp.html#isNone"><span class="id" type="definition">isNone</span></a> (<a class="idref" href="TImp.html#eval"><span class="id" type="definition">eval</span></a> <a class="idref" href="TImp.html#st"><span class="id" type="variable">st</span></a> <a class="idref" href="TImp.html#e"><span class="id" type="variable">e</span></a>) = <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#false"><span class="id" type="constructor">false</span></a>.<br/>
</div>

<div class="doc">
To test this property, we construct an appropriate checker: 
</div>
<div class="code code-tight">

<span class="id" type="keyword">Definition</span> <a name="expression_soundness_exec"><span class="id" type="definition">expression_soundness_exec</span></a> := <br/>
&nbsp;&nbsp;<span class="id" type="keyword">let</span> <span class="id" type="var">num_vars</span> := 4 <span class="id" type="keyword">in</span> <br/>
&nbsp;&nbsp;<span class="id" type="keyword">let</span> <span class="id" type="var">top_level_size</span> := 3 <span class="id" type="keyword">in</span><br/>
&nbsp;&nbsp;<span class="id" type="definition">forAll</span> (<a class="idref" href="TImp.html#gen_context"><span class="id" type="definition">gen_context</span></a> <a class="idref" href="TImp.html#num_vars"><span class="id" type="variable">num_vars</span></a>)  (<span class="id" type="keyword">fun</span> <span class="id" type="var">Gamma</span> ⇒<br/>
&nbsp;&nbsp;<span class="id" type="definition">forAll</span> (<a class="idref" href="TImp.html#gen_well_typed_state"><span class="id" type="definition">gen_well_typed_state</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a>) (<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> ⇒<br/>
&nbsp;&nbsp;<span class="id" type="definition">forAll</span> <span class="id" type="method">arbitrary</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">T</span> ⇒                                    <br/>
&nbsp;&nbsp;<span class="id" type="definition">forAll</span> (<a class="idref" href="TImp.html#gen_exp_typed_sized"><span class="id" type="definition">gen_exp_typed_sized</span></a> 3 <a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a> <a class="idref" href="TImp.html#T"><span class="id" type="variable">T</span></a>) (<span class="id" type="keyword">fun</span> <span class="id" type="var">me</span> ⇒ <br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <a class="idref" href="TImp.html#me"><span class="id" type="variable">me</span></a> <span class="id" type="keyword">with</span>  <br/>
&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#Some"><span class="id" type="constructor">Some</span></a> <span class="id" type="var">e</span> ⇒ <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#negb"><span class="id" type="definition">negb</span></a> (<a class="idref" href="TImp.html#isNone"><span class="id" type="definition">isNone</span></a> (<a class="idref" href="TImp.html#eval"><span class="id" type="definition">eval</span></a> <a class="idref" href="TImp.html#st"><span class="id" type="variable">st</span></a> <span class="id" type="var">e</span>))<br/>
&nbsp;&nbsp;| <span class="id" type="var">_</span> ⇒ <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#true"><span class="id" type="constructor">true</span></a><br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>)))).<br/><hr class='doublespaceincode'/>
<span class="comment">(*&nbsp;QuickChick&nbsp;expression_soundness_exec.&nbsp;*)</span><br/>
</div>

<div class="doc">

<div class="paragraph"> </div>

<pre>
===&gt;
       QuickChecking expression_soundness_exec
       [(1,TNat), (2,TNat), (3,TBool), (4,TNat)]
       [(1,VNat 0), (2,VNat 0), (3,VBool true), (4,VNat 0)]
       TBool
       Some EAnd (EAnd (EEq (EVar 4) (EVar 1)) (EEq (ENum 0) (EVar 4))) EFalse
       *** Failed after 8 tests and 0 shrinks. (0 discards)
</pre>
 But where is the bug?  This is why we need shrinking! 
<div class="paragraph"> </div>

<a name="lab86"></a><h2 class="section">Shrinking for Expressions</h2>

<div class="paragraph"> </div>

 Let's see what happens if we use the default shrinker for
    expressions carelessly. 
</div>
<div class="code code-tight">

<span class="id" type="var">Derive</span> <span class="id" type="var">Shrink</span> <span class="id" type="keyword">for</span> <span class="id" type="var">exp</span>.<br/><hr class='doublespaceincode'/>
<span class="id" type="keyword">Definition</span> <a name="expression_soundness_exec_firstshrink"><span class="id" type="definition">expression_soundness_exec_firstshrink</span></a> := <br/>
&nbsp;&nbsp;<span class="id" type="keyword">let</span> <span class="id" type="var">num_vars</span> := 4 <span class="id" type="keyword">in</span> <br/>
&nbsp;&nbsp;<span class="id" type="keyword">let</span> <span class="id" type="var">top_level_size</span> := 3 <span class="id" type="keyword">in</span><br/>
&nbsp;&nbsp;<span class="id" type="definition">forAll</span> (<a class="idref" href="TImp.html#gen_context"><span class="id" type="definition">gen_context</span></a> <a class="idref" href="TImp.html#num_vars"><span class="id" type="variable">num_vars</span></a>)  (<span class="id" type="keyword">fun</span> <span class="id" type="var">Gamma</span> ⇒<br/>
&nbsp;&nbsp;<span class="id" type="definition">forAll</span> (<a class="idref" href="TImp.html#gen_well_typed_state"><span class="id" type="definition">gen_well_typed_state</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a>) (<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> ⇒<br/>
&nbsp;&nbsp;<span class="id" type="definition">forAll</span> <span class="id" type="method">arbitrary</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">T</span> ⇒                                    <br/>
&nbsp;&nbsp;<span class="id" type="definition">forAllShrink</span> (<a class="idref" href="TImp.html#gen_exp_typed_sized"><span class="id" type="definition">gen_exp_typed_sized</span></a> 3 <a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a> <a class="idref" href="TImp.html#T"><span class="id" type="variable">T</span></a>) <span class="id" type="method">shrink</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">me</span> ⇒ <br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <a class="idref" href="TImp.html#me"><span class="id" type="variable">me</span></a> <span class="id" type="keyword">with</span>  <br/>
&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#Some"><span class="id" type="constructor">Some</span></a> <span class="id" type="var">e</span> ⇒ <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#negb"><span class="id" type="definition">negb</span></a> (<a class="idref" href="TImp.html#isNone"><span class="id" type="definition">isNone</span></a> (<a class="idref" href="TImp.html#eval"><span class="id" type="definition">eval</span></a> <a class="idref" href="TImp.html#st"><span class="id" type="variable">st</span></a> <span class="id" type="var">e</span>))<br/>
&nbsp;&nbsp;| <span class="id" type="var">_</span> ⇒ <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#true"><span class="id" type="constructor">true</span></a><br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>)))).<br/><hr class='doublespaceincode'/>
<span class="comment">(*&nbsp;QuickChick&nbsp;expression_soundness_exec_firstshrink.&nbsp;*)</span><br/>
</div>

<div class="doc">

<div class="paragraph"> </div>

<pre>
===&gt; 
  QuickChecking expression_soundness_exec_firsttry
  [(1,TBool), (2,TNat), (3,TBool), (4,TBool)]
  [(1,VBool false), (2,VNat 0), (3,VBool true), (4,VBool false)]
  TBool
  Some EAnd (ENum 0) ETrue
  *** Failed after 28 tests and 7 shrinks. (0 discards)
</pre>

<div class="paragraph"> </div>

 The expression shrank to something ill-typed! Since it causes the
    checker to fail, QuickChick views this as a succesfull shrink, even 
    though this could not actually be produced by our generator and 
    doesn't satisfy our preconditions!  One solution would be to check 
    the preconditions in the Checker, filtering out shrinks.  But that 
    would be inefficient. 
<div class="paragraph"> </div>

 We not only need to shrink expressions, we need to shrink them so
    that their type is preserved! To accomplish this, we need to
    intuitively follow the opposite of the procedure we did for
    generators: look at a typing derivation and see what parts of it
    we can shrink to while maintaining their types so that the type of
    the entire thing is preserved.

<div class="paragraph"> </div>

    As in the case of <span class="inlinecode"><span class="id" type="var">gen_exp_typed</span></span>, we are going to build up the
    full shrinker in steps. Let's begin with shrinking constants.

<div class="paragraph"> </div>

<ul class="doclist">
<li> If <span class="inlinecode"><span class="id" type="var">e</span></span> <span class="inlinecode">=</span> <span class="inlinecode"><span class="id" type="var">ENum</span></span> <span class="inlinecode"><span class="id" type="var">x</span></span> for some <span class="inlinecode"><span class="id" type="var">x</span></span>, all we can do is try to shrink
      <span class="inlinecode"><span class="id" type="var">x</span></span>.

</li>
<li> If <span class="inlinecode"><span class="id" type="var">e</span></span> <span class="inlinecode">=</span> <span class="inlinecode"><span class="id" type="var">ETrue</span></span> or <span class="inlinecode"><span class="id" type="var">e</span></span> <span class="inlinecode">=</span> <span class="inlinecode"><span class="id" type="var">EFalse</span></span>, we could shrink it to the other.
      But remember, we don't want to do both, as this would lead to an
      infinite loop in shrinking!  We choose to shrink <span class="inlinecode"><span class="id" type="var">EFalse</span></span> to
      <span class="inlinecode"><span class="id" type="var">ETrue</span></span>. 
</li>
</ul>

</div>
<div class="code code-tight">

<span class="id" type="keyword">Definition</span> <a name="shrink_base"><span class="id" type="definition">shrink_base</span></a> (<span class="id" type="var">e</span> : <a class="idref" href="TImp.html#exp"><span class="id" type="inductive">exp</span></a>) : <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#list"><span class="id" type="inductive">list</span></a> <a class="idref" href="TImp.html#exp"><span class="id" type="inductive">exp</span></a> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <a class="idref" href="TImp.html#e"><span class="id" type="variable">e</span></a> <span class="id" type="keyword">with</span> <br/>
&nbsp;&nbsp;| <a class="idref" href="TImp.html#ENum"><span class="id" type="constructor">ENum</span></a> <span class="id" type="var">n</span> ⇒ <a class="idref" href="http://coq.inria.fr/library/Coq.Lists.List.html#map"><span class="id" type="definition">map</span></a> <a class="idref" href="TImp.html#ENum"><span class="id" type="constructor">ENum</span></a> (<span class="id" type="method">shrink</span> <span class="id" type="var">n</span>)<br/>
&nbsp;&nbsp;| <a class="idref" href="TImp.html#ETrue"><span class="id" type="constructor">ETrue</span></a> ⇒ []<br/>
&nbsp;&nbsp;| <a class="idref" href="TImp.html#EFalse"><span class="id" type="constructor">EFalse</span></a> ⇒ [<a class="idref" href="TImp.html#ETrue"><span class="id" type="constructor">ETrue</span></a>] <br/>
&nbsp;&nbsp;| <span class="id" type="var">_</span> ⇒ []<br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>
</div>

<div class="doc">
The next case, <span class="inlinecode"><span class="id" type="var">EVar</span></span>, must take the type <span class="inlinecode"><span class="id" type="var">T</span></span> to be preserved into
    account. To shrink an <span class="inlinecode"><span class="id" type="var">EVar</span></span> we could try shrinking the inner
    atom, but the shrinking instance we have for atoms is a no-op, so
    that does nothing.  Or, better, we can try to shrink the <span class="inlinecode"><span class="id" type="var">EVar</span></span> to
    a constant of the appropriate type. 
</div>
<div class="code code-tight">

<span class="id" type="keyword">Definition</span> <a name="shrink_evar"><span class="id" type="definition">shrink_evar</span></a> (<span class="id" type="var">T</span> : <a class="idref" href="TImp.html#ty"><span class="id" type="inductive">ty</span></a>) (<span class="id" type="var">e</span> : <a class="idref" href="TImp.html#exp"><span class="id" type="inductive">exp</span></a>) : <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#list"><span class="id" type="inductive">list</span></a> <a class="idref" href="TImp.html#exp"><span class="id" type="inductive">exp</span></a> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <a class="idref" href="TImp.html#e"><span class="id" type="variable">e</span></a> <span class="id" type="keyword">with</span> <br/>
&nbsp;&nbsp;| <a class="idref" href="TImp.html#EVar"><span class="id" type="constructor">EVar</span></a> <span class="id" type="var">x</span> ⇒ <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <a class="idref" href="TImp.html#T"><span class="id" type="variable">T</span></a> <span class="id" type="keyword">with</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="TImp.html#TNat"><span class="id" type="constructor">TNat</span></a> ⇒ [<a class="idref" href="TImp.html#ENum"><span class="id" type="constructor">ENum</span></a> 0]<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="TImp.html#TBool"><span class="id" type="constructor">TBool</span></a> ⇒ [<a class="idref" href="TImp.html#ETrue"><span class="id" type="constructor">ETrue</span></a> ; <a class="idref" href="TImp.html#EFalse"><span class="id" type="constructor">EFalse</span></a>]<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">_</span> ⇒ []<br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>
</div>

<div class="doc">
Finally, we need to be able to shrink the recursive cases. Consider 
    <span class="inlinecode"><span class="id" type="var">EPlus</span></span> <span class="inlinecode"><span class="id" type="var">e<sub>1</sub></span></span> <span class="inlinecode"><span class="id" type="var">e<sub>2</sub></span></span>: 

<div class="paragraph"> </div>

<ul class="doclist">
<li> We could try (recursively) shrinking <span class="inlinecode"><span class="id" type="var">e<sub>1</sub></span></span> or <span class="inlinecode"><span class="id" type="var">e<sub>2</sub></span></span> preserving their 
        <span class="inlinecode"><span class="id" type="var">TNat</span></span> type.

</li>
<li> We could try to shrink directly to <span class="inlinecode"><span class="id" type="var">e<sub>1</sub></span></span> or <span class="inlinecode"><span class="id" type="var">e<sub>2</sub></span></span> since their type 
        is the same as <span class="inlinecode"><span class="id" type="var">EPlus</span></span> <span class="inlinecode"><span class="id" type="var">e<sub>1</sub></span></span> <span class="inlinecode"><span class="id" type="var">e<sub>2</sub></span></span>. 
</li>
</ul>

<div class="paragraph"> </div>

 On the other hand, consider <span class="inlinecode"><span class="id" type="var">EEq</span></span> <span class="inlinecode"><span class="id" type="var">e<sub>1</sub></span></span> <span class="inlinecode"><span class="id" type="var">e<sub>2</sub></span></span>:

<div class="paragraph"> </div>

<ul class="doclist">
<li> Again, we could recursively shrink <span class="inlinecode"><span class="id" type="var">e<sub>1</sub></span></span> or <span class="inlinecode"><span class="id" type="var">e<sub>2</sub></span></span>.

</li>
<li> But we can't shrink <i>to</i> <span class="inlinecode"><span class="id" type="var">e<sub>1</sub></span></span> or <span class="inlinecode"><span class="id" type="var">e<sub>2</sub></span></span> since they are of a
        different type.

</li>
<li> For faster shrinking, we can also try to shrink such expressions
        to boolean constants directly. 
</li>
</ul>

</div>
<div class="code code-tight">

<span class="id" type="keyword">Fixpoint</span> <a name="shrink_rec"><span class="id" type="definition">shrink_rec</span></a> (<span class="id" type="var">T</span> : <a class="idref" href="TImp.html#ty"><span class="id" type="inductive">ty</span></a>) (<span class="id" type="var">e</span> : <a class="idref" href="TImp.html#exp"><span class="id" type="inductive">exp</span></a>) : <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#list"><span class="id" type="inductive">list</span></a> <a class="idref" href="TImp.html#exp"><span class="id" type="inductive">exp</span></a> := <br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <a class="idref" href="TImp.html#e"><span class="id" type="variable">e</span></a> <span class="id" type="keyword">with</span> <br/>
&nbsp;&nbsp;| <a class="idref" href="TImp.html#EPlus"><span class="id" type="constructor">EPlus</span></a> <span class="id" type="var">e<sub>1</sub></span> <span class="id" type="var">e<sub>2</sub></span> ⇒ <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">e<sub>1</sub></span> :: <span class="id" type="var">e<sub>2</sub></span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:: (<a class="idref" href="http://coq.inria.fr/library/Coq.Lists.List.html#map"><span class="id" type="definition">List.map</span></a> (<span class="id" type="keyword">fun</span> <span class="id" type="var">e<sub>1</sub>'</span> ⇒ <a class="idref" href="TImp.html#EPlus"><span class="id" type="constructor">EPlus</span></a> <a class="idref" href="TImp.html#e<sub>1</sub>'"><span class="id" type="variable">e<sub>1</sub>'</span></a> <span class="id" type="var">e<sub>2</sub></span>) (<a class="idref" href="TImp.html#shrink_rec"><span class="id" type="definition">shrink_rec</span></a> <a class="idref" href="TImp.html#T"><span class="id" type="variable">T</span></a> <span class="id" type="var">e<sub>1</sub></span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++ (<a class="idref" href="http://coq.inria.fr/library/Coq.Lists.List.html#map"><span class="id" type="definition">List.map</span></a> (<span class="id" type="keyword">fun</span> <span class="id" type="var">e<sub>2</sub>'</span> ⇒ <a class="idref" href="TImp.html#EPlus"><span class="id" type="constructor">EPlus</span></a> <span class="id" type="var">e<sub>1</sub></span> <a class="idref" href="TImp.html#e<sub>2</sub>'"><span class="id" type="variable">e<sub>2</sub>'</span></a>) (<a class="idref" href="TImp.html#shrink_rec"><span class="id" type="definition">shrink_rec</span></a> <a class="idref" href="TImp.html#T"><span class="id" type="variable">T</span></a> <span class="id" type="var">e<sub>2</sub></span>))<br/>
&nbsp;&nbsp;| <a class="idref" href="TImp.html#EEq"><span class="id" type="constructor">EEq</span></a> <span class="id" type="var">e<sub>1</sub></span> <span class="id" type="var">e<sub>2</sub></span> ⇒ <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="TImp.html#ETrue"><span class="id" type="constructor">ETrue</span></a> :: <a class="idref" href="TImp.html#EFalse"><span class="id" type="constructor">EFalse</span></a> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:: (<a class="idref" href="http://coq.inria.fr/library/Coq.Lists.List.html#map"><span class="id" type="definition">List.map</span></a> (<span class="id" type="keyword">fun</span> <span class="id" type="var">e<sub>1</sub>'</span> ⇒ <a class="idref" href="TImp.html#EEq"><span class="id" type="constructor">EEq</span></a> <a class="idref" href="TImp.html#e<sub>1</sub>'"><span class="id" type="variable">e<sub>1</sub>'</span></a> <span class="id" type="var">e<sub>2</sub></span>) (<a class="idref" href="TImp.html#shrink_rec"><span class="id" type="definition">shrink_rec</span></a> <a class="idref" href="TImp.html#TNat"><span class="id" type="constructor">TNat</span></a> <span class="id" type="var">e<sub>1</sub></span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++ (<a class="idref" href="http://coq.inria.fr/library/Coq.Lists.List.html#map"><span class="id" type="definition">List.map</span></a> (<span class="id" type="keyword">fun</span> <span class="id" type="var">e<sub>2</sub>'</span> ⇒ <a class="idref" href="TImp.html#EEq"><span class="id" type="constructor">EEq</span></a> <span class="id" type="var">e<sub>1</sub></span> <a class="idref" href="TImp.html#e<sub>2</sub>'"><span class="id" type="variable">e<sub>2</sub>'</span></a>) (<a class="idref" href="TImp.html#shrink_rec"><span class="id" type="definition">shrink_rec</span></a> <a class="idref" href="TImp.html#TNat"><span class="id" type="constructor">TNat</span></a> <span class="id" type="var">e<sub>2</sub></span>))<br/>
&nbsp;&nbsp;| <span class="id" type="var">_</span> ⇒ []<br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>
</div>

<div class="doc">
Putting it all together yields the following smart shrinker: 
</div>
<div class="code code-tight">

<span class="id" type="keyword">Fixpoint</span> <a name="shrink_exp_typed"><span class="id" type="definition">shrink_exp_typed</span></a> (<span class="id" type="var">T</span> : <a class="idref" href="TImp.html#ty"><span class="id" type="inductive">ty</span></a>) (<span class="id" type="var">e</span> : <a class="idref" href="TImp.html#exp"><span class="id" type="inductive">exp</span></a>) : <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#list"><span class="id" type="inductive">list</span></a> <a class="idref" href="TImp.html#exp"><span class="id" type="inductive">exp</span></a> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <a class="idref" href="TImp.html#e"><span class="id" type="variable">e</span></a> <span class="id" type="keyword">with</span> <br/>
&nbsp;&nbsp;| <a class="idref" href="TImp.html#EVar"><span class="id" type="constructor">EVar</span></a> <span class="id" type="var">_</span> ⇒ <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <a class="idref" href="TImp.html#T"><span class="id" type="variable">T</span></a> <span class="id" type="keyword">with</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="TImp.html#TNat"><span class="id" type="constructor">TNat</span></a> ⇒ [<a class="idref" href="TImp.html#ENum"><span class="id" type="constructor">ENum</span></a> 0]<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="TImp.html#TBool"><span class="id" type="constructor">TBool</span></a> ⇒ [<a class="idref" href="TImp.html#ETrue"><span class="id" type="constructor">ETrue</span></a> ; <a class="idref" href="TImp.html#EFalse"><span class="id" type="constructor">EFalse</span></a>]<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span><br/>
&nbsp;&nbsp;| <a class="idref" href="TImp.html#ENum"><span class="id" type="constructor">ENum</span></a> <span class="id" type="var">_</span> ⇒ []<br/>
&nbsp;&nbsp;| <a class="idref" href="TImp.html#ETrue"><span class="id" type="constructor">ETrue</span></a> ⇒ []<br/>
&nbsp;&nbsp;| <a class="idref" href="TImp.html#EFalse"><span class="id" type="constructor">EFalse</span></a> ⇒ [<a class="idref" href="TImp.html#ETrue"><span class="id" type="constructor">ETrue</span></a>]<br/>
&nbsp;&nbsp;| <a class="idref" href="TImp.html#EPlus"><span class="id" type="constructor">EPlus</span></a> <span class="id" type="var">e<sub>1</sub></span> <span class="id" type="var">e<sub>2</sub></span> ⇒ <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">e<sub>1</sub></span> :: <span class="id" type="var">e<sub>2</sub></span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:: (<a class="idref" href="http://coq.inria.fr/library/Coq.Lists.List.html#map"><span class="id" type="definition">List.map</span></a> (<span class="id" type="keyword">fun</span> <span class="id" type="var">e<sub>1</sub>'</span> ⇒ <a class="idref" href="TImp.html#EPlus"><span class="id" type="constructor">EPlus</span></a> <a class="idref" href="TImp.html#e<sub>1</sub>'"><span class="id" type="variable">e<sub>1</sub>'</span></a> <span class="id" type="var">e<sub>2</sub></span>) (<a class="idref" href="TImp.html#shrink_exp_typed"><span class="id" type="definition">shrink_exp_typed</span></a> <a class="idref" href="TImp.html#T"><span class="id" type="variable">T</span></a> <span class="id" type="var">e<sub>1</sub></span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++ (<a class="idref" href="http://coq.inria.fr/library/Coq.Lists.List.html#map"><span class="id" type="definition">List.map</span></a> (<span class="id" type="keyword">fun</span> <span class="id" type="var">e<sub>2</sub>'</span> ⇒ <a class="idref" href="TImp.html#EPlus"><span class="id" type="constructor">EPlus</span></a> <span class="id" type="var">e<sub>1</sub></span> <a class="idref" href="TImp.html#e<sub>2</sub>'"><span class="id" type="variable">e<sub>2</sub>'</span></a>) (<a class="idref" href="TImp.html#shrink_exp_typed"><span class="id" type="definition">shrink_exp_typed</span></a> <a class="idref" href="TImp.html#T"><span class="id" type="variable">T</span></a> <span class="id" type="var">e<sub>2</sub></span>))<br/>
&nbsp;&nbsp;| <a class="idref" href="TImp.html#EMinus"><span class="id" type="constructor">EMinus</span></a> <span class="id" type="var">e<sub>1</sub></span> <span class="id" type="var">e<sub>2</sub></span> ⇒ <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">e<sub>1</sub></span> :: <span class="id" type="var">e<sub>2</sub></span> :: (<a class="idref" href="TImp.html#EPlus"><span class="id" type="constructor">EPlus</span></a> <span class="id" type="var">e<sub>1</sub></span> <span class="id" type="var">e<sub>2</sub></span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:: (<a class="idref" href="http://coq.inria.fr/library/Coq.Lists.List.html#map"><span class="id" type="definition">List.map</span></a> (<span class="id" type="keyword">fun</span> <span class="id" type="var">e<sub>1</sub>'</span> ⇒ <a class="idref" href="TImp.html#EMinus"><span class="id" type="constructor">EMinus</span></a> <a class="idref" href="TImp.html#e<sub>1</sub>'"><span class="id" type="variable">e<sub>1</sub>'</span></a> <span class="id" type="var">e<sub>2</sub></span>) (<a class="idref" href="TImp.html#shrink_exp_typed"><span class="id" type="definition">shrink_exp_typed</span></a> <a class="idref" href="TImp.html#T"><span class="id" type="variable">T</span></a> <span class="id" type="var">e<sub>1</sub></span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++ (<a class="idref" href="http://coq.inria.fr/library/Coq.Lists.List.html#map"><span class="id" type="definition">List.map</span></a> (<span class="id" type="keyword">fun</span> <span class="id" type="var">e<sub>2</sub>'</span> ⇒ <a class="idref" href="TImp.html#EMinus"><span class="id" type="constructor">EMinus</span></a> <span class="id" type="var">e<sub>1</sub></span> <a class="idref" href="TImp.html#e<sub>2</sub>'"><span class="id" type="variable">e<sub>2</sub>'</span></a>) (<a class="idref" href="TImp.html#shrink_exp_typed"><span class="id" type="definition">shrink_exp_typed</span></a> <a class="idref" href="TImp.html#T"><span class="id" type="variable">T</span></a> <span class="id" type="var">e<sub>2</sub></span>))<br/>
&nbsp;&nbsp;| <a class="idref" href="TImp.html#EMult"><span class="id" type="constructor">EMult</span></a> <span class="id" type="var">e<sub>1</sub></span> <span class="id" type="var">e<sub>2</sub></span> ⇒ <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">e<sub>1</sub></span> :: <span class="id" type="var">e<sub>2</sub></span> :: (<a class="idref" href="TImp.html#EPlus"><span class="id" type="constructor">EPlus</span></a> <span class="id" type="var">e<sub>1</sub></span> <span class="id" type="var">e<sub>2</sub></span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:: (<a class="idref" href="http://coq.inria.fr/library/Coq.Lists.List.html#map"><span class="id" type="definition">List.map</span></a> (<span class="id" type="keyword">fun</span> <span class="id" type="var">e<sub>1</sub>'</span> ⇒ <a class="idref" href="TImp.html#EMult"><span class="id" type="constructor">EMult</span></a> <a class="idref" href="TImp.html#e<sub>1</sub>'"><span class="id" type="variable">e<sub>1</sub>'</span></a> <span class="id" type="var">e<sub>2</sub></span>) (<a class="idref" href="TImp.html#shrink_exp_typed"><span class="id" type="definition">shrink_exp_typed</span></a> <a class="idref" href="TImp.html#T"><span class="id" type="variable">T</span></a> <span class="id" type="var">e<sub>1</sub></span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++ (<a class="idref" href="http://coq.inria.fr/library/Coq.Lists.List.html#map"><span class="id" type="definition">List.map</span></a> (<span class="id" type="keyword">fun</span> <span class="id" type="var">e<sub>2</sub>'</span> ⇒ <a class="idref" href="TImp.html#EMult"><span class="id" type="constructor">EMult</span></a> <span class="id" type="var">e<sub>1</sub></span> <a class="idref" href="TImp.html#e<sub>2</sub>'"><span class="id" type="variable">e<sub>2</sub>'</span></a>) (<a class="idref" href="TImp.html#shrink_exp_typed"><span class="id" type="definition">shrink_exp_typed</span></a> <a class="idref" href="TImp.html#T"><span class="id" type="variable">T</span></a> <span class="id" type="var">e<sub>2</sub></span>))<br/>
&nbsp;&nbsp;| <a class="idref" href="TImp.html#EEq"><span class="id" type="constructor">EEq</span></a> <span class="id" type="var">e<sub>1</sub></span> <span class="id" type="var">e<sub>2</sub></span> ⇒ <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="TImp.html#ETrue"><span class="id" type="constructor">ETrue</span></a> :: <a class="idref" href="TImp.html#EFalse"><span class="id" type="constructor">EFalse</span></a> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:: (<a class="idref" href="http://coq.inria.fr/library/Coq.Lists.List.html#map"><span class="id" type="definition">List.map</span></a> (<span class="id" type="keyword">fun</span> <span class="id" type="var">e<sub>1</sub>'</span> ⇒ <a class="idref" href="TImp.html#EEq"><span class="id" type="constructor">EEq</span></a> <a class="idref" href="TImp.html#e<sub>1</sub>'"><span class="id" type="variable">e<sub>1</sub>'</span></a> <span class="id" type="var">e<sub>2</sub></span>) (<a class="idref" href="TImp.html#shrink_exp_typed"><span class="id" type="definition">shrink_exp_typed</span></a> <a class="idref" href="TImp.html#TNat"><span class="id" type="constructor">TNat</span></a> <span class="id" type="var">e<sub>1</sub></span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++ (<a class="idref" href="http://coq.inria.fr/library/Coq.Lists.List.html#map"><span class="id" type="definition">List.map</span></a> (<span class="id" type="keyword">fun</span> <span class="id" type="var">e<sub>2</sub>'</span> ⇒ <a class="idref" href="TImp.html#EEq"><span class="id" type="constructor">EEq</span></a> <span class="id" type="var">e<sub>1</sub></span> <a class="idref" href="TImp.html#e<sub>2</sub>'"><span class="id" type="variable">e<sub>2</sub>'</span></a>) (<a class="idref" href="TImp.html#shrink_exp_typed"><span class="id" type="definition">shrink_exp_typed</span></a> <a class="idref" href="TImp.html#TNat"><span class="id" type="constructor">TNat</span></a> <span class="id" type="var">e<sub>2</sub></span>))<br/>
&nbsp;&nbsp;| <a class="idref" href="TImp.html#ELe"><span class="id" type="constructor">ELe</span></a> <span class="id" type="var">e<sub>1</sub></span> <span class="id" type="var">e<sub>2</sub></span> ⇒ <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="TImp.html#ETrue"><span class="id" type="constructor">ETrue</span></a> :: <a class="idref" href="TImp.html#EFalse"><span class="id" type="constructor">EFalse</span></a> :: (<a class="idref" href="TImp.html#EEq"><span class="id" type="constructor">EEq</span></a> <span class="id" type="var">e<sub>1</sub></span> <span class="id" type="var">e<sub>2</sub></span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:: (<a class="idref" href="http://coq.inria.fr/library/Coq.Lists.List.html#map"><span class="id" type="definition">List.map</span></a> (<span class="id" type="keyword">fun</span> <span class="id" type="var">e<sub>1</sub>'</span> ⇒ <a class="idref" href="TImp.html#ELe"><span class="id" type="constructor">ELe</span></a> <a class="idref" href="TImp.html#e<sub>1</sub>'"><span class="id" type="variable">e<sub>1</sub>'</span></a> <span class="id" type="var">e<sub>2</sub></span>) (<a class="idref" href="TImp.html#shrink_exp_typed"><span class="id" type="definition">shrink_exp_typed</span></a> <a class="idref" href="TImp.html#TNat"><span class="id" type="constructor">TNat</span></a> <span class="id" type="var">e<sub>1</sub></span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++ (<a class="idref" href="http://coq.inria.fr/library/Coq.Lists.List.html#map"><span class="id" type="definition">List.map</span></a> (<span class="id" type="keyword">fun</span> <span class="id" type="var">e<sub>2</sub>'</span> ⇒ <a class="idref" href="TImp.html#ELe"><span class="id" type="constructor">ELe</span></a> <span class="id" type="var">e<sub>1</sub></span> <a class="idref" href="TImp.html#e<sub>2</sub>'"><span class="id" type="variable">e<sub>2</sub>'</span></a>) (<a class="idref" href="TImp.html#shrink_exp_typed"><span class="id" type="definition">shrink_exp_typed</span></a> <a class="idref" href="TImp.html#TNat"><span class="id" type="constructor">TNat</span></a> <span class="id" type="var">e<sub>2</sub></span>))<br/>
&nbsp;&nbsp;| <a class="idref" href="TImp.html#ENot"><span class="id" type="constructor">ENot</span></a> <span class="id" type="var">e</span> ⇒ <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="TImp.html#ETrue"><span class="id" type="constructor">ETrue</span></a> :: <a class="idref" href="TImp.html#EFalse"><span class="id" type="constructor">EFalse</span></a> :: <a class="idref" href="TImp.html#e"><span class="id" type="variable">e</span></a> :: (<a class="idref" href="http://coq.inria.fr/library/Coq.Lists.List.html#map"><span class="id" type="definition">List.map</span></a> <a class="idref" href="TImp.html#ENot"><span class="id" type="constructor">ENot</span></a> (<a class="idref" href="TImp.html#shrink_exp_typed"><span class="id" type="definition">shrink_exp_typed</span></a> <a class="idref" href="TImp.html#T"><span class="id" type="variable">T</span></a> <a class="idref" href="TImp.html#e"><span class="id" type="variable">e</span></a>))<br/>
&nbsp;&nbsp;| <a class="idref" href="TImp.html#EAnd"><span class="id" type="constructor">EAnd</span></a> <span class="id" type="var">e<sub>1</sub></span> <span class="id" type="var">e<sub>2</sub></span> ⇒ <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="TImp.html#ETrue"><span class="id" type="constructor">ETrue</span></a> :: <a class="idref" href="TImp.html#EFalse"><span class="id" type="constructor">EFalse</span></a> :: <span class="id" type="var">e<sub>1</sub></span> :: <span class="id" type="var">e<sub>2</sub></span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:: (<a class="idref" href="http://coq.inria.fr/library/Coq.Lists.List.html#map"><span class="id" type="definition">List.map</span></a> (<span class="id" type="keyword">fun</span> <span class="id" type="var">e<sub>1</sub>'</span> ⇒ <a class="idref" href="TImp.html#EAnd"><span class="id" type="constructor">EAnd</span></a> <a class="idref" href="TImp.html#e<sub>1</sub>'"><span class="id" type="variable">e<sub>1</sub>'</span></a> <span class="id" type="var">e<sub>2</sub></span>) (<a class="idref" href="TImp.html#shrink_exp_typed"><span class="id" type="definition">shrink_exp_typed</span></a> <a class="idref" href="TImp.html#TBool"><span class="id" type="constructor">TBool</span></a> <span class="id" type="var">e<sub>1</sub></span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++ (<a class="idref" href="http://coq.inria.fr/library/Coq.Lists.List.html#map"><span class="id" type="definition">List.map</span></a> (<span class="id" type="keyword">fun</span> <span class="id" type="var">e<sub>2</sub>'</span> ⇒ <a class="idref" href="TImp.html#EAnd"><span class="id" type="constructor">EAnd</span></a> <span class="id" type="var">e<sub>1</sub></span> <a class="idref" href="TImp.html#e<sub>2</sub>'"><span class="id" type="variable">e<sub>2</sub>'</span></a>) (<a class="idref" href="TImp.html#shrink_exp_typed"><span class="id" type="definition">shrink_exp_typed</span></a> <a class="idref" href="TImp.html#TBool"><span class="id" type="constructor">TBool</span></a> <span class="id" type="var">e<sub>2</sub></span>))<br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>
</div>

<div class="doc">
As we saw for generators, we can also perform sanity checks on our
    shrinkers.  Here, when the shrinker is applied to an expression of
    a given type, all of its results should have the same type. 
</div>
<div class="code code-tight">

<span class="id" type="keyword">Definition</span> <a name="shrink_typed_has_type"><span class="id" type="definition">shrink_typed_has_type</span></a> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">let</span> <span class="id" type="var">num_vars</span> := 4 <span class="id" type="keyword">in</span><br/>
&nbsp;&nbsp;<span class="id" type="keyword">let</span> <span class="id" type="var">top_level_size</span> := 3 <span class="id" type="keyword">in</span> <br/>
&nbsp;&nbsp;<span class="id" type="definition">forAll</span> (<a class="idref" href="TImp.html#gen_context"><span class="id" type="definition">gen_context</span></a> <a class="idref" href="TImp.html#num_vars"><span class="id" type="variable">num_vars</span></a>) (<span class="id" type="keyword">fun</span> <span class="id" type="var">Gamma</span> ⇒<br/>
&nbsp;&nbsp;<span class="id" type="definition">forAll</span> <span class="id" type="method">arbitrary</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">T</span> ⇒                                   <br/>
&nbsp;&nbsp;<span class="id" type="definition">forAll</span> (<a class="idref" href="TImp.html#gen_exp_typed_sized"><span class="id" type="definition">gen_exp_typed_sized</span></a> <a class="idref" href="TImp.html#top_level_size"><span class="id" type="variable">top_level_size</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a> <a class="idref" href="TImp.html#T"><span class="id" type="variable">T</span></a>) (<span class="id" type="keyword">fun</span> <span class="id" type="var">me</span> ⇒<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <a class="idref" href="TImp.html#me"><span class="id" type="variable">me</span></a> <span class="id" type="keyword">with</span> <br/>
&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#Some"><span class="id" type="constructor">Some</span></a> <span class="id" type="var">e</span> ⇒ <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/library/Coq.Lists.List.html#forallb"><span class="id" type="definition">List.forallb</span></a> (<span class="id" type="keyword">fun</span> <span class="id" type="var">e'</span> ⇒ (<a class="idref" href="TImp.html#has_type"><span class="id" type="inductive">has_type</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a> <a class="idref" href="TImp.html#e'"><span class="id" type="variable">e'</span></a> <a class="idref" href="TImp.html#T"><span class="id" type="variable">T</span></a>)?) (<a class="idref" href="TImp.html#shrink_exp_typed"><span class="id" type="definition">shrink_exp_typed</span></a> <a class="idref" href="TImp.html#T"><span class="id" type="variable">T</span></a> <span class="id" type="var">e</span>)<br/>
&nbsp;&nbsp;| <span class="id" type="var">_</span> ⇒ <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#false"><span class="id" type="constructor">false</span></a> <br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>))).<br/><hr class='doublespaceincode'/>
<span class="comment">(*&nbsp;QuickChick&nbsp;shrink_typed_has_type.&nbsp;*)</span><br/>
</div>

<div class="doc">
<a name="lab87"></a><h2 class="section">Back to Soundness</h2>
 To lift the shrinker to optional expressions, QuickChick provides
    the following function. 
</div>
<div class="code code-tight">

<span class="id" type="keyword">Definition</span> <a name="lift_shrink"><span class="id" type="definition">lift_shrink</span></a> {<span class="id" type="var">A</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">shr</span> : <a class="idref" href="TImp.html#A"><span class="id" type="variable">A</span></a> → <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#list"><span class="id" type="inductive">list</span></a> <a class="idref" href="TImp.html#A"><span class="id" type="variable">A</span></a>) (<span class="id" type="var">m</span> : <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#option"><span class="id" type="inductive">option</span></a> <a class="idref" href="TImp.html#A"><span class="id" type="variable">A</span></a>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;: <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#list"><span class="id" type="inductive">list</span></a> (<a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#option"><span class="id" type="inductive">option</span></a> <a class="idref" href="TImp.html#A"><span class="id" type="variable">A</span></a>) :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <a class="idref" href="TImp.html#m"><span class="id" type="variable">m</span></a> <span class="id" type="keyword">with</span> <br/>
&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#Some"><span class="id" type="constructor">Some</span></a> <span class="id" type="var">x</span> ⇒ <a class="idref" href="http://coq.inria.fr/library/Coq.Lists.List.html#map"><span class="id" type="definition">List.map</span></a> <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#Some"><span class="id" type="constructor">Some</span></a> (<a class="idref" href="TImp.html#shr"><span class="id" type="variable">shr</span></a> <span class="id" type="var">x</span>)<br/>
&nbsp;&nbsp;| <span class="id" type="var">_</span> ⇒ []<br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>
</div>

<div class="doc">
Armed with shrinking, we can pinpoint the bug in the <span class="inlinecode"><span class="id" type="var">EAnd</span></span> branch
    of the evaluator. 
</div>
<div class="code code-tight">

<span class="id" type="keyword">Definition</span> <a name="expression_soundness_exec'"><span class="id" type="definition">expression_soundness_exec'</span></a> := <br/>
&nbsp;&nbsp;<span class="id" type="keyword">let</span> <span class="id" type="var">num_vars</span> := 4 <span class="id" type="keyword">in</span> <br/>
&nbsp;&nbsp;<span class="id" type="keyword">let</span> <span class="id" type="var">top_level_size</span> := 3 <span class="id" type="keyword">in</span><br/>
&nbsp;&nbsp;<span class="id" type="definition">forAll</span> (<a class="idref" href="TImp.html#gen_context"><span class="id" type="definition">gen_context</span></a> <a class="idref" href="TImp.html#num_vars"><span class="id" type="variable">num_vars</span></a>)  (<span class="id" type="keyword">fun</span> <span class="id" type="var">Gamma</span> ⇒<br/>
&nbsp;&nbsp;<span class="id" type="definition">forAll</span> (<a class="idref" href="TImp.html#gen_well_typed_state"><span class="id" type="definition">gen_well_typed_state</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a>) (<span class="id" type="keyword">fun</span> <span class="id" type="var">st</span> ⇒<br/>
&nbsp;&nbsp;<span class="id" type="definition">forAll</span> <span class="id" type="method">arbitrary</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">T</span> ⇒                                    <br/>
&nbsp;&nbsp;<span class="id" type="definition">forAllShrink</span> (<a class="idref" href="TImp.html#gen_exp_typed_sized"><span class="id" type="definition">gen_exp_typed_sized</span></a> 3 <a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a> <a class="idref" href="TImp.html#T"><span class="id" type="variable">T</span></a>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a class="idref" href="TImp.html#lift_shrink"><span class="id" type="definition">lift_shrink</span></a> (<a class="idref" href="TImp.html#shrink_exp_typed"><span class="id" type="definition">shrink_exp_typed</span></a> <a class="idref" href="TImp.html#T"><span class="id" type="variable">T</span></a>)) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="keyword">fun</span> <span class="id" type="var">me</span> ⇒  <br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <a class="idref" href="TImp.html#me"><span class="id" type="variable">me</span></a> <span class="id" type="keyword">with</span>  <br/>
&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#Some"><span class="id" type="constructor">Some</span></a> <span class="id" type="var">e</span> ⇒ <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#negb"><span class="id" type="definition">negb</span></a> (<a class="idref" href="TImp.html#isNone"><span class="id" type="definition">isNone</span></a> (<a class="idref" href="TImp.html#eval"><span class="id" type="definition">eval</span></a> <a class="idref" href="TImp.html#st"><span class="id" type="variable">st</span></a> <span class="id" type="var">e</span>))<br/>
&nbsp;&nbsp;| <span class="id" type="var">_</span> ⇒ <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#true"><span class="id" type="constructor">true</span></a><br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>)))).<br/><hr class='doublespaceincode'/>
<span class="comment">(*&nbsp;QuickChick&nbsp;expression_soundness_exec'.&nbsp;*)</span><br/>
</div>

<div class="doc">

<div class="paragraph"> </div>

<pre>
===&gt;
        QuickChecking expression_soundness_exec'
        [(1,TNat), (2,TNat), (3,TNat), (4,TBool)]
        [(1,VNat 0), (2,VNat 0), (3,VNat 0), (4,VBool false)]
        TBool
        Some EAnd ETrue ETrue
        *** Failed after 8 tests and 1 shrinks. (0 discards)
</pre>

<div class="paragraph"> </div>

<a name="lab88"></a><h1 class="section">Well-Typed Programs</h1>

<div class="paragraph"> </div>

 Now we're ready to introduce TImp commands; they are just like the
    ones in Imp. 
</div>
<div class="code code-tight">

<span class="id" type="keyword">Inductive</span> <a name="com"><span class="id" type="inductive">com</span></a> : <span class="id" type="keyword">Type</span> :=<br/>
&nbsp;&nbsp;| <a name="CSkip"><span class="id" type="constructor">CSkip</span></a>  : <a class="idref" href="TImp.html#com"><span class="id" type="inductive">com</span></a><br/>
&nbsp;&nbsp;| <a name="CAss"><span class="id" type="constructor">CAss</span></a>   : <a class="idref" href="TImp.html#t"><span class="id" type="axiom">Atom.t</span></a> → <a class="idref" href="TImp.html#exp"><span class="id" type="inductive">exp</span></a> → <a class="idref" href="TImp.html#com"><span class="id" type="inductive">com</span></a><br/>
&nbsp;&nbsp;| <a name="CSeq"><span class="id" type="constructor">CSeq</span></a>   : <a class="idref" href="TImp.html#com"><span class="id" type="inductive">com</span></a>    → <a class="idref" href="TImp.html#com"><span class="id" type="inductive">com</span></a> → <a class="idref" href="TImp.html#com"><span class="id" type="inductive">com</span></a><br/>
&nbsp;&nbsp;| <a name="CIf"><span class="id" type="constructor">CIf</span></a>    : <a class="idref" href="TImp.html#exp"><span class="id" type="inductive">exp</span></a>    → <a class="idref" href="TImp.html#com"><span class="id" type="inductive">com</span></a> → <a class="idref" href="TImp.html#com"><span class="id" type="inductive">com</span></a> → <a class="idref" href="TImp.html#com"><span class="id" type="inductive">com</span></a><br/>
&nbsp;&nbsp;| <a name="CWhile"><span class="id" type="constructor">CWhile</span></a> : <a class="idref" href="TImp.html#exp"><span class="id" type="inductive">exp</span></a>    → <a class="idref" href="TImp.html#com"><span class="id" type="inductive">com</span></a> → <a class="idref" href="TImp.html#com"><span class="id" type="inductive">com</span></a>.<br/><hr class='doublespaceincode'/>
<span class="id" type="keyword">Notation</span> "'SKIP'" :=<br/>
&nbsp;&nbsp;<a class="idref" href="TImp.html#CSkip"><span class="id" type="constructor">CSkip</span></a>.<br/>
<span class="id" type="keyword">Notation</span> "x '<span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>:</span>:</span>=</span>' a" :=<br/>
&nbsp;&nbsp;(<a class="idref" href="TImp.html#CAss"><span class="id" type="constructor">CAss</span></a> <span class="id" type="var">x</span> <span class="id" type="var">a</span>) (<span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 60).<br/>
<span class="id" type="keyword">Notation</span> "c<sub>1</sub> ;;; c<sub>2</sub>" :=<br/>
&nbsp;&nbsp;(<a class="idref" href="TImp.html#CSeq"><span class="id" type="constructor">CSeq</span></a> <span class="id" type="var">c<sub>1</sub></span> <span class="id" type="var">c<sub>2</sub></span>) (<span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 80, <span class="id" type="var">right</span> <span class="id" type="var">associativity</span>).<br/>
<span class="id" type="keyword">Notation</span> "'WHILE' b 'DO' c 'END'" :=<br/>
&nbsp;&nbsp;(<a class="idref" href="TImp.html#CWhile"><span class="id" type="constructor">CWhile</span></a> <span class="id" type="var">b</span> <span class="id" type="var">c</span>) (<span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 80, <span class="id" type="var">right</span> <span class="id" type="var">associativity</span>).<br/>
<span class="id" type="keyword">Notation</span> "'IFB' c<sub>1</sub> 'THEN' c<sub>2</sub> 'ELSE' c<sub>3</sub> 'FI'" :=<br/>
&nbsp;&nbsp;(<a class="idref" href="TImp.html#CIf"><span class="id" type="constructor">CIf</span></a> <span class="id" type="var">c<sub>1</sub></span> <span class="id" type="var">c<sub>2</sub></span> <span class="id" type="var">c<sub>3</sub></span>) (<span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 80, <span class="id" type="var">right</span> <span class="id" type="var">associativity</span>).<br/><hr class='doublespaceincode'/>
<span class="id" type="var">Derive</span> <span class="id" type="keyword">Show</span> <span class="id" type="keyword">for</span> <span class="id" type="var">com</span>.<br/>
</div>

<div class="doc">
(Of course, the derived <span class="inlinecode"><span class="id" type="keyword">Show</span></span> instance is not going to use these
    notations!) 
<div class="paragraph"> </div>

 We can now define what it means for a command to be well typed
    for a given context. The interesting cases are <span class="inlinecode"><span class="id" type="var">TAss</span></span> and <span class="inlinecode"><span class="id" type="var">TIf</span></span>/<span class="inlinecode"><span class="id" type="var">TWhile</span></span>. 
    The first one, ensures that the type of the variable we are 
    assigning to is the same as that of the expression. The latter,
    requires that the conditional is indeed a boolean expression.
 
</div>
<div class="code code-tight">

<span class="id" type="keyword">Inductive</span> <a name="well_typed_com"><span class="id" type="inductive">well_typed_com</span></a> : <a class="idref" href="TImp.html#context"><span class="id" type="definition">context</span></a> → <a class="idref" href="TImp.html#com"><span class="id" type="inductive">com</span></a> → <span class="id" type="keyword">Prop</span> :=<br/>
&nbsp;&nbsp;| <a name="TSkip"><span class="id" type="constructor">TSkip</span></a> : <span style='font-size:120%;'>&forall;</span> <span class="id" type="var">Gamma</span>, <a class="idref" href="TImp.html#well_typed_com"><span class="id" type="inductive">well_typed_com</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a> <a class="idref" href="TImp.html#CSkip"><span class="id" type="constructor">CSkip</span></a><br/>
&nbsp;&nbsp;| <a name="TAss"><span class="id" type="constructor">TAss</span></a>  : <span style='font-size:120%;'>&forall;</span> <span class="id" type="var">Gamma</span> <span class="id" type="var">x</span> <span class="id" type="var">e</span> <span class="id" type="var">T</span>, <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="TImp.html#bound_to"><span class="id" type="inductive">bound_to</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a> <a class="idref" href="TImp.html#x"><span class="id" type="variable">x</span></a> <a class="idref" href="TImp.html#T"><span class="id" type="variable">T</span></a> → <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a> ||- <a class="idref" href="TImp.html#e"><span class="id" type="variable">e</span></a> \<span class="id" type="var">IN</span> <a class="idref" href="TImp.html#T"><span class="id" type="variable">T</span></a> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="TImp.html#well_typed_com"><span class="id" type="inductive">well_typed_com</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a> (<a class="idref" href="TImp.html#CAss"><span class="id" type="constructor">CAss</span></a> <a class="idref" href="TImp.html#x"><span class="id" type="variable">x</span></a> <a class="idref" href="TImp.html#e"><span class="id" type="variable">e</span></a>)<br/>
&nbsp;&nbsp;| <a name="TSeq"><span class="id" type="constructor">TSeq</span></a>  : <span style='font-size:120%;'>&forall;</span> <span class="id" type="var">Gamma</span> <span class="id" type="var">c<sub>1</sub></span> <span class="id" type="var">c<sub>2</sub></span>, <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="TImp.html#well_typed_com"><span class="id" type="inductive">well_typed_com</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a> <a class="idref" href="TImp.html#c<sub>1</sub>"><span class="id" type="variable">c<sub>1</sub></span></a> → <a class="idref" href="TImp.html#well_typed_com"><span class="id" type="inductive">well_typed_com</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a> <a class="idref" href="TImp.html#c<sub>2</sub>"><span class="id" type="variable">c<sub>2</sub></span></a> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="TImp.html#well_typed_com"><span class="id" type="inductive">well_typed_com</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a> (<a class="idref" href="TImp.html#CSeq"><span class="id" type="constructor">CSeq</span></a> <a class="idref" href="TImp.html#c<sub>1</sub>"><span class="id" type="variable">c<sub>1</sub></span></a> <a class="idref" href="TImp.html#c<sub>2</sub>"><span class="id" type="variable">c<sub>2</sub></span></a>)<br/>
&nbsp;&nbsp;| <a name="TIf"><span class="id" type="constructor">TIf</span></a> : <span style='font-size:120%;'>&forall;</span> <span class="id" type="var">Gamma</span> <span class="id" type="var">b</span> <span class="id" type="var">c<sub>1</sub></span> <span class="id" type="var">c<sub>2</sub></span>, <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a> ||- <a class="idref" href="TImp.html#b"><span class="id" type="variable">b</span></a> \<span class="id" type="var">IN</span> <a class="idref" href="TImp.html#TBool"><span class="id" type="constructor">TBool</span></a> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="TImp.html#well_typed_com"><span class="id" type="inductive">well_typed_com</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a> <a class="idref" href="TImp.html#c<sub>1</sub>"><span class="id" type="variable">c<sub>1</sub></span></a> → <a class="idref" href="TImp.html#well_typed_com"><span class="id" type="inductive">well_typed_com</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a> <a class="idref" href="TImp.html#c<sub>2</sub>"><span class="id" type="variable">c<sub>2</sub></span></a> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="TImp.html#well_typed_com"><span class="id" type="inductive">well_typed_com</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a> (<a class="idref" href="TImp.html#CIf"><span class="id" type="constructor">CIf</span></a> <a class="idref" href="TImp.html#b"><span class="id" type="variable">b</span></a> <a class="idref" href="TImp.html#c<sub>1</sub>"><span class="id" type="variable">c<sub>1</sub></span></a> <a class="idref" href="TImp.html#c<sub>2</sub>"><span class="id" type="variable">c<sub>2</sub></span></a>)<br/>
&nbsp;&nbsp;| <a name="TWhile"><span class="id" type="constructor">TWhile</span></a> : <span style='font-size:120%;'>&forall;</span> <span class="id" type="var">Gamma</span> <span class="id" type="var">b</span> <span class="id" type="var">c</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a> ||- <a class="idref" href="TImp.html#b"><span class="id" type="variable">b</span></a> \<span class="id" type="var">IN</span> <a class="idref" href="TImp.html#TBool"><span class="id" type="constructor">TBool</span></a> → <a class="idref" href="TImp.html#well_typed_com"><span class="id" type="inductive">well_typed_com</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a> <a class="idref" href="TImp.html#c"><span class="id" type="variable">c</span></a> → <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="TImp.html#well_typed_com"><span class="id" type="inductive">well_typed_com</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a> (<a class="idref" href="TImp.html#CWhile"><span class="id" type="constructor">CWhile</span></a> <a class="idref" href="TImp.html#b"><span class="id" type="variable">b</span></a> <a class="idref" href="TImp.html#c"><span class="id" type="variable">c</span></a>).<br/>
</div>

<div class="doc">
<a name="lab89"></a><h2 class="section">Decidable instance for well-typed.</h2>

<div class="paragraph"> </div>

 A couple of lemmas and a custom tactic will help the decidability
    proof... 
</div>
<div class="code code-tight">

<span class="id" type="keyword">Lemma</span> <a name="bind_deterministic"><span class="id" type="lemma">bind_deterministic</span></a> <span class="id" type="var">Gamma</span> <span class="id" type="var">x</span> (<span class="id" type="var">T<sub>1</sub></span> <span class="id" type="var">T<sub>2</sub></span> : <a class="idref" href="TImp.html#ty"><span class="id" type="inductive">ty</span></a>) :<br/>
&nbsp;&nbsp;<a class="idref" href="TImp.html#bound_to"><span class="id" type="inductive">bound_to</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a> <a class="idref" href="TImp.html#x"><span class="id" type="variable">x</span></a> <a class="idref" href="TImp.html#T<sub>1</sub>"><span class="id" type="variable">T<sub>1</sub></span></a> → <a class="idref" href="TImp.html#bound_to"><span class="id" type="inductive">bound_to</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a> <a class="idref" href="TImp.html#x"><span class="id" type="variable">x</span></a> <a class="idref" href="TImp.html#T<sub>2</sub>"><span class="id" type="variable">T<sub>2</sub></span></a> → <br/>
&nbsp;&nbsp;<a class="idref" href="TImp.html#T<sub>1</sub>"><span class="id" type="variable">T<sub>1</sub></span></a> = <a class="idref" href="TImp.html#T<sub>2</sub>"><span class="id" type="variable">T<sub>2</sub></span></a>.<br/>
<div class="togglescript" id="proofcontrol5" onclick="toggleDisplay('proof5');toggleDisplay('proofcontrol5')"><span class="show"></span></div>
<div class="proofscript" id="proof5" onclick="toggleDisplay('proof5');toggleDisplay('proofcontrol5')">
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">T<sub>1</sub></span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">T<sub>2</sub></span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">H<sub>1</sub></span> <span class="id" type="var">H<sub>2</sub></span>; <span class="id" type="tactic">eauto</span>; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H<sub>1</sub></span>; <span class="id" type="tactic">inversion</span> <span class="id" type="var">H<sub>2</sub></span>; <span class="id" type="tactic">congruence</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>
</div>

<br/>
<span class="id" type="keyword">Lemma</span> <a name="has_type_deterministic"><span class="id" type="lemma">has_type_deterministic</span></a> <span class="id" type="var">Gamma</span> <span class="id" type="var">e</span> (<span class="id" type="var">T<sub>1</sub></span> <span class="id" type="var">T<sub>2</sub></span> : <a class="idref" href="TImp.html#ty"><span class="id" type="inductive">ty</span></a>) : <br/>
&nbsp;&nbsp;<a class="idref" href="TImp.html#has_type"><span class="id" type="inductive">has_type</span></a> <a class="idref" href="TImp.html#e"><span class="id" type="variable">e</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a> <a class="idref" href="TImp.html#T<sub>1</sub>"><span class="id" type="variable">T<sub>1</sub></span></a> → <a class="idref" href="TImp.html#has_type"><span class="id" type="inductive">has_type</span></a> <a class="idref" href="TImp.html#e"><span class="id" type="variable">e</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a> <a class="idref" href="TImp.html#T<sub>2</sub>"><span class="id" type="variable">T<sub>2</sub></span></a> → <br/>
&nbsp;&nbsp;<a class="idref" href="TImp.html#T<sub>1</sub>"><span class="id" type="variable">T<sub>1</sub></span></a> = <a class="idref" href="TImp.html#T<sub>2</sub>"><span class="id" type="variable">T<sub>2</sub></span></a>.<br/>
<div class="togglescript" id="proofcontrol6" onclick="toggleDisplay('proof6');toggleDisplay('proofcontrol6')"><span class="show"></span></div>
<div class="proofscript" id="proof6" onclick="toggleDisplay('proof6');toggleDisplay('proofcontrol6')">
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">T<sub>1</sub></span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">T<sub>2</sub></span>; <span class="id" type="tactic">intros</span> <span class="id" type="var">H<sub>1</sub></span> <span class="id" type="var">H<sub>2</sub></span>; <span class="id" type="tactic">eauto</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H<sub>1</sub></span>; <span class="id" type="tactic">inversion</span> <span class="id" type="var">H<sub>2</sub></span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">eauto</span>; <span class="id" type="tactic">try</span> <span class="id" type="tactic">congruence</span>;<br/>
&nbsp;&nbsp;<span class="id" type="tactic">inversion</span> <span class="id" type="var">H<sub>7</sub></span>; <span class="id" type="tactic">subst</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">eapply</span> <a class="idref" href="TImp.html#bind_deterministic"><span class="id" type="lemma">bind_deterministic</span></a>; <span class="id" type="tactic">eauto</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>
</div>

<br/>
<span class="id" type="keyword">Ltac</span> <span class="id" type="var">solve_det</span> := <br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">goal</span> <span class="id" type="keyword">with</span> <br/>
&nbsp;&nbsp;| [ <span class="id" type="var">H<sub>1</sub></span> : <a class="idref" href="TImp.html#bound_to"><span class="id" type="inductive">bound_to</span></a> <span class="id" type="var">_</span> <span class="id" type="var">_</span> ?<span class="id" type="var">T<sub>1</sub></span> ,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">H<sub>2</sub></span> : <a class="idref" href="TImp.html#bound_to"><span class="id" type="inductive">bound_to</span></a> <span class="id" type="var">_</span> <span class="id" type="var">_</span> ?<span class="id" type="var">T<sub>2</sub></span> |- <span class="id" type="var">_</span> ] ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assert</span> (<span class="id" type="var">T<sub>1</sub></span> = <span class="id" type="var">T<sub>2</sub></span>) <span class="id" type="tactic">by</span> (<span class="id" type="tactic">eapply</span> <a class="idref" href="TImp.html#bind_deterministic"><span class="id" type="lemma">bind_deterministic</span></a>; <span class="id" type="tactic">eauto</span>)<br/>
&nbsp;&nbsp;| [ <span class="id" type="var">H<sub>1</sub></span> : <a class="idref" href="TImp.html#has_type"><span class="id" type="inductive">has_type</span></a> <span class="id" type="var">_</span> <span class="id" type="var">_</span> ?<span class="id" type="var">T<sub>1</sub></span> ,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">H<sub>2</sub></span> : <a class="idref" href="TImp.html#has_type"><span class="id" type="inductive">has_type</span></a> <span class="id" type="var">_</span> <span class="id" type="var">_</span> ?<span class="id" type="var">T<sub>2</sub></span> |- <span class="id" type="var">_</span> ] ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">assert</span> (<span class="id" type="var">T<sub>1</sub></span> = <span class="id" type="var">T<sub>2</sub></span>) <span class="id" type="tactic">by</span> (<span class="id" type="tactic">eapply</span> <a class="idref" href="TImp.html#bind_deterministic"><span class="id" type="lemma">bind_deterministic</span></a>; <span class="id" type="tactic">eauto</span>)<br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>
</div>

<div class="doc">
Now, here is a brute-force decision procedure for the typing
    relation (which amounts to a simple, but naive, typechecker). 
</div>
<div class="code code-tight">

<span class="id" type="keyword">Instance</span> <a name="dec_well_typed_com"><span class="id" type="instance">dec_well_typed_com</span></a> (<span class="id" type="var">Gamma</span> : <a class="idref" href="TImp.html#context"><span class="id" type="definition">context</span></a>) (<span class="id" type="var">c</span> : <a class="idref" href="TImp.html#com"><span class="id" type="inductive">com</span></a>) <br/>
&nbsp;&nbsp;: <span class="id" type="class">Dec</span> (<a class="idref" href="TImp.html#well_typed_com"><span class="id" type="inductive">well_typed_com</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a> <a class="idref" href="TImp.html#c"><span class="id" type="variable">c</span></a>).<br/>
<div class="togglescript" id="proofcontrol7" onclick="toggleDisplay('proof7');toggleDisplay('proofcontrol7')"><span class="show"></span></div>
<div class="proofscript" id="proof7" onclick="toggleDisplay('proof7');toggleDisplay('proofcontrol7')">
<span class="id" type="keyword">Proof</span> <span class="id" type="keyword">with</span> <span class="id" type="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">constructor</span>. <span class="id" type="tactic">unfold</span> <a class="idref" href="http://coq.inria.fr/library/Coq.ssr.ssrbool.html#decidable"><span class="id" type="definition">ssrbool.decidable</span></a>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">induction</span> <span class="id" type="var">c</span>; <span class="id" type="var">solve_sum</span>.<br/>
&nbsp;&nbsp;- <span class="id" type="tactic">destruct</span> (<a class="idref" href="TImp.html#dec_bound_to"><span class="id" type="instance">dec_bound_to</span></a> <span class="id" type="var">Gamma</span> <span class="id" type="var">t</span> <a class="idref" href="TImp.html#TNat"><span class="id" type="constructor">TNat</span></a>); <span class="id" type="tactic">destruct</span> <span class="id" type="var">dec</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<a class="idref" href="TImp.html#dec_has_type"><span class="id" type="instance">dec_has_type</span></a> <span class="id" type="var">e</span> <span class="id" type="var">Gamma</span> <a class="idref" href="TImp.html#TNat"><span class="id" type="constructor">TNat</span></a>); <span class="id" type="tactic">destruct</span> <span class="id" type="var">dec</span>; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<a class="idref" href="TImp.html#dec_bound_to"><span class="id" type="instance">dec_bound_to</span></a> <span class="id" type="var">Gamma</span> <span class="id" type="var">t</span> <a class="idref" href="TImp.html#TBool"><span class="id" type="constructor">TBool</span></a>); <span class="id" type="tactic">destruct</span> <span class="id" type="var">dec</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<a class="idref" href="TImp.html#dec_has_type"><span class="id" type="instance">dec_has_type</span></a> <span class="id" type="var">e</span> <span class="id" type="var">Gamma</span> <a class="idref" href="TImp.html#TBool"><span class="id" type="constructor">TBool</span></a>); <span class="id" type="tactic">destruct</span> <span class="id" type="var">dec</span>; <span class="id" type="var">solve_sum</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">try</span> <span class="id" type="var">solve_det</span>; <span class="id" type="tactic">try</span> <span class="id" type="tactic">congruence</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">right</span>; <span class="id" type="tactic">intro</span> <span class="id" type="var">Contra</span>; <span class="id" type="tactic">inversion</span> <span class="id" type="var">Contra</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">clear</span> <span class="id" type="var">Contra</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">try</span> <span class="id" type="var">solve_det</span>; <span class="id" type="tactic">try</span> <span class="id" type="tactic">congruence</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">T</span>; <span class="id" type="tactic">eauto</span>.<br/>
&nbsp;&nbsp;- <span class="id" type="tactic">destruct</span> <span class="id" type="var">IHc1</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">IHc2</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">eauto</span>; <span class="id" type="var">solve_sum</span>.<br/>
&nbsp;&nbsp;- <span class="id" type="tactic">destruct</span> <span class="id" type="var">IHc1</span>; <span class="id" type="tactic">destruct</span> <span class="id" type="var">IHc2</span>; <span class="id" type="tactic">subst</span>; <span class="id" type="tactic">eauto</span>; <span class="id" type="var">solve_sum</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<a class="idref" href="TImp.html#dec_has_type"><span class="id" type="instance">dec_has_type</span></a> <span class="id" type="var">e</span> <span class="id" type="var">Gamma</span> <a class="idref" href="TImp.html#TBool"><span class="id" type="constructor">TBool</span></a>); <span class="id" type="tactic">destruct</span> <span class="id" type="var">dec</span>; <span class="id" type="var">solve_sum</span>.<br/>
&nbsp;&nbsp;- <span class="id" type="tactic">destruct</span> <span class="id" type="var">IHc</span>; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> (<a class="idref" href="TImp.html#dec_has_type"><span class="id" type="instance">dec_has_type</span></a> <span class="id" type="var">e</span> <span class="id" type="var">Gamma</span> <a class="idref" href="TImp.html#TBool"><span class="id" type="constructor">TBool</span></a>); <span class="id" type="tactic">destruct</span> <span class="id" type="var">dec</span>; <span class="id" type="var">solve_sum</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>
</div>
</div>

<div class="doc">
<a name="lab90"></a><h4 class="section">Exercise: 4 stars (arbitrary_well_typed_com)</h4>
 Write a generator and a shrinker for well_typed programs given
    some context <span class="inlinecode"><span class="id" type="var">Gamma</span></span>.  Write some appropriate sanity checks and
    make sure they give expected results. 
</div>
<div class="code code-tight">

<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span><br/>
</div>

<span class="proofbox">&#9744;</span> 
<div class="doc less-space">
<div class="paragraph"> </div>

 To complete the tour of testing for TImp, here is a (buggy??)
    evaluation function for commands given a state. To ensure
    termination, we've included a "fuel" parameter: if it gets to zero
    we return <span class="inlinecode"><span class="id" type="var">OutOfGas</span></span>, signifying that we're not sure if evaluation
    would have succeeded, failed, or diverged if we'd gone on
    evaluating. 
</div>
<div class="code code-tight">

<span class="id" type="keyword">Inductive</span> <a name="result"><span class="id" type="inductive">result</span></a> := <br/>
| <a name="Success"><span class="id" type="constructor">Success</span></a> : <a class="idref" href="TImp.html#state"><span class="id" type="definition">state</span></a> → <a class="idref" href="TImp.html#result"><span class="id" type="inductive">result</span></a><br/>
| <a name="Fail"><span class="id" type="constructor">Fail</span></a> : <a class="idref" href="TImp.html#result"><span class="id" type="inductive">result</span></a> <br/>
| <a name="OutOfGas"><span class="id" type="constructor">OutOfGas</span></a> : <a class="idref" href="TImp.html#result"><span class="id" type="inductive">result</span></a>.<br/><hr class='doublespaceincode'/>
<span class="id" type="keyword">Fixpoint</span> <a name="ceval"><span class="id" type="definition">ceval</span></a> (<span class="id" type="var">fuel</span> : <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nat"><span class="id" type="inductive">nat</span></a>) (<span class="id" type="var">st</span> : <a class="idref" href="TImp.html#state"><span class="id" type="definition">state</span></a>) (<span class="id" type="var">c</span> : <a class="idref" href="TImp.html#com"><span class="id" type="inductive">com</span></a>) : <a class="idref" href="TImp.html#result"><span class="id" type="inductive">result</span></a> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <a class="idref" href="TImp.html#fuel"><span class="id" type="variable">fuel</span></a> <span class="id" type="keyword">with</span> <br/>
&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#O"><span class="id" type="constructor">O</span></a> ⇒ <a class="idref" href="TImp.html#OutOfGas"><span class="id" type="constructor">OutOfGas</span></a><br/>
&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#S"><span class="id" type="constructor">S</span></a> <span class="id" type="var">fuel'</span> ⇒ <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <a class="idref" href="TImp.html#c"><span class="id" type="variable">c</span></a> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="TImp.html#::'SKIP'"><span class="id" type="notation">SKIP</span></a> ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="TImp.html#Success"><span class="id" type="constructor">Success</span></a> <a class="idref" href="TImp.html#st"><span class="id" type="variable">st</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">x</span> <span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>:</span>:</span>=</span> <span class="id" type="var">e</span> ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <a class="idref" href="TImp.html#eval"><span class="id" type="definition">eval</span></a> <a class="idref" href="TImp.html#st"><span class="id" type="variable">st</span></a> <span class="id" type="var">e</span> <span class="id" type="keyword">with</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#Some"><span class="id" type="constructor">Some</span></a> <span class="id" type="var">v</span> ⇒ <a class="idref" href="TImp.html#Success"><span class="id" type="constructor">Success</span></a> (<a class="idref" href="TImp.html#set"><span class="id" type="definition">AtomMap.set</span></a> <a class="idref" href="TImp.html#st"><span class="id" type="variable">st</span></a> <span class="id" type="var">x</span> <span class="id" type="var">v</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">_</span> ⇒ <a class="idref" href="TImp.html#Fail"><span class="id" type="constructor">Fail</span></a> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">c<sub>1</sub></span> ;;; <span class="id" type="var">c<sub>2</sub></span> ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <a class="idref" href="TImp.html#ceval"><span class="id" type="definition">ceval</span></a> <span class="id" type="var">fuel'</span> <a class="idref" href="TImp.html#st"><span class="id" type="variable">st</span></a> <span class="id" type="var">c<sub>1</sub></span> <span class="id" type="keyword">with</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="TImp.html#Success"><span class="id" type="constructor">Success</span></a> <span class="id" type="var">st'</span> ⇒  <a class="idref" href="TImp.html#ceval"><span class="id" type="definition">ceval</span></a> <span class="id" type="var">fuel'</span> <span class="id" type="var">st'</span> <span class="id" type="var">c<sub>2</sub></span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">_</span> ⇒ <a class="idref" href="TImp.html#Fail"><span class="id" type="constructor">Fail</span></a> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="TImp.html#::'IFB'_x_'THEN'_x_'ELSE'_x_'FI'"><span class="id" type="notation">IFB</span></a> <span class="id" type="var">b</span> <span class="id" type="var">THEN</span> <span class="id" type="var">c<sub>1</sub></span> <span class="id" type="var">ELSE</span> <span class="id" type="var">c<sub>2</sub></span> <span class="id" type="var">FI</span> ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <a class="idref" href="TImp.html#eval"><span class="id" type="definition">eval</span></a> <a class="idref" href="TImp.html#st"><span class="id" type="variable">st</span></a> <span class="id" type="var">b</span> <span class="id" type="keyword">with</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#Some"><span class="id" type="constructor">Some</span></a> (<a class="idref" href="TImp.html#VBool"><span class="id" type="constructor">VBool</span></a> <span class="id" type="var">b</span>) ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="TImp.html#ceval"><span class="id" type="definition">ceval</span></a> <span class="id" type="var">fuel'</span> <a class="idref" href="TImp.html#st"><span class="id" type="variable">st</span></a> (<span class="id" type="keyword">if</span> <span class="id" type="var">b</span> <span class="id" type="keyword">then</span> <span class="id" type="var">c<sub>1</sub></span> <span class="id" type="keyword">else</span> <span class="id" type="var">c<sub>2</sub></span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">_</span> ⇒ <a class="idref" href="TImp.html#Fail"><span class="id" type="constructor">Fail</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="TImp.html#::'WHILE'_x_'DO'_x_'END'"><span class="id" type="notation">WHILE</span></a> <span class="id" type="var">b</span> <span class="id" type="var">DO</span> <span class="id" type="var">c</span> <span class="id" type="var">END</span> ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span> <a class="idref" href="TImp.html#eval"><span class="id" type="definition">eval</span></a> <a class="idref" href="TImp.html#st"><span class="id" type="variable">st</span></a> <span class="id" type="var">b</span> <span class="id" type="keyword">with</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#Some"><span class="id" type="constructor">Some</span></a> (<a class="idref" href="TImp.html#VBool"><span class="id" type="constructor">VBool</span></a> <span class="id" type="var">b'</span>) ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">if</span> <span class="id" type="var">b'</span> <span class="id" type="keyword">then</span> <a class="idref" href="TImp.html#ceval"><span class="id" type="definition">ceval</span></a> <span class="id" type="var">fuel'</span> <a class="idref" href="TImp.html#st"><span class="id" type="variable">st</span></a> (<a class="idref" href="TImp.html#c"><span class="id" type="variable">c</span></a> ;;; <a class="idref" href="TImp.html#::'WHILE'_x_'DO'_x_'END'"><span class="id" type="notation">WHILE</span></a> <span class="id" type="var">b</span> <span class="id" type="var">DO</span> <a class="idref" href="TImp.html#c"><span class="id" type="variable">c</span></a> <span class="id" type="var">END</span>) <span class="id" type="keyword">else</span> <a class="idref" href="TImp.html#Success"><span class="id" type="constructor">Success</span></a> <a class="idref" href="TImp.html#st"><span class="id" type="variable">st</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">_</span> ⇒ <a class="idref" href="TImp.html#Fail"><span class="id" type="constructor">Fail</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span><br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/><hr class='doublespaceincode'/>
<span class="id" type="keyword">Definition</span> <a name="isFail"><span class="id" type="definition">isFail</span></a> <span class="id" type="var">r</span> := <br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <a class="idref" href="TImp.html#r"><span class="id" type="variable">r</span></a> <span class="id" type="keyword">with</span> <br/>
&nbsp;&nbsp;| <a class="idref" href="TImp.html#Fail"><span class="id" type="constructor">Fail</span></a> ⇒ <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#true"><span class="id" type="constructor">true</span></a><br/>
&nbsp;&nbsp;| <span class="id" type="var">_</span> ⇒ <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#false"><span class="id" type="constructor">false</span></a><br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>
</div>

<div class="doc">
<i>Type soundness</i>: well-typed commands never fail. 
</div>
<div class="code code-tight">

<span class="id" type="var">Conjecture</span> <a name="well_typed_state_never_stuck"><span class="id" type="axiom">well_typed_state_never_stuck</span></a> : <br/>
&nbsp;&nbsp;<span style='font-size:120%;'>&forall;</span> <span class="id" type="var">Gamma</span> <span class="id" type="var">st</span>, <a class="idref" href="TImp.html#well_typed_state"><span class="id" type="inductive">well_typed_state</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a> <a class="idref" href="TImp.html#st"><span class="id" type="variable">st</span></a> →<br/>
&nbsp;&nbsp;<span style='font-size:120%;'>&forall;</span> <span class="id" type="var">c</span>, <a class="idref" href="TImp.html#well_typed_com"><span class="id" type="inductive">well_typed_com</span></a> <a class="idref" href="TImp.html#Gamma"><span class="id" type="variable">Gamma</span></a> <a class="idref" href="TImp.html#c"><span class="id" type="variable">c</span></a> →<br/>
&nbsp;&nbsp;<span style='font-size:120%;'>&forall;</span> <span class="id" type="var">fuel</span>, <a class="idref" href="TImp.html#isFail"><span class="id" type="definition">isFail</span></a> (<a class="idref" href="TImp.html#ceval"><span class="id" type="definition">ceval</span></a> <a class="idref" href="TImp.html#fuel"><span class="id" type="variable">fuel</span></a> <a class="idref" href="TImp.html#st"><span class="id" type="variable">st</span></a> <a class="idref" href="TImp.html#c"><span class="id" type="variable">c</span></a>) = <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#false"><span class="id" type="constructor">false</span></a>.<br/>
</div>

<div class="doc">
<a name="lab91"></a><h4 class="section">Exercise: 4 stars (well_typed_state_never_stuck)</h4>
 Write a checker for the above property, find any bugs, and fix them. 
</div>
<div class="code code-tight">

<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span><br/>
</div>

<div class="doc">
<a name="lab92"></a><h1 class="section">Automation (Revisited)</h1>

<div class="paragraph"> </div>

 QuickChick is under very active development.  Our vision is that
    it should automate most of the tedious parts of testing, while
    retaining full customizability.

<div class="paragraph"> </div>

    We close this case study with a brief demo of some things it can
    do now. 
<div class="paragraph"> </div>

 Recall the <span class="inlinecode"><span class="id" type="var">has_type_value</span></span> property and its corresponding generator:

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;<span class="id" type="keyword">Inductive</span>&nbsp;<span class="id" type="var">has_type_value</span>&nbsp;:&nbsp;<span class="id" type="var">value</span>&nbsp;→&nbsp;<span class="id" type="var">ty</span>&nbsp;→&nbsp;<span class="id" type="keyword">Prop</span>&nbsp;:=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;<span class="id" type="var">TyVNat</span>&nbsp;&nbsp;:&nbsp;<span style='font-size:120%;'>&forall;</span>&nbsp;<span class="id" type="var">n</span>,&nbsp;<span class="id" type="var">has_type_value</span>&nbsp;(<span class="id" type="var">VNat</span>&nbsp;&nbsp;<span class="id" type="var">n</span>)&nbsp;<span class="id" type="var">TNat</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;<span class="id" type="var">TyVBool</span>&nbsp;:&nbsp;<span style='font-size:120%;'>&forall;</span>&nbsp;<span class="id" type="var">b</span>,&nbsp;<span class="id" type="var">has_type_value</span>&nbsp;(<span class="id" type="var">VBool</span>&nbsp;<span class="id" type="var">b</span>)&nbsp;<span class="id" type="var">TBool</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="id" type="keyword">Definition</span>&nbsp;<span class="id" type="var">gen_typed_value</span>&nbsp;(<span class="id" type="var">T</span>&nbsp;:&nbsp;<span class="id" type="var">ty</span>)&nbsp;:&nbsp;<span class="id" type="var">G</span>&nbsp;<span class="id" type="var">value</span>&nbsp;:=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">match</span>&nbsp;<span class="id" type="var">T</span>&nbsp;<span class="id" type="keyword">with</span>&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;<span class="id" type="var">TNat</span>&nbsp;&nbsp;⇒&nbsp;<span class="id" type="var">n</span>&nbsp;&lt;-&nbsp;<span class="id" type="var">arbitrary</span>;;&nbsp;<span class="id" type="var">ret</span>&nbsp;(<span class="id" type="var">VNat</span>&nbsp;<span class="id" type="var">n</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;<span class="id" type="var">TBool</span>&nbsp;⇒&nbsp;<span class="id" type="var">b</span>&nbsp;&lt;-&nbsp;<span class="id" type="var">arbitrary</span>;;&nbsp;<span class="id" type="var">ret</span>&nbsp;(<span class="id" type="var">VBool</span>&nbsp;<span class="id" type="var">b</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">end</span>.
<div class="paragraph"> </div>

</div>
    QuickChick includes a derivation mechanism that can <i>automatically</i>
    produce such generators &mdash; i.e., generators for data structures 
    satisfying inductively defined properties! 
</div>
<div class="code code-tight">

<span class="id" type="var">Derive</span> <span class="id" type="var">ArbitrarySizedSuchThat</span> <span class="id" type="keyword">for</span> (<span class="id" type="keyword">fun</span> <span class="id" type="var">v</span> ⇒ <span class="id" type="var">has_type_value</span> <span class="id" type="var">v</span> <span class="id" type="var">T</span>).<br/>
</div>

<div class="doc">
===&gt; 
  GenSizedSuchThathas_type_value is defined. 
<div class="paragraph"> </div>

 Let's take a closer look at what is being generated (after 
    doing some renaming and reformatting). 
</div>
<div class="code code-tight">

<span class="id" type="keyword">Print</span> <a class="idref" href="TImp.html#GenSizedSuchThathas_type_value"><span class="id" type="instance">GenSizedSuchThathas_type_value</span></a>.<br/>
</div>

<div class="doc">
<pre>
===&gt;
  GenSizedSuchThathas_type_value = fun T : ty =&gt;
  {| arbitrarySizeST := 
     let fix aux_arb (size0 : nat) (T : ty) {struct size0} 
           : G (option value) :=
       match size0 with
       | 0 =&gt; backtrack [(1, match T with
                             | TBool =&gt; ret None
                             | TNat =&gt; n &lt;- arbitrary;;
                                       ret (Some (VNat n))
                             end)
                        ;(1, match T with
                             | TBool =&gt; b &lt;- arbitrary;;
                                        ret (Some (VBool b)))
                             | TNat =&gt; ret None
                             end)]
       | S _ =&gt; backtrack [(1, match T with
                               | TBool =&gt; ret None
                               | TNat =&gt; n &lt;- arbitrary;;
                                         ret (Some (VNat n))
                               end)
                          ;(1, match T with
                               | TBool =&gt; b &lt;- arbitrary;;
                                          ret (Some (VBool b)))
                               | TNat =&gt; ret None
                               end)]
       end in
       fun size0 : nat =&gt; aux_arb size0 T |}

  : forall T : ty,
      GenSizedSuchThat value 
          (fun v =&gt; has_type_value v T)
</pre>

<div class="paragraph"> </div>

 This is a rather more verbose version of the <span class="inlinecode"><span class="id" type="var">gen_typed_value</span></span>
    generator, but the end result is actually exactly the same 
    distribution! 
<div class="paragraph"> </div>

<a name="lab93"></a><h2 class="section">(More) Typeclasses for Generation</h2>

<div class="paragraph"> </div>

 QuickChick provides typeclasses for automating the generation 
    for data satisfying predicates. 
</div>
<div class="code code-tight">

<span class="id" type="keyword">Module</span> <a name="GenSTPlayground"><span class="id" type="module">GenSTPlayground</span></a>.<br/>
</div>

<div class="doc">
A variant that takes a size,... 
</div>
<div class="code code-tight">

<span class="id" type="keyword">Class</span> <a name="GenSTPlayground.GenSizedSuchThat"><span class="id" type="record">GenSizedSuchThat</span></a> (<span class="id" type="var">A</span> : <span class="id" type="keyword">Type</span>) (<span class="id" type="var">P</span> : <a class="idref" href="TImp.html#A"><span class="id" type="variable">A</span></a> → <span class="id" type="keyword">Prop</span>) := <br/>
&nbsp;&nbsp;{ <a name="GenSTPlayground.arbitrarySizeST"><span class="id" type="projection">arbitrarySizeST</span></a> : <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nat"><span class="id" type="inductive">nat</span></a> → <span class="id" type="axiom">G</span> (<a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#option"><span class="id" type="inductive">option</span></a> <a class="idref" href="TImp.html#A"><span class="id" type="variable">A</span></a>) }.<br/>
</div>

<div class="doc">
...an unsized variant,... 
</div>
<div class="code code-tight">

<span class="id" type="keyword">Class</span> <a name="GenSTPlayground.GenSuchThat"><span class="id" type="record">GenSuchThat</span></a> (<span class="id" type="var">A</span> : <span class="id" type="keyword">Type</span>) (<span class="id" type="var">P</span> : <a class="idref" href="TImp.html#A"><span class="id" type="variable">A</span></a> → <span class="id" type="keyword">Prop</span>) := <br/>
&nbsp;&nbsp;{ <a name="GenSTPlayground.arbitraryST"><span class="id" type="projection">arbitraryST</span></a> : <span class="id" type="axiom">G</span> (<a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#option"><span class="id" type="inductive">option</span></a> <a class="idref" href="TImp.html#A"><span class="id" type="variable">A</span></a>) }.<br/>
</div>

<div class="doc">
...convenient notation,... 
</div>
<div class="code code-tight">

<span class="id" type="keyword">Notation</span> "'genST' x" := (@<a class="idref" href="TImp.html#GenSTPlayground.arbitraryST"><span class="id" type="method">arbitraryST</span></a> <span class="id" type="var">_</span> <span class="id" type="var">x</span> <span class="id" type="var">_</span>) (<span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 70).<br/>
</div>

<div class="doc">
...and a coercion between the two: 
</div>
<div class="code code-tight">

<span class="id" type="keyword">Instance</span> <a name="GenSTPlayground.GenSuchThatOfBounded"><span class="id" type="instance">GenSuchThatOfBounded</span></a> (<span class="id" type="var">A</span> : <span class="id" type="keyword">Type</span>) (<span class="id" type="var">P</span> : <a class="idref" href="TImp.html#A"><span class="id" type="variable">A</span></a> → <span class="id" type="keyword">Prop</span>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">H</span> : <a class="idref" href="TImp.html#GenSTPlayground.GenSizedSuchThat"><span class="id" type="class">GenSizedSuchThat</span></a> <a class="idref" href="TImp.html#A"><span class="id" type="variable">A</span></a> <a class="idref" href="TImp.html#P"><span class="id" type="variable">P</span></a>)<br/>
&nbsp;&nbsp;: <a class="idref" href="TImp.html#GenSTPlayground.GenSuchThat"><span class="id" type="class">GenSuchThat</span></a> <a class="idref" href="TImp.html#A"><span class="id" type="variable">A</span></a> <a class="idref" href="TImp.html#P"><span class="id" type="variable">P</span></a> := <br/>
&nbsp;&nbsp;{ <a class="idref" href="TImp.html#GenSTPlayground.arbitraryST"><span class="id" type="method">arbitraryST</span></a> := <span class="id" type="axiom">sized</span> <a class="idref" href="TImp.html#GenSTPlayground.arbitrarySizeST"><span class="id" type="method">arbitrarySizeST</span></a> }.<br/><hr class='doublespaceincode'/>
<span class="id" type="keyword">End</span> <a class="idref" href="TImp.html#GenSTPlayground"><span class="id" type="module">GenSTPlayground</span></a>.<br/>
</div>

<div class="doc">
<a name="lab94"></a><h2 class="section">Using "SuchThat" Typeclasses</h2>

<div class="paragraph"> </div>

 QuickChick can now (ab)use the typeclass resolution mechanism to 
    perform black magic: 
</div>
<div class="code code-tight">

<span class="id" type="var">Conjecture</span> <a name="conditional_prop_example"><span class="id" type="axiom">conditional_prop_example</span></a> : <br/>
&nbsp;&nbsp;<span style='font-size:120%;'>&forall;</span> (<span class="id" type="var">x</span> <span class="id" type="var">y</span> : <a class="idref" href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#nat"><span class="id" type="inductive">nat</span></a>), <a class="idref" href="TImp.html#x"><span class="id" type="variable">x</span></a> = <a class="idref" href="TImp.html#y"><span class="id" type="variable">y</span></a> → <a class="idref" href="TImp.html#x"><span class="id" type="variable">x</span></a> = <a class="idref" href="TImp.html#y"><span class="id" type="variable">y</span></a>.<br/><hr class='doublespaceincode'/>
<span class="comment">(*&nbsp;QuickChick&nbsp;conditional_prop_example.&nbsp;*)</span><br/>
</div>

<div class="doc">
<pre>
  ==&gt;
    QuickChecking conditional_prop_example
    +++ Passed 10000 tests (0 discards)
</pre>

<div class="paragraph"> </div>

 Notice the "0 discards": that means that quickchick is using
    generators that produce <span class="inlinecode"><span class="id" type="var">x</span></span> and <span class="inlinecode"><span class="id" type="var">y</span></span> such that <span class="inlinecode"><span class="id" type="var">x</span></span> <span class="inlinecode">=</span> <span class="inlinecode"><span class="id" type="var">y</span></span>! 
</div>
</div>



</div>

</body>
</html>